<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>HRMS Dashboard — v3</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --sidebar-width: 260px;
        }

        body {
            background: #f4f7fb;
            font-family: system-ui, Segoe UI, Roboto, "Helvetica Neue", Arial;
        }

        .app {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: #0d6efd;
            color: white;
            padding: 1rem;
            position: relative;
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.95);
        }

        .sidebar .nav-link.active {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 6px;
        }

        .content {
            flex: 1;
            padding: 1.25rem;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .card-kpi {
            border-radius: .6rem;
        }

        .profile-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #fff2;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }

        .small-muted {
            color: #6b7280;
            font-size: .9rem;
        }

        .table-actions .btn {
            margin-right: 6px;
        }

        .sidebar-footer {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            right: 1rem;
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .file-input {
            font-size: .9rem;
        }

        .chart-card {
            height: 280px;
        }

        .sidebar-profile {
            display: flex;
            gap: .6rem;
            align-items: center;
        }

        .sidebar-footer-right {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: .5rem;
        }
    </style>
</head>

<body>
    <div class="app">

        <!-- SIDEBAR -->
        <div class="sidebar d-flex flex-column position-relative">
            <div class="mb-4 d-flex align-items-center gap-2">
                <i class="bi bi-people-fill fs-3"></i>
                <div>
                    <div class="fw-bold">HRMS</div>
                    <div class="small-muted">Admin Panel</div>
                </div>
            </div>

            <div class="sidebar-profile mb-3">
                <div id="avatar" class="profile-avatar">G</div>
                <div>
                    <div id="displayName">Guest</div>
                    <div id="displayRole" class="small-muted">Not logged</div>
                </div>
            </div>

            <nav class="nav flex-column" id="mainNav">
                <a class="nav-link active" href="#" data-page="dashboard" onclick="navigate(event)"> <i
                        class="bi bi-speedometer2 me-2"></i> Dashboard</a>
                <a id="navEmployees" class="nav-link" href="#" data-page="employees" onclick="navigate(event)"><i
                        class="bi bi-people me-2"></i> Employees</a>
                <a id="navAttendance" class="nav-link" href="#" data-page="attendance" onclick="navigate(event)"><i
                        class="bi bi-calendar-check me-2"></i> Attendance</a>
                <a id="navTimesheets" class="nav-link" href="#" data-page="timesheets" onclick="navigate(event)"><i
                        class="bi bi-journal-check me-2"></i> Timesheets</a>
                <a id="navLeaves" class="nav-link" href="#" data-page="leaves" onclick="navigate(event)"><i
                        class="bi bi-card-checklist me-2"></i> Leaves</a>
                <a id="navPayroll" class="nav-link" href="#" data-page="payroll" onclick="navigate(event)"><i
                        class="bi bi-currency-dollar me-2"></i> Payroll</a>
                <a id="navSalary" class="nav-link" href="#" data-page="salary" onclick="navigate(event)"><i
                    class="bi bi-wallet2 me-2"></i> Salary</a>
                <a id="navUploads" class="nav-link" href="#" data-page="uploads" onclick="navigate(event)"><i
                        class="bi bi-cloud-arrow-up me-2"></i> Uploads</a>
                <a id="navMasters" class="nav-link" href="#" data-page="masters" onclick="navigate(event)"><i
                        class="bi bi-columns-gap me-2"></i> Masters</a>
            </nav>

            <div class="sidebar-footer mt-auto">
                <div class="sidebar-footer-right">
                    <div class="small-muted"> </div>
                    <div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="content">
            <div class="topbar">
                <div>
                    <h4 id="pageTitle">Dashboard</h4>
                    <div class="small-muted" id="topDate"></div>
                </div>
                <div>
                    <button class="btn btn-outline-secondary btn-sm me-2" onclick="refreshCurrentPage()">Refresh</button>
                    <button id="btnProfile" class="btn btn-outline-primary btn-sm" onclick="openProfile()" style="display:none"><i class="bi bi-person"></i> Profile</button>
                    <button id="btnOpenLogin" class="btn btn-sm btn-light" onclick="openLogin()">Login</button>
                    <button id="btnLogout" class="btn btn-sm btn-danger ms-2" onclick="logout()" style="display:none">Logout</button>
                </div>
            </div>

            <!-- DASHBOARD -->
            <div id="dashboard" class="page active">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="card card-kpi p-3">
                            <h6>Total Employees</h6>
                            <div class="h3" id="kpiEmployees">—</div>
                        </div>
                        <div class="card p-3 mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">Announcements</h6>
                                <small class="small-muted">Active</small>
                            </div>
                            <div id="announcementsFeed" class="small-muted">Loading announcements...</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-kpi p-3">
                            <h6>Active This Month</h6>
                            <div class="h3" id="kpiActive">—</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-kpi p-3">
                            <h6>Pending Leaves</h6>
                            <div class="h3" id="kpiPendingLeaves">—</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-kpi p-3">
                            <h6>Payroll Runs</h6>
                            <div class="h3" id="kpiPayrollRuns">—</div>
                        </div>
                    </div>

                    <div class="col-lg-8">
                        <div class="card p-3">
                            <h6>Attendance - Monthly Trend</h6>
                            <canvas id="chartAttendance" class="chart-card"></canvas>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="card p-3">
                            <h6>Leaves - Distribution</h6>
                            <canvas id="chartLeaves" class="chart-card"></canvas>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="card p-3">
                            <h6>Payroll Overview (Last 6)</h6>
                            <canvas id="chartPayroll" class="chart-card"></canvas>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="card p-3">
                            <h6>Today's Attendance</h6>
                            <div id="todayAttendanceStatus" class="mb-2 small-muted">Loading...</div>
                            <div id="attendanceActions" class="d-flex gap-2">
                                <button id="btnCheckIn" class="btn btn-success btn-sm" onclick="doCheckIn()">Check In</button>
                                <button id="btnCheckOut" class="btn btn-outline-danger btn-sm" onclick="doCheckOut()">Check Out</button>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="card p-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">Upcoming Birthdays</h6>
                                <small class="small-muted">next 7 days</small>
                            </div>
                            <div id="dashboardBirthdays"></div>
                        </div>

                        <!-- Birthday wishes modal -->
                        <div class="modal fade" id="birthdayWishesModal" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header"><h5 class="modal-title">Birthday Wishes</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                                    <div class="modal-body" id="birthdayWishesBody">Loading...</div>
                                    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-3 mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">Create Announcement</h6>
                                <small class="small-muted">HR / Admin</small>
                            </div>
                                <div id="miniAnnWrap">
                                <form id="miniAnnForm" onsubmit="onMiniAnn(event)">
                                <div class="mb-2"><input id="miniAnnTitle" class="form-control" placeholder="Title"
                                        required></div>
                                <div class="mb-2"><textarea id="miniAnnBody" class="form-control" placeholder="Body"
                                        rows="2" required></textarea></div>
                                <div class="d-flex gap-2">
                                    <input id="miniAnnStart" type="date" class="form-control" required>
                                    <input id="miniAnnEnd" type="date" class="form-control" required>
                                    <button class="btn btn-primary">Publish</button>
                                </div>
                                </form>
                                </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- EMPLOYEES -->
            <div id="employees" class="page">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Employees</h5>
                    <div>
                        <button id="btnAddEmployee" class="btn btn-primary btn-sm"
                            onclick="openAddEmployeeModal()">Add</button>
                        <button id="btnExportEmployees" class="btn btn-outline-success btn-sm"
                            onclick="exportEmployees()">Export Excel</button>
                        <button id="btnSendSetupBulk" class="btn btn-outline-primary btn-sm"
                            onclick="promptSendSetup()">Send Setup</button>
                        <button id="btnAdminSetPassword" class="btn btn-warning btn-sm"
                            onclick="openAdminSetPasswordModal()">Set Password</button>
                    </div>
                </div>
                <div class="card p-3">
                    <div class="mb-2"><input id="employeeSearch" class="form-control"
                            placeholder="Search employees (name, email, empno)" oninput="filterEmployees()" /></div>
                    <div class="table-responsive">
                        <table class="table table-striped" id="tblEmployees">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>EmpNo</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Dept</th>
                                    <th>Desig</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ATTENDANCE -->
            <div id="attendance" class="page">
                <h5>Attendance</h5>
                <div class="row g-2 mb-3">
                    <div class="col-md-3"><input id="attFrom" type="date" class="form-control" /></div>
                    <div class="col-md-3"><input id="attTo" type="date" class="form-control" /></div>
                    <div class="col-md-3"><input id="attEmployee" class="form-control" placeholder="Employee id" />
                    </div>
                    <div class="col-md-3"><button class="btn btn-primary"
                            onclick="fetchAttendanceReport()">Fetch</button></div>
                </div>
                <div class="card p-3">
                    <div class="table-responsive">
                        <table class="table" id="tblAttendance">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>EmpNo</th>
                                    <th>Name</th>
                                    <th>Date</th>
                                    <th>In</th>
                                    <th>Out</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TIMESHEETS -->
            <div id="timesheets" class="page">
                <div class="d-flex justify-content-between mb-3">
                    <h5>Timesheets</h5>
                    <div><button class="btn btn-primary btn-sm" onclick="openTimesheetModal()">Submit Timesheet</button>
                    </div>
                </div>
                <div class="card p-3">
                    <div id="timesheetList"></div>
                </div>
            </div>

            <!-- LEAVES -->
            <div id="leaves" class="page">
                <div class="d-flex justify-content-between mb-3">
                    <h5>Leaves</h5>
                    <div><button class="btn btn-primary btn-sm" onclick="openLeaveModal()">Request Leave</button></div>
                </div>
                <div class="card p-3">
                    <div id="leaveList"></div>
                </div>
            </div>

            <!-- PAYROLL -->
            <div id="payroll" class="page">
                <div class="d-flex justify-content-between mb-3">
                    <h5>Payroll</h5>
                    <div>
                        <button class="btn btn-success btn-sm" onclick="generatePayroll()">Generate Payroll</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="exportPayroll()">Export
                            Payroll</button>
                    </div>
                </div>
                <div class="card p-3">
                    <div id="payrollList"></div>
                </div>
            </div>

            <!-- UPLOADS -->
            <!-- SALARY MANAGEMENT -->
            <div id="salary" class="page">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Salary Management</h5>
                    <div>
                        <small class="small-muted">Admin / HR only</small>
                    </div>
                </div>
                <div class="card p-3">
                    <div class="mb-2"><input id="salarySearch" class="form-control" placeholder="Search employees" oninput="filterSalaryEmployees()" /></div>
                    <div class="table-responsive">
                        <table class="table table-striped" id="tblSalaryEmployees">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>EmpNo</th>
                                    <th>Name</th>
                                    <th>LPA</th>
                                    <th>Basic (mon)</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="uploads" class="page">
                <h5>Bulk Uploads (Admin)</h5>
                <div class="card p-3">
                    <div class="mb-3"><label>Employees (Excel)</label><input id="uploadEmployeesFile" type="file"
                            class="form-control file-input"></div>
                    <div class="mb-2"><button class="btn btn-primary btn-sm" onclick="uploadEmployees()">Upload
                            Employees</button></div>

                    <div class="mb-3"><label>Holidays (Excel)</label><input id="uploadHolidaysFile" type="file"
                            class="form-control file-input"></div>
                    <div class="mb-2"><button class="btn btn-primary btn-sm" onclick="uploadHolidays()">Upload
                            Holidays</button></div>

                    <div class="mb-3"><label>Payroll (Excel)</label><input id="uploadPayrollFile" type="file"
                            class="form-control file-input"></div>
                    <div class="mb-2"><button class="btn btn-primary btn-sm" onclick="uploadPayroll()">Upload
                            Payroll</button></div>

                    <div id="uploadResult" class="mt-2"></div>
                </div>
            </div>

            <!-- MASTERS -->
            <div id="masters" class="page">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Masters</h5>
                    <div>
                        <button id="btnAddMaster" class="btn btn-primary btn-sm" onclick="openAddMasterModal()" style="display:none">Add</button>
                    </div>
                </div>

                <div class="card p-3">
                    <ul class="nav nav-tabs masters-tabs" id="mastersTabs"></ul>
                    <div class="tab-content mt-3" id="mastersTabContent"></div>
                </div>
            </div>

            <!-- ACCESS DENIED -->
            <div id="accessDenied" class="page">
                <div class="card p-4 text-center"><i class="bi bi-shield-exclamation fs-1 text-danger"></i>
                    <h4 class="mt-3">Access Denied</h4>
                    <p class="small-muted">You don't have permission to view this page.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <!-- login, reset, admin-set-password, add employee, timesheet, leave, mini announcement, recalc payslip -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <form id="loginModalForm" class="modal-content" onsubmit="onLoginSubmit(event)">
                <div class="modal-header">
                    <h5 class="modal-title">Sign in</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="loginAlert"></div>
                    <div class="mb-2"><label class="form-label">Username</label><input id="loginUsername"
                            class="form-control" required></div>
                    <div class="mb-2"><label class="form-label">Password</label><input id="loginPassword"
                            type="password" class="form-control" required></div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary">Login</button></div>
            </form>
        </div>
    </div>

    <!-- PROFILE MODAL -->
    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog">
            <form id="profileForm" class="modal-content" onsubmit="onProfileSave(event)">
                <div class="modal-header">
                    <h5 class="modal-title">My Profile</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="profileAlert"></div>
                    <div class="mb-2"><label>Full Name</label><input id="profileFullName" class="form-control" disabled></div>
                    <div class="mb-2"><label>Work Email</label><input id="profileWorkEmail" class="form-control" disabled></div>
                    <div class="mb-2"><label>Personal Email</label><input id="profilePersonalEmail" class="form-control" name="personal_email"></div>
                    <div class="mb-2"><label>Date of Birth</label><input id="profileDOB" type="date" class="form-control" name="date_of_birth"></div>
                    <div class="mb-2"><label>Location</label><input id="profileLocation" class="form-control" disabled></div>
                    <div class="mb-2"><label>Department</label><input id="profileDepartment" class="form-control" disabled></div>
                    <div class="mb-2"><label>Designation</label><input id="profileDesignation" class="form-control" disabled></div>
                    <div class="mb-2"><label>Physically Handicapped</label><select id="profilePH" class="form-control" name="physically_handicapped"><option value="0">No</option><option value="1">Yes</option></select></div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary">Save</button></div>
            </form>
        </div>
    </div>

    <div class="modal fade" id="adminSetPasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <form id="adminSetPasswordForm" class="modal-content" onsubmit="onAdminSetPassword(event)">
                <div class="modal-header">
                    <h5 class="modal-title">Set Employee Password (Admin)</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="adminSetPwdAlert"></div>
                    <div class="mb-2"><label class="form-label">Employee ID</label><input id="adminPwdEmpId"
                            class="form-control" required /></div>
                    <div class="mb-2"><label class="form-label">New Password</label><input id="adminPwd" type="password"
                            class="form-control" required /></div>
                    <div class="mb-2"><label class="form-label">Confirm Password</label><input id="adminPwdConfirm"
                            type="password" class="form-control" required /></div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary">Set Password</button></div>
            </form>
        </div>
    </div>

    <div class="modal fade" id="addEmployeeModal" tabindex="-1">
        <div class="modal-dialog">
            <form id="addEmployeeForm" class="modal-content" onsubmit="onAddEmployee(event)">
                <div class="modal-header">
                    <h5 class="modal-title">Add Employee</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2"><input id="addEmpNo" class="form-control" placeholder="EmployeeNumber"></div>
                    <div class="mb-2"><input id="addFullName" class="form-control" placeholder="FullName"></div>
                    <div class="mb-2"><input id="addEmail" class="form-control" placeholder="WorkEmail"></div>
                    <div class="mb-2"><input id="addDept" class="form-control" placeholder="Department"></div>
                    <div class="mb-2"><input id="addDesig" class="form-control" placeholder="Designation"></div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary">Save</button></div>
            </form>
        </div>
    </div>

    <div class="modal fade" id="timesheetModal" tabindex="-1">
        <div class="modal-dialog">
            <form id="timesheetForm" class="modal-content" onsubmit="onTimesheetSubmit(event)">
                <div class="modal-header">
                    <h5 class="modal-title">Submit Timesheet</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2"><label>Project ID</label><input id="tsProject" class="form-control" required>
                    </div>
                    <div class="mb-2"><label>Hours</label><input id="tsHours" type="number" step="0.25"
                            class="form-control" required></div>
                    <div class="mb-2"><label>Date</label><input id="tsDate" type="date" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary">Submit</button></div>
            </form>
        </div>
    </div>

    <div class="modal fade" id="leaveModal" tabindex="-1">
        <div class="modal-dialog">
            <form id="leaveForm" class="modal-content" onsubmit="onLeaveSubmit(event)">
                <div class="modal-header">
                    <h5 class="modal-title">Request Leave</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2"><label>Type</label><select id="leaveType" class="form-control">
                            <option>Casual</option>
                            <option>Sick</option>
                            <option>Earned</option>
                            <option>Unpaid</option>
                        </select></div>
                    <div class="mb-2"><label>From</label><input id="leaveFrom" type="date" class="form-control"
                            required></div>
                    <div class="mb-2"><label>To</label><input id="leaveTo" type="date" class="form-control" required>
                    </div>
                    <div class="mb-2"><label>Reason</label><textarea id="leaveReason" class="form-control"></textarea>
                    </div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary">Request</button></div>
            </form>
        </div>
    </div>

    <div class="modal fade" id="recalcModal" tabindex="-1">
        <div class="modal-dialog">
            <form id="recalcForm" class="modal-content" onsubmit="onRecalcSubmit(event)">
                <div class="modal-header">
                    <h5 class="modal-title">Recalculate Payslip</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="recalcDetails" class="mb-3 small-muted">Loading payslip details...</div>
                    <div class="mb-2"><label>Employee ID</label><input id="recalcEmpId" class="form-control" required>
                    </div>
                    <div class="mb-2"><label>New Net Pay</label><input id="recalcNet" type="number" class="form-control"
                            required></div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary">Recalculate</button></div>
            </form>
        </div>
    </div>

    <!-- PAYSLIP VIEW MODAL -->
    <div class="modal fade" id="payslipModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Payslip</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="payslipModalBody">
                    Loading...
                </div>
                <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button> <button class="btn btn-primary" onclick="downloadPayslipPdf()">Download PDF</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addMasterModal" tabindex="-1">
        <div class="modal-dialog">
            <form id="addMasterForm" class="modal-content" onsubmit="onAddMasterSubmit(event)">
                <div class="modal-header">
                    <h5 class="modal-title" id="addMasterTitle">Add Master</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="addMasterBody"></div>
                <div class="modal-footer"><button class="btn btn-primary">Save</button></div>
            </form>
        </div>
    </div>

        <!-- SALARY MODAL -->
        <div class="modal fade" id="salaryModal" tabindex="-1">
            <div class="modal-dialog">
                <form id="salaryForm" class="modal-content" onsubmit="onSaveSalaryStructure(event)">
                    <div class="modal-header">
                        <h5 class="modal-title">Manage Salary</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="salaryAlert"></div>
                        <input type="hidden" id="salaryEmpId">
                        <div class="mb-2"><label>LPA (Annual in lakhs)</label><input id="salaryLPA" class="form-control" type="number" step="0.01"></div>
                        <div class="mb-2"><label>Basic % of Gross</label><input id="salaryBasicPct" class="form-control" type="number" step="0.1" value="40"></div>
                        <div class="mb-2"><label>HRA % (of Basic)</label><input id="salaryHRAPct" class="form-control" type="number" step="0.1" value="40"></div>
                        <div class="mb-2"><label>Medical Allowance (monthly)</label><input id="salaryMedical" class="form-control" type="number" step="0.01"></div>
                        <div class="mb-2"><label>Transport Allowance (monthly)</label><input id="salaryTransport" class="form-control" type="number" step="0.01"></div>
                        <div class="mb-2"><label>Special Allowance (monthly)</label><input id="salarySpecial" class="form-control" type="number" step="0.01"></div>
                        <div class="mb-2"><label>Paid Basic (monthly) — computed</label><input id="salaryPaidBasic" class="form-control" type="number" step="0.01" readonly></div>
                        <div class="mb-2"><label>Working Days (for preview)</label><input id="salaryWorkingDays" class="form-control" type="number" value="30"></div>
                        <div class="mb-2"><label>Loss Of Days (for preview)</label><input id="salaryLossDays" class="form-control" type="number" value="0"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="previewSalaryPayslip()">Preview Payslip</button>
                        <button class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>

        <script>
        const API_BASE = '';
        const ENDPOINT = {
            login: API_BASE + '/api/login',
            sendSetup: API_BASE + '/api/auth/password/setup/send',
            adminCreatePassword: API_BASE + '/api/auth/password/create',
            attendanceReport: API_BASE + '/api/attendance-report',
            timesheets: API_BASE + '/api/timesheets',
            leaves: API_BASE + '/api/leaves',
            announcements: API_BASE + '/api/announcements',
            birthdays: API_BASE + '/api/birthdays',
            birthdayWishes: API_BASE + '/api/birthday-wishes',
            employees: API_BASE + '/api/employees',
            uploadEmployees: API_BASE + '/api/upload/employees',
            uploadHolidays: API_BASE + '/api/upload/holidays',
            uploadPayroll: API_BASE + '/api/upload/payroll',
            masters: {
                locations: API_BASE + '/api/locations',
                departments: API_BASE + '/api/departments',
                designations: API_BASE + '/api/designations',
                businessUnits: API_BASE + '/api/business-units',
                legalEntities: API_BASE + '/api/legal-entities',
                costCenters: API_BASE + '/api/cost-centers'
            },
            payrollGenerate: API_BASE + '/api/payroll/generate',
            payslipsList: API_BASE + '/api/payslips',
            payrollRecalculate: API_BASE + '/api/payroll/recalculate' // append /:empId
        };

        const MASTER_CONFIG = [
            { key: 'locations', title: 'Locations', endpoint: '/api/locations' },
            { key: 'departments', title: 'Departments', endpoint: '/api/departments' },
            { key: 'designations', title: 'Designations', endpoint: '/api/designations' },
            { key: 'businessUnits', title: 'Business Units', endpoint: '/api/business-units' },
            { key: 'legalEntities', title: 'Legal Entities', endpoint: '/api/legal-entities' },
            { key: 'costCenters', title: 'Cost Centers', endpoint: '/api/cost-centers' },
            { key: 'holidays', title: 'Holidays', endpoint: '/api/holidays' }
        ];

        let authToken = localStorage.getItem('hr_token') || null;
        let currentUser = JSON.parse(localStorage.getItem('hr_user') || 'null');
        let caches = { employees: [], announcements: [], birthdays: [], leaves: [], payslips: [] };

        axios.defaults.headers.common['Accept'] = 'application/json';
        axios.interceptors.request.use(cfg => {
            const token = localStorage.getItem('hr_token');
            if (token) cfg.headers['Authorization'] = 'Bearer ' + token;
            return cfg;
        });

        function setUserUI() {
            document.getElementById('displayName').innerText = currentUser ? (currentUser.username || currentUser.full_name || currentUser.name) : 'Guest';
            document.getElementById('displayRole').innerText = currentUser ? (currentUser.role || '').toUpperCase() : 'Not logged';
            document.getElementById('avatar').innerText = currentUser ? (currentUser.username || 'U').charAt(0).toUpperCase() : 'G';
            document.getElementById('btnOpenLogin').style.display = currentUser ? 'none' : '';
            document.getElementById('btnLogout').style.display = currentUser ? '' : 'none';
            document.getElementById('btnProfile').style.display = currentUser ? '' : 'none';
            const role = currentUser ? currentUser.role : null;
            const show = id => { const el = document.getElementById(id); if (el) el.style.display = ''; };
            const hide = id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; };
            ['navEmployees', 'navAttendance', 'navUploads', 'navMasters', 'navTimesheets', 'navLeaves', 'navPayroll', 'navSalary'].forEach(hide);
            if (currentUser) { show('navTimesheets'); show('navLeaves'); /* show payroll only for non-employee roles */ if (currentUser.role !== 'employee') show('navPayroll'); }
            if (role === 'admin' || role === 'hr') { ['navEmployees', 'navAttendance', 'navUploads', 'navMasters', 'navPayroll', 'navSalary'].forEach(show); }
            if (role === 'manager') { ['navEmployees', 'navAttendance', 'navTimesheets', 'navLeaves', 'navPayroll'].forEach(show); }
            if (role === 'employee') { ['navTimesheets', 'navLeaves'].forEach(show); }
            // show add master button only for admin/hr
            const addMasterBtn = document.getElementById('btnAddMaster'); if (addMasterBtn) addMasterBtn.style.display = (currentUser && (currentUser.role === 'admin' || currentUser.role === 'hr')) ? '' : 'none';
            // show mini announcement only for admin/hr
            const miniWrap = document.getElementById('miniAnnWrap'); if (miniWrap) miniWrap.style.display = (currentUser && (currentUser.role === 'admin' || currentUser.role === 'hr')) ? '' : 'none';
        }
        setUserUI();

        function navigate(evt) { evt.preventDefault(); const page = evt.currentTarget.getAttribute('data-page'); routeTo(page); }
        function routeTo(page) {
            const role = currentUser ? currentUser.role : null;
            const perms = { dashboard: [null, 'admin', 'hr', 'manager', 'employee'], employees: ['admin', 'hr', 'manager'], attendance: ['admin', 'hr', 'manager'], timesheets: ['admin', 'hr', 'manager', 'employee'], leaves: ['admin', 'hr', 'manager', 'employee'], payroll: ['admin', 'hr', 'manager', 'employee'], uploads: ['admin', 'hr'], masters: ['admin', 'hr'], salary: ['admin','hr'] };
            if (!(perms[page] && perms[page].includes(role))) { showPage('accessDenied'); return; }
            showPage(page); document.getElementById('pageTitle').innerText = page.charAt(0).toUpperCase() + page.slice(1);
            switch (page) { case 'dashboard': loadDashboard(); break; case 'employees': loadEmployees(); break; case 'attendance': break; case 'timesheets': loadTimesheets(); break; case 'leaves': loadLeaves(); break; case 'payroll': loadPayroll(); break; case 'uploads': break; case 'masters': initMasters(); break; case 'salary': /* nothing extra */ break; }
        }
        function showPage(id) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); const el = document.getElementById(id); if (el) el.classList.add('active'); }

        /* AUTH */
        function openLogin() { new bootstrap.Modal(document.getElementById('loginModal')).show(); }
        async function onLoginSubmit(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim(); const password = document.getElementById('loginPassword').value;
            try {
                const r = await axios.post(ENDPOINT.login, { username, password }); const data = r.data; const token = data.token || data.accessToken || null; let user = data.user || null; if (!user && data.role) { user = { id: data.userId || data.id || null, username, role: data.role }; } if (!token) { Swal.fire('Login failed', 'No token returned', 'error'); return; }
                authToken = token; localStorage.setItem('hr_token', token); if (user) { currentUser = user; localStorage.setItem('hr_user', JSON.stringify(user)); } setUserUI(); bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide(); Swal.fire('Success', 'Logged in', 'success'); await postLoginInit();
            } catch (err) { const msg = err.response && err.response.data && (err.response.data.error || err.response.data.message) ? (err.response.data.error || err.response.data.message) : err.message; Swal.fire('Login failed', msg, 'error'); }
        }
        document.getElementById('loginModalForm').addEventListener('submit', onLoginSubmit);

        async function onMiniAnn(e) {
            e.preventDefault();
            if (!currentUser || !(currentUser.role === 'admin' || currentUser.role === 'hr')) return Swal.fire('Access Denied', 'Only HR/Admin can publish', 'error');
            const title = document.getElementById('miniAnnTitle').value; const body = document.getElementById('miniAnnBody').value; const starts_at = document.getElementById('miniAnnStart').value + 'T00:00:00Z'; const ends_at = document.getElementById('miniAnnEnd').value + 'T23:59:59Z';
            try { await axios.post(ENDPOINT.announcements, { title, body, starts_at, ends_at }); Swal.fire('Published', 'Announcement created', 'success'); document.getElementById('miniAnnForm').reset(); await loadAnnouncements(); } catch (e) { Swal.fire('Error', 'Failed to create announcement', 'error'); console.error(e); }
        }

        /* ADMIN SET PASSWORD */
        function openAdminSetPasswordModal() { if (currentUser?.role !== 'admin') return Swal.fire('Access Denied', 'Only admin can set passwords', 'error'); new bootstrap.Modal(document.getElementById('adminSetPasswordModal')).show(); }
        async function onAdminSetPassword(e) { e.preventDefault(); const empId = document.getElementById('adminPwdEmpId').value.trim(); const pwd = document.getElementById('adminPwd').value.trim(); const confirm = document.getElementById('adminPwdConfirm').value.trim(); const alertBox = document.getElementById('adminSetPwdAlert'); alertBox.innerHTML = ''; if (!empId) { alertBox.innerHTML = '<div class="alert alert-danger">Employee ID required.</div>'; return; } if (pwd !== confirm) { alertBox.innerHTML = '<div class="alert alert-danger">Passwords do not match.</div>'; return; } try { await axios.post(ENDPOINT.adminCreatePassword, { employee_id: empId, password: pwd }); Swal.fire('Success', 'Password set', 'success'); bootstrap.Modal.getInstance(document.getElementById('adminSetPasswordModal')).hide(); } catch (err) { const m = err.response && err.response.data && (err.response.data.error || err.response.data.message) ? (err.response.data.error || err.response.data.message) : err.message; alertBox.innerHTML = '<div class="alert alert-danger">' + m + '</div>'; } }
        document.getElementById('adminSetPasswordForm').addEventListener('submit', onAdminSetPassword);

        /* LOGOUT */
        function logout() { axios.post(API_BASE + '/api/auth/logout').catch(() => { }); authToken = null; currentUser = null; localStorage.removeItem('hr_token'); localStorage.removeItem('hr_user'); delete axios.defaults.headers.common['Authorization']; setUserUI(); showPage('dashboard'); Swal.fire({ icon: 'success', title: 'Logged out', timer: 900, showConfirmButton: false }); }

        /* POST LOGIN */
        async function postLoginInit() { try { await Promise.all([loadAnnouncements(), loadBirthdays(), loadEmployees(), initMasters(), loadPayroll()]); setTimeout(loadDashboard, 250); } catch (e) { console.warn(e); } }

        /* DASHBOARD & CHARTS */
        let chartAttendance = null, chartLeaves = null, chartPayroll = null;
        async function loadDashboard() {
            document.getElementById('kpiEmployees').innerText = caches.employees.length || '—';
            try { const r = await axios.get(ENDPOINT.leaves); caches.leaves = r.data || []; document.getElementById('kpiPendingLeaves').innerText = caches.leaves.filter(l => l.status === 'Pending').length; } catch (e) { document.getElementById('kpiPendingLeaves').innerText = '—'; }
            try {
                const from = new Date(); from.setMonth(from.getMonth() - 5);
                const params = new URLSearchParams({ start_date: from.toISOString().slice(0, 10), end_date: new Date().toISOString().slice(0, 10) });
                const r = await axios.get(ENDPOINT.attendanceReport + '?' + params.toString());
                const rows = r.data || [];
                const buckets = {};
                for (let i = 5; i >= 0; i--) { const d = new Date(); d.setMonth(d.getMonth() - i); buckets[d.toISOString().slice(0, 7)] = 0; }
                rows.forEach(row => { const k = (row.punch_date || '').slice(0, 7); if (k && buckets.hasOwnProperty(k)) buckets[k]++; });
                const labels = Object.keys(buckets); const values = labels.map(l => buckets[l]); renderAttendanceChart(labels, values);
            } catch (e) { renderAttendanceChart([], []); }
            try { const r = await axios.get(ENDPOINT.leaves); const types = {}; (r.data || []).forEach(x => types[x.leave_type] = (types[x.leave_type] || 0) + 1); renderLeavesChart(Object.keys(types), Object.values(types)); } catch (e) { renderLeavesChart([], []); }
            try { const r = await axios.get(ENDPOINT.payslipsList); const slips = r.data || []; const map = {}; slips.forEach(s => { const k = s.payroll_run_id || s.payroll_run_id || 'run'; map[k] = (map[k] || 0) + (s.net_pay || s.net_salary || 0); }); const keys = Object.keys(map).slice(-6); renderPayrollChart(keys, keys.map(k => map[k])); document.getElementById('kpiPayrollRuns').innerText = Object.keys(map).length; } catch (e) { renderPayrollChart([], []); document.getElementById('kpiPayrollRuns').innerText = '—'; }
            try {
                const r = await axios.get(ENDPOINT.birthdays + '?days=7');
                caches.birthdays = r.data || [];
                document.getElementById('dashboardBirthdays').innerHTML = caches.birthdays.map(b => `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div><b>${b.FullName}</b><div class="small-muted">${b.next_birthday} — in ${b.days_until} days</div></div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="openWishModal(${b.id}, '${b.FullName.replace(/'/g, "\\'")}')">Wish</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="openViewWishes(${b.id}, '${b.FullName.replace(/'/g, "\\'")}')">View</button>
                        </div>
                    </div>
                `).join('') || '<div class="small-muted">No birthdays</div>';
            } catch (e) { document.getElementById('dashboardBirthdays').innerHTML = '<div class="small-muted">Unable to load birthdays</div>'; }
            try {
                const r = await axios.get(ENDPOINT.announcements);
                caches.announcements = r.data || [];
                const feed = document.getElementById('announcementsFeed');
                if (feed) {
                    feed.innerHTML = (caches.announcements || []).map(a => `<div class="mb-2"><div><b>${a.title || 'Untitled'}</b> <span class="small-muted">${(a.starts_at||'').slice(0,10)}</span></div><div>${(a.body||'').replace(/\n/g,'<br>')}</div></div>`).join('') || '<div class="small-muted">No active announcements</div>';
                }
            } catch (e) { const feed = document.getElementById('announcementsFeed'); if (feed) feed.innerHTML = '<div class="small-muted">Unable to load announcements</div>'; }
            // refresh today's attendance status
            try { await loadTodayAttendanceStatus(); } catch (e) { }
        }

        function renderAttendanceChart(labels, data) { const ctx = document.getElementById('chartAttendance').getContext('2d'); if (chartAttendance) chartAttendance.destroy(); chartAttendance = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: 'Attendance count', data, fill: true, tension: 0.3 }] }, options: { responsive: true, plugins: { legend: { display: false } } } }); }
        function renderLeavesChart(labels, data) { const ctx = document.getElementById('chartLeaves').getContext('2d'); if (chartLeaves) chartLeaves.destroy(); chartLeaves = new Chart(ctx, { type: 'pie', data: { labels, datasets: [{ data }] }, options: { responsive: true } }); }
        function renderPayrollChart(labels, data) { const ctx = document.getElementById('chartPayroll').getContext('2d'); if (chartPayroll) chartPayroll.destroy(); chartPayroll = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Total Net Pay', data }] }, options: { responsive: true } }); }

        /* EMPLOYEES */
        async function loadEmployees() { try { const r = await axios.get(ENDPOINT.employees); caches.employees = r.data || []; renderEmployeesTable(); renderSalaryEmployees(); } catch (e) { caches.employees = []; renderEmployeesTable(); renderSalaryEmployees(); } }
        function renderEmployeesTable() {
            const tbody = document.querySelector('#tblEmployees tbody');
            tbody.innerHTML = '';
            caches.employees.forEach((e, i) => {
                const lpa = e.lpa || '';
                const paidBasic = e.paid_basic_monthly || e.paidBasic || e.basic_monthly || '';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${i + 1}</td><td>${e.EmployeeNumber || ''}</td><td>${e.FullName || ''}</td><td>${e.WorkEmail || ''}</td><td>${e.Department || ''}</td><td>${e.Designation || ''}</td><td>${lpa}</td><td>${paidBasic}</td><td class="table-actions">` +
                    // `<button class="btn btn-sm btn-outline-primary" onclick="promptSendSetup(${e.id})">Send Setup</button>` +
                    // `<button class="btn btn-sm btn-warning" onclick="openAdminSetPasswordRow(${e.id})">Set Password</button>` +
                    // `<button class="btn btn-sm btn-secondary" onclick="openSalaryManage(${e.id})">Manage Salary</button>` +
                    // `<button class="btn btn-sm btn-info" onclick="generatePayslip(${e.id})">Generate Payslip</button>` +
                    `</td>`;
                tbody.appendChild(tr);
            });
        }

        function renderSalaryEmployees() {
            const tbody = document.querySelector('#tblSalaryEmployees tbody');
            tbody.innerHTML = '';
            caches.employees.forEach((e, i) => {
                const lpa = e.lpa || '';
                const basic = e.paid_basic_monthly || e.basic_monthly || '';
                const hra = e.hra_pct || '';
                const med = e.medical_allowance || '';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${i + 1}</td><td>${e.EmployeeNumber || ''}</td><td>${e.FullName || ''}</td><td>${lpa}</td><td>${basic}</td><td>${hra}</td><td>${med}</td><td class="table-actions"><button class="btn btn-sm btn-primary" onclick="openSalaryManage(${e.id})">Manage</button> <button class="btn btn-sm btn-info" onclick="generatePayslip(${e.id})">Payslip</button></td>`;
                tbody.appendChild(tr);
            });
        }

        function filterSalaryEmployees() { const q = document.getElementById('salarySearch').value.toLowerCase(); document.querySelectorAll('#tblSalaryEmployees tbody tr').forEach(tr => { tr.style.display = tr.innerText.toLowerCase().includes(q) ? '' : 'none'; }); }
        function filterEmployees() { const q = document.getElementById('employeeSearch').value.toLowerCase(); document.querySelectorAll('#tblEmployees tbody tr').forEach(tr => { tr.style.display = tr.innerText.toLowerCase().includes(q) ? '' : 'none'; }); }
        function openAddEmployeeModal() { new bootstrap.Modal(document.getElementById('addEmployeeModal')).show(); }
        async function onAddEmployee(e) { e.preventDefault(); const emp = { EmployeeNumber: document.getElementById('addEmpNo').value, FullName: document.getElementById('addFullName').value, WorkEmail: document.getElementById('addEmail').value, Department: document.getElementById('addDept').value, Designation: document.getElementById('addDesig').value }; try { await axios.post(ENDPOINT.employees, emp); Swal.fire('Added', 'Employee added', 'success'); bootstrap.Modal.getInstance(document.getElementById('addEmployeeModal')).hide(); await loadEmployees(); } catch (err) { Swal.fire('Error', 'Failed to add employee', 'error'); } }
        document.getElementById('addEmployeeForm').addEventListener('submit', onAddEmployee);
        function openAdminSetPasswordRow(empId) { document.getElementById('adminPwdEmpId').value = empId; openAdminSetPasswordModal(); }
        async function promptSendSetup(empId) { if (!empId) { Swal.fire('Error', 'Employee id required', 'error'); return; } try { const r = await axios.post(ENDPOINT.sendSetup + '/' + empId); Swal.fire('Sent', 'Mock token: <pre style="text-align:left">' + (r.data.token || '') + '</pre>', 'info'); } catch (e) { Swal.fire('Error', 'Failed to send setup', 'error'); } }
        function exportEmployees() { const data = caches.employees.map(e => ({ EmployeeNumber: e.EmployeeNumber, FullName: e.FullName, WorkEmail: e.WorkEmail, Department: e.Department, Designation: e.Designation })); const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Employees'); XLSX.writeFile(wb, 'employees.xlsx'); }

        /* SALARY MANAGEMENT HELPERS */
        function computeSalaryFromLPA(lpa, basicPct, hraPct, medical, transport, special) {
            // lpa in lakhs per annum
            const annual = Number(lpa || 0) * 100000;
            const monthlyGross = annual / 12;
            const basic = monthlyGross * (Number(basicPct || 0) / 100);
            const hra = basic * (Number(hraPct || 0) / 100);
            const med = Number(medical || 0);
            const trans = Number(transport || 0);
            const spec = Number(special || 0);
            const gross = (basic + hra + med + trans + spec);
            return { monthlyGross, basic, hra, med, trans, spec, gross };
        }

        async function openSalaryManage(empId) {
            if (!empId) return Swal.fire('Error', 'Employee id required', 'error');
            try {
                document.getElementById('salaryAlert').innerHTML = '';
                document.getElementById('salaryEmpId').value = empId;
                // try to load salary structure
                let r = await axios.get(API_BASE + '/api/salary/structure/' + empId).catch(() => ({ data: null }));
                let s = r.data || null;
                // fallback to employee fields
                const emp = caches.employees.find(x => String(x.id) === String(empId) || String(x.EmployeeNumber) === String(empId)) || {};
                if (!s || Object.keys(s).length === 0) {
                    s = {
                        lpa: emp.lpa || emp.LPA || emp.Lpa || emp.monthly_salary ? (emp.monthly_salary * 12 / 100000) : '',
                        basic_pct: emp.basic_pct || emp.BasicPercent || 40,
                        hra_pct: emp.hra_pct || emp.HRAPercent || 40,
                        medical_allowance: emp.medical_allowance || emp.MedicalAllowance || emp.medical || 0,
                        transport_allowance: emp.transport_allowance || emp.TransportAllowance || emp.transport || 0,
                        special_allowance: emp.special_allowance || emp.SpecialAllowance || emp.special || 0,
                        paid_basic_monthly: emp.basic_monthly || emp.PaidBasic || emp.basic || ''
                    };
                }
                document.getElementById('salaryLPA').value = s.lpa || '';
                document.getElementById('salaryBasicPct').value = s.basic_pct || 40;
                document.getElementById('salaryHRAPct').value = s.hra_pct || 40;
                document.getElementById('salaryMedical').value = s.medical_allowance || 0;
                document.getElementById('salaryTransport').value = s.transport_allowance || 0;
                document.getElementById('salarySpecial').value = s.special_allowance || 0;
                const comp = computeSalaryFromLPA(s.lpa || emp.lpa || 0, s.basic_pct, s.hra_pct, s.medical_allowance, s.transport_allowance, s.special_allowance);
                document.getElementById('salaryPaidBasic').value = (s.paid_basic_monthly || emp.basic_monthly || comp.basic).toFixed(2);
                new bootstrap.Modal(document.getElementById('salaryModal')).show();
            } catch (e) { Swal.fire('Error', 'Unable to load salary', 'error'); }
        }

        async function onSaveSalaryStructure(e) {
            e.preventDefault();
            const empId = document.getElementById('salaryEmpId').value;
            const payload = {
                lpa: Number(document.getElementById('salaryLPA').value) || 0,
                basic_pct: Number(document.getElementById('salaryBasicPct').value) || 0,
                hra_pct: Number(document.getElementById('salaryHRAPct').value) || 0,
                medical_allowance: Number(document.getElementById('salaryMedical').value) || 0,
                transport_allowance: Number(document.getElementById('salaryTransport').value) || 0,
                special_allowance: Number(document.getElementById('salarySpecial').value) || 0,
                paid_basic_monthly: Number(document.getElementById('salaryPaidBasic').value) || 0,
                working_days: Number(document.getElementById('salaryWorkingDays') ? document.getElementById('salaryWorkingDays').value : 30) || 30,
                loss_of_days: Number(document.getElementById('salaryLossDays') ? document.getElementById('salaryLossDays').value : 0) || 0
            };
            try {
                document.getElementById('salaryAlert').innerHTML = '<div class="small-muted">Saving...</div>';
                // preferred: server accepts structured payload. capture response to show updated employee columns
                let saveResp = null;
                try {
                    saveResp = await axios.post(API_BASE + '/api/salary/structure/' + empId, payload);
                } catch (postErr) {
                    // fallback: post components individually for older endpoints
                    for (const [k, v] of Object.entries(payload)) {
                        try { await axios.post(API_BASE + '/api/salary/structure/' + empId, { component_name: k, component_value: v }); } catch (e) { /* ignore individual failures */ }
                    }
                }

                // Update `employees` record only for columns that already exist on the returned employee object
                const emp = caches.employees.find(x => String(x.id) === String(empId) || String(x.EmployeeNumber) === String(empId) || String(x.employee_id) === String(empId));
                if (emp) {
                    const empUpdate = {};
                    const map = {
                        lpa: ['lpa', 'LPA', 'annual_salary_lpa'],
                        paid_basic_monthly: ['paid_basic_monthly','paid_basic','PaidBasic','basic_monthly','monthly_basic','basic'],
                        basic_pct: ['basic_pct','basic_percent'],
                        hra_pct: ['hra_pct','hra_percent'],
                        medical_allowance: ['medical_allowance','medical','medical_amount'],
                        transport_allowance: ['transport_allowance','transport','transport_amount'],
                        special_allowance: ['special_allowance','special','special_amount'],
                        working_days: ['working_days','month_days'],
                        loss_of_days: ['loss_of_days']
                    };

                    Object.keys(payload).forEach(k => {
                        const candidates = map[k] || [k];
                        for (const c of candidates) {
                            if (Object.prototype.hasOwnProperty.call(emp, c)) { empUpdate[c] = payload[k]; break; }
                        }
                    });

                    // compute monthly gross and map if possible
                    try {
                        const comp = computeSalaryFromLPA(payload.lpa, payload.basic_pct, payload.hra_pct, payload.medical_allowance, payload.transport_allowance, payload.special_allowance);
                        const grossNames = ['monthly_salary','monthly_gross','monthly_gross_amount','gross_amount','remuneration_amount'];
                        for (const g of grossNames) { if (Object.prototype.hasOwnProperty.call(emp, g) && !empUpdate[g]) { empUpdate[g] = Math.round((comp.monthlyGross + Number.EPSILON) * 100) / 100; break; } }
                    } catch (e) { }

                    if (Object.keys(empUpdate).length > 0) {
                        try {
                            await axios.put(ENDPOINT.employees + '/' + (emp.id || emp.employee_id || emp.EmployeeNumber), empUpdate);
                        } catch (e) { console.warn('Employee update failed', e); }
                    }
                }

                // Show which employee columns were updated (if any)
                const updatedCols = (saveResp && saveResp.data && saveResp.data.updated_employee_columns) ? saveResp.data.updated_employee_columns : [];
                document.getElementById('salaryAlert').innerHTML = `<div class="alert alert-success">Saved${updatedCols.length ? ' — updated: ' + updatedCols.join(', ') : ''}</div>`;
                await loadEmployees(); renderSalaryEmployees();
                setTimeout(() => { try { bootstrap.Modal.getInstance(document.getElementById('salaryModal')).hide(); } catch (e) {} }, 450);
            } catch (err) { const m = err.response && err.response.data && (err.response.data.error || err.response.data.message) ? (err.response.data.error || err.response.data.message) : err.message; document.getElementById('salaryAlert').innerHTML = '<div class="alert alert-danger">' + m + '</div>'; }
        }

        function previewSalaryPayslip() {
            const lpa = Number(document.getElementById('salaryLPA').value) || 0;
            const basicPct = Number(document.getElementById('salaryBasicPct').value) || 0;
            const hraPct = Number(document.getElementById('salaryHRAPct').value) || 0;
            const med = Number(document.getElementById('salaryMedical').value) || 0;
            const trans = Number(document.getElementById('salaryTransport').value) || 0;
            const spec = Number(document.getElementById('salarySpecial').value) || 0;
            const workingDays = Number(document.getElementById('salaryWorkingDays').value) || 30;
            const lossDays = Number(document.getElementById('salaryLossDays').value) || 0;
            const comp = computeSalaryFromLPA(lpa, basicPct, hraPct, med, trans, spec);
            const factor = Math.max(0, (workingDays - lossDays) / workingDays);
            const payableBasic = comp.basic * factor;
            const payableHRA = comp.hra * factor;
            const payableMed = comp.med * factor;
            const payableTrans = comp.trans * factor;
            const payableSpec = comp.spec * factor;
            const gross = payableBasic + payableHRA + payableMed + payableTrans + payableSpec;
            // simple default deductions
            const pf = payableBasic * 0.12; // employee PF
            const esi = gross * 0.0175;
            const totalDeductions = pf + esi;
            const net = gross - totalDeductions;
            document.getElementById('salaryPaidBasic').value = payableBasic.toFixed(2);
            // show preview in modal body alert
            document.getElementById('salaryAlert').innerHTML = `<div class="small-muted">Preview — Gross: ${gross.toFixed(2)}, Deductions: ${totalDeductions.toFixed(2)}, Net: ${net.toFixed(2)}</div>`;
        }

        async function generatePayslip(empId) {
            if (!empId) return Swal.fire('Error', 'Employee id required', 'error');
            try {
                // prefer employee columns if present, otherwise use saved salary_structure
                const emp = caches.employees.find(x => String(x.id) === String(empId) || String(x.EmployeeNumber) === String(empId)) || {};
                let r = await axios.get(API_BASE + '/api/salary/structure/' + empId).catch(() => ({ data: null }));
                const s = r.data || {};

                // build source values preferring employee fields
                const src = {
                    lpa: (emp.lpa !== undefined && emp.lpa !== null && String(emp.lpa).trim() !== '') ? emp.lpa : (s.lpa || 0),
                    basic_pct: (emp.basic_pct !== undefined && emp.basic_pct !== null) ? emp.basic_pct : (s.basic_pct || 40),
                    hra_pct: (emp.hra_pct !== undefined && emp.hra_pct !== null) ? emp.hra_pct : (s.hra_pct || 40),
                    medical_allowance: (emp.medical_allowance !== undefined && emp.medical_allowance !== null) ? emp.medical_allowance : (s.medical_allowance || 0),
                    transport_allowance: (emp.transport_allowance !== undefined && emp.transport_allowance !== null) ? emp.transport_allowance : (s.transport_allowance || 0),
                    special_allowance: (emp.special_allowance !== undefined && emp.special_allowance !== null) ? emp.special_allowance : (s.special_allowance || 0),
                    paid_basic_monthly: (emp.paid_basic_monthly !== undefined && emp.paid_basic_monthly !== null) ? emp.paid_basic_monthly : (s.paid_basic_monthly || 0)
                };

                const comp = computeSalaryFromLPA(src.lpa || 0, src.basic_pct, src.hra_pct, src.medical_allowance, src.transport_allowance, src.special_allowance);
                const payableBasic = Number(src.paid_basic_monthly || emp.basic_monthly || comp.basic || 0);
                const payableHRA = Number((s.hra || (payableBasic * (Number(s.hra_pct || 0) / 100))) || comp.hra || 0);
                const gross = Number((payableBasic + payableHRA + (comp.med || 0) + (comp.trans || 0) + (comp.spec || 0)) || comp.gross || 0);
                const pf = payableBasic * 0.12;
                const esi = gross * 0.0175;
                const totalDeductions = pf + esi;
                const net = gross - totalDeductions;
                const slip = {
                    FullName: emp.FullName || emp.full_name || '',
                    employee_id: emp.EmployeeNumber || emp.EmployeeNo || emp.id,
                    payroll_month: new Date().toISOString().slice(0,7),
                    basic: payableBasic,
                    hra: payableHRA,
                    medical_allowance: comp.med,
                    transport_allowance: comp.trans,
                    special_allowance: comp.spec,
                    gross_amount: gross,
                    pf_employee: pf,
                    esi_employee: esi,
                    total_deductions: totalDeductions,
                    net_pay: net
                };
                document.getElementById('payslipModalBody').innerHTML = formatPayslipHtml(slip);
                new bootstrap.Modal(document.getElementById('payslipModal')).show();
            } catch (e) { Swal.fire('Error', 'Unable to generate payslip', 'error'); }
        }

        /* ATTENDANCE */
        async function fetchAttendanceReport() { const from = document.getElementById('attFrom').value; const to = document.getElementById('attTo').value; const emp = document.getElementById('attEmployee').value; const params = new URLSearchParams(); if (from) params.append('start_date', from); if (to) params.append('end_date', to); if (emp) params.append('employee_id', emp); try { const r = await axios.get(ENDPOINT.attendanceReport + '?' + params.toString()); const rows = r.data || []; const tbody = document.querySelector('#tblAttendance tbody'); tbody.innerHTML = ''; rows.forEach((row, i) => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${i + 1}</td><td>${row.EmployeeNumber || row.employee_number || ''}</td><td>${row.FullName || row.Fullname || ''}</td><td>${row.punch_date || ''}</td><td>${row.punch_in_time || ''}</td><td>${row.punch_out_time || ''}</td>`; tbody.appendChild(tr); }); } catch (e) { Swal.fire('Error', 'Failed to fetch attendance', 'error'); } }

        function getCurrentUserId() { return currentUser?.id || currentUser?.userId || currentUser?.employee_id || null; }

        async function loadTodayAttendanceStatus() {
            const statusEl = document.getElementById('todayAttendanceStatus');
            const btnIn = document.getElementById('btnCheckIn');
            const btnOut = document.getElementById('btnCheckOut');
            if (!getCurrentUserId()) { if (statusEl) statusEl.innerText = 'Login to Check In/Out'; if (btnIn) btnIn.disabled = true; if (btnOut) btnOut.disabled = true; return; }
            try {
                const today = new Date().toISOString().slice(0, 10);
                const r = await axios.get(API_BASE + '/api/attendance/me?from=' + today + '&to=' + today);
                const rows = r.data || [];
                const rec = rows[0] || null;
                if (!rec) {
                    statusEl.innerHTML = '<div class="small-muted">Not checked in today</div>';
                    btnIn.disabled = false; btnOut.disabled = true;
                } else {
                    const inTime = rec.punch_in_time || rec.punch_in_time;
                    const outTime = rec.punch_out_time || rec.punch_out_time;
                    statusEl.innerHTML = `<div>In: <b>${inTime || '—'}</b> ${outTime ? ' | Out: <b>' + outTime + '</b>' : ''}</div>`;
                    btnIn.disabled = !!inTime;
                    btnOut.disabled = !inTime || !!outTime;
                }
            } catch (e) { if (statusEl) statusEl.innerText = 'Unable to load attendance status'; if (btnIn) btnIn.disabled = true; if (btnOut) btnOut.disabled = true; }
        }

        async function doCheckIn() {
            if (!getCurrentUserId()) return Swal.fire('Error', 'Login required', 'error');
            try { await axios.post(API_BASE + '/api/attendance/checkin', { source: 'web' }); Swal.fire('Checked In', '', 'success'); await loadTodayAttendanceStatus(); } catch (e) { Swal.fire('Error', 'Check-in failed', 'error'); }
        }

        async function doCheckOut() {
            if (!getCurrentUserId()) return Swal.fire('Error', 'Login required', 'error');
            try { await axios.post(API_BASE + '/api/attendance/checkout', {}); Swal.fire('Checked Out', '', 'success'); await loadTodayAttendanceStatus(); } catch (e) { Swal.fire('Error', 'Check-out failed', 'error'); }
        }

        /* TIMESHEETS */
        function openTimesheetModal() { document.getElementById('tsDate').value = new Date().toISOString().slice(0, 10); new bootstrap.Modal(document.getElementById('timesheetModal')).show(); }
        async function onTimesheetSubmit(e) { e.preventDefault(); const project_id = document.getElementById('tsProject').value; const hours = parseFloat(document.getElementById('tsHours').value); const date = document.getElementById('tsDate').value; if (!currentUser) return Swal.fire('Error', 'Login required', 'error'); const payload = { employee_id: currentUser.id || currentUser.userId || currentUser.employee_id, project_id, hours, date }; try { await axios.post(ENDPOINT.timesheets, payload); Swal.fire('Saved', 'Timesheet submitted', 'success'); bootstrap.Modal.getInstance(document.getElementById('timesheetModal')).hide(); await loadTimesheets(); } catch (err) { Swal.fire('Error', 'Failed to submit timesheet', 'error'); } }
        document.getElementById('timesheetForm').addEventListener('submit', onTimesheetSubmit);
        async function loadTimesheets() { try { const r = await axios.get(ENDPOINT.timesheets); let rows = r.data || []; if (currentUser) { const myId = currentUser.id || currentUser.userId || currentUser.employee_id; rows = rows.filter(x => String(x.employee_id) === String(myId)); } document.getElementById('timesheetList').innerHTML = (rows).map(t => `<div>${t.date || t.submission_date} — Project ${t.project_id} — ${t.hours} hrs</div>`).join('') || '<div class="small-muted">No timesheets</div>'; } catch (e) { document.getElementById('timesheetList').innerHTML = '<div class="small-muted">Unable to load timesheets</div>'; } }

        /* LEAVES */
        function openLeaveModal() { new bootstrap.Modal(document.getElementById('leaveModal')).show(); }
        async function onLeaveSubmit(e) { e.preventDefault(); const leave_type = document.getElementById('leaveType').value; const start_date = document.getElementById('leaveFrom').value; const end_date = document.getElementById('leaveTo').value; const reason = document.getElementById('leaveReason').value; try { await axios.post(ENDPOINT.leaves, { leave_type, start_date, end_date, reason }); Swal.fire('Requested', 'Leave request submitted', 'success'); bootstrap.Modal.getInstance(document.getElementById('leaveModal')).hide(); await loadLeaves(); } catch (err) { Swal.fire('Error', 'Failed to submit leave', 'error'); } }
        async function loadLeaves() { try { const r = await axios.get(ENDPOINT.leaves); document.getElementById('leaveList').innerHTML = (r.data || []).map(l => `<div>${l.leave_type} — ${l.start_date} to ${l.end_date} — <b>${l.status}</b></div>`).join('') || '<div class="small-muted">No leaves</div>'; } catch (e) { document.getElementById('leaveList').innerHTML = '<div class="small-muted">Unable to load leaves</div>'; } }

        /* ANNOUNCEMENTS */
        async function loadAnnouncements() { try { const r = await axios.get(ENDPOINT.announcements); caches.announcements = r.data || []; } catch (e) { } }

        async function openViewWishes(empId, name) {
            try {
                const r = await axios.get(ENDPOINT.birthdayWishes + '/' + empId);
                const rows = r.data || [];
                const html = rows.map(w => `<div class="mb-2"><div><b>${w.sender_name || w.sender_username || 'Someone'}</b> <span class="small-muted">${(w.created_at||'').slice(0,19)}</span></div><div>${(w.message||'').replace(/\n/g,'<br>')}</div></div>`).join('') || '<div class="small-muted">No wishes</div>';
                document.getElementById('birthdayWishesBody').innerHTML = `<h6>Wishes for ${name}</h6>` + html;
                new bootstrap.Modal(document.getElementById('birthdayWishesModal')).show();
            } catch (e) {
                document.getElementById('birthdayWishesBody').innerHTML = '<div class="small-muted">Unable to load wishes</div>';
                new bootstrap.Modal(document.getElementById('birthdayWishesModal')).show();
            }
        }

        /* BIRTHDAYS & WISH */
        async function loadBirthdays() { try { const r = await axios.get(ENDPOINT.birthdays + '?days=7'); caches.birthdays = r.data || []; } catch (e) { caches.birthdays = []; } }
        function openWishModal(empId, name) { Swal.fire({ title: `Wish ${name}`, input: 'textarea', inputPlaceholder: 'Type your message', showCancelButton: true }).then(async res => { if (!res.value) return; try { await axios.post(ENDPOINT.birthdayWishes, { employee_id: empId, message: res.value }); Swal.fire('Sent', 'Wish recorded', 'success'); } catch (e) { Swal.fire('Error', 'Failed to send wish', 'error'); } }); }

        /* SUPPORT remains internal (no menu) */

        /* UPLOADS */
        async function uploadEmployees() { const file = document.getElementById('uploadEmployeesFile').files[0]; if (!file) { Swal.fire('Select file', 'Choose an Excel file', 'warning'); return; } const fd = new FormData(); fd.append('file', file); try { const r = await axios.post(ENDPOINT.uploadEmployees, fd, { headers: { 'Content-Type': 'multipart/form-data' } }); Swal.fire('Uploaded', '' + JSON.stringify(r.data), 'success'); await loadEmployees(); } catch (e) { Swal.fire('Error', 'Upload failed', 'error'); } }
        async function uploadHolidays() { const file = document.getElementById('uploadHolidaysFile').files[0]; if (!file) { Swal.fire('Select file', 'Choose an Excel file', 'warning'); return; } const fd = new FormData(); fd.append('file', file); try { const r = await axios.post(ENDPOINT.uploadHolidays, fd, { headers: { 'Content-Type': 'multipart/form-data' } }); Swal.fire('Uploaded', '' + JSON.stringify(r.data), 'success'); await initMasters(); } catch (e) { Swal.fire('Error', 'Upload failed', 'error'); } }
        async function uploadPayroll() { const file = document.getElementById('uploadPayrollFile').files[0]; if (!file) { Swal.fire('Select file', 'Choose an Excel file', 'warning'); return; } const fd = new FormData(); fd.append('file', file); try { const r = await axios.post(ENDPOINT.uploadPayroll, fd, { headers: { 'Content-Type': 'multipart/form-data' } }); Swal.fire('Uploaded', '' + JSON.stringify(r.data), 'success'); await loadPayroll(); await loadDashboard(); } catch (e) { Swal.fire('Error', 'Upload failed', 'error'); } }

        /* MASTERS: tabbed DataGrid, dynamic columns and add-only modal */
        let caches_masters = {};
        let currentMasterTab = MASTER_CONFIG[0].key;

        function initMasters() {
            const tabs = document.getElementById('mastersTabs');
            const content = document.getElementById('mastersTabContent');
            tabs.innerHTML = '';
            content.innerHTML = '';
            MASTER_CONFIG.forEach((m, idx) => {
                const active = idx === 0 ? 'active' : '';
                const tabId = 'tab-' + m.key;
                tabs.insertAdjacentHTML('beforeend', `<li class="nav-item" role="presentation"><button class="nav-link ${active}" id="${tabId}-tab" data-bs-toggle="tab" data-key="${m.key}" type="button" role="tab" aria-controls="${tabId}">${m.title}</button></li>`);
                content.insertAdjacentHTML('beforeend', `<div class="tab-pane ${active}" id="${tabId}" role="tabpanel"><div id="${m.key}-container"></div></div>`);
            });

            document.querySelectorAll('#mastersTabs button[data-key]').forEach(btn => {
                btn.addEventListener('click', e => {
                    const k = e.currentTarget.getAttribute('data-key');
                    currentMasterTab = k;
                    loadMastersTab(k);
                    document.getElementById('btnAddMaster').style.display = (currentUser && (currentUser.role === 'admin' || currentUser.role === 'hr')) ? '' : 'none';
                });
            });

            // load first tab
            loadMastersTab(currentMasterTab);
        }

        async function loadMastersTab(key) {
            const conf = MASTER_CONFIG.find(x => x.key === key);
            if (!conf) return;
            const container = document.getElementById(key + '-container');
            container.innerHTML = '<div class="small-muted">Loading...</div>';
            try {
                const r = await axios.get(API_BASE + conf.endpoint);
                const rows = r.data || [];
                caches_masters[key] = rows;
                renderMasterTable(key, rows);
            } catch (err) {
                container.innerHTML = '<div class="alert alert-danger">Failed to load</div>';
            }
        }

        function renderMasterTable(key, rows) {
            const conf = MASTER_CONFIG.find(x => x.key === key);
            const container = document.getElementById(key + '-container');
            container.innerHTML = '';
            const cols = new Set();
            rows.forEach(r => Object.keys(r).forEach(c => cols.add(c)));
            let colList = Array.from(cols);
            colList.sort((a, b) => {
                if (a === 'id') return -1;
                if (b === 'id') return 1;
                if (a.toLowerCase().includes('name')) return -1;
                if (b.toLowerCase().includes('name')) return 1;
                if (a.toLowerCase().includes('code')) return -1;
                if (b.toLowerCase().includes('code')) return 1;
                return a.localeCompare(b);
            });

            const header = `<div class="d-flex justify-content-between align-items-center mb-2">
    <div><strong>${conf.title}</strong> <span class="small-muted">(${rows.length} records)</span></div>
    <div><input class="form-control form-control-sm" placeholder="Search" oninput="filterMasterTable('${key}', this.value)" style="width:220px"></div>
  </div>`;
            let table = `<div class="table-responsive"><table class="table table-hover table-sm" id="${key}-table"><thead><tr>${colList.map(c => `<th>${c}</th>`).join('')}</tr></thead><tbody>`;
            rows.forEach(r => {
                table += `<tr>${colList.map(c => `<td>${escapeHtml(displayValue(r[c]))}</td>`).join('')}</tr>`;
            });
            table += `</tbody></table></div>`;
            container.innerHTML = header + table;
            conf._columns = colList;
        }

        function displayValue(v) { if (v === null || v === undefined) return ''; if (typeof v === 'object') return JSON.stringify(v); return v; }
        function escapeHtml(s) { return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

        function filterMasterTable(key, q) {
            const table = document.getElementById(key + '-table');
            if (!table) return;
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(tr => {
                tr.style.display = tr.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        }

        function openAddMasterModal() {
            const conf = MASTER_CONFIG.find(x => x.key === currentMasterTab);
            if (!conf) return Swal.fire('Error', 'No master selected', 'error');
            const body = document.getElementById('addMasterBody');
            body.innerHTML = '';
            const cols = conf._columns && conf._columns.length ? conf._columns : ['name'];
            const writable = cols.filter(c => !['id', 'created_at', 'updated_at', 'createdAt', 'updatedAt'].includes(c));
            const fields = writable.length ? writable : ['name'];
            document.getElementById('addMasterTitle').innerText = 'Add New ' + conf.title;
            fields.forEach(f => {
                const label = f.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                body.insertAdjacentHTML('beforeend', `<div class="mb-2"><label class="form-label">${label}</label><input class="form-control" name="${f}" id="add_${f}" required></div>`);
            });
            conf._addFields = fields;
            new bootstrap.Modal(document.getElementById('addMasterModal')).show();
        }

        async function onAddMasterSubmit(e) {
            e.preventDefault();
            const conf = MASTER_CONFIG.find(x => x.key === currentMasterTab);
            if (!conf) return;
            const payload = {};
            (conf._addFields || ['name']).forEach(f => {
                const el = document.getElementById('add_' + f);
                if (el) payload[f] = el.value;
            });
            try {
                const r = await axios.post(API_BASE + conf.endpoint, payload, { headers: { 'Content-Type': 'application/json' } });
                Swal.fire('Saved', 'Record added', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addMasterModal')).hide();
                await loadMastersTab(conf.key);
            } catch (err) {
                const msg = err.response && err.response.data && (err.response.data.error || err.response.data.message) ? (err.response.data.error || err.response.data.message) : err.message;
                Swal.fire('Error', msg, 'error');
            }
        }
        document.getElementById('addMasterForm').addEventListener('submit', onAddMasterSubmit);

        /* PAYROLL */
        async function loadPayroll() {
            try {
                // Load recent runs
                const runsRes = await axios.get(API_BASE + '/api/payroll/runs');
                const runs = runsRes.data || [];
                let html = '';
                if (runs.length) {
                    html += '<div class="mb-2"><strong>Recent Payroll Runs</strong></div>';
                    runs.forEach(r => {
                        html += `<div class="mb-2">${r.payroll_month} — ${r.payroll_type} — Runs: ${r.id} — Slips: ${r.slip_count} <button class="btn btn-sm btn-outline-primary ms-2" onclick="fetchRunSlips(${r.id})">View Slips</button></div>`;
                    });
                } else {
                    html += '<div class="small-muted">No payroll runs</div>';
                }

                // Show recent slips (fallback)
                const r = await axios.get(ENDPOINT.payslipsList);
                const slips = r.data || [];
                if (slips.length) {
                    html += '<hr /><div class="mb-2"><strong>Recent Slips</strong></div>';
                    html += slips.slice(0, 10).map(s => {
                        const empId = s.employee_id || s.employeeId || '';
                        const slipId = s.id || s.slip_id || '';
                        return `<div class="mb-2">${s.payroll_month || s.payroll_run_id || ''} — ${s.FullName || ''} — Net: ${s.net_pay || s.net_salary || ''} <button class="btn btn-sm btn-outline-secondary ms-2" onclick="openRecalc(${empId})">Recalc</button> <button class="btn btn-sm btn-outline-primary ms-1" onclick="viewPayslip(${empId}, ${slipId})">View</button></div>`;
                    }).join('');
                }

                document.getElementById('payrollList').innerHTML = html;
            } catch (e) {
                document.getElementById('payrollList').innerHTML = '<div class="small-muted">Unable to load payroll</div>';
            }
        }

        async function fetchRunSlips(runId) {
            try {
                const r = await axios.get(API_BASE + '/api/payroll/' + runId);
                const slips = r.data || [];
                if (!slips.length) return Swal.fire('Info', 'No slips for this run', 'info');
                const list = slips.slice(0, 30).map(s => `${s.FullName || ''} — Net: ${s.net_pay || ''}`).join('<br/>');
                Swal.fire({ title: 'Slips for run ' + runId, html: '<div style="text-align:left">' + list + '</div>', width: 800 });
            } catch (err) { Swal.fire('Error', 'Unable to fetch slips', 'error'); }
        }
        async function openRecalc(empId) {
            document.getElementById('recalcEmpId').value = empId || '';
            document.getElementById('recalcDetails').innerHTML = 'Loading payslip details...';
            try {
                const r = await axios.get(`${ENDPOINT.payslipsList}/${empId}`);
                const rows = r.data || [];
                const slip = rows[0] || null;
                if (!slip) document.getElementById('recalcDetails').innerText = 'No payslip found for this employee.';
                else {
                    // merge employee-level salary fields so recalc prefers employee table values
                    const emp = caches.employees.find(x => String(x.id) === String(empId) || String(x.EmployeeNumber) === String(empId)) || {};
                    try {
                        if (emp) {
                            // prefer explicit monthly basic if present
                            if (!slip.basic && (emp.basic_monthly || emp.basic)) slip.basic = Number(emp.basic_monthly || emp.basic);
                            // hra: if missing, compute from basic using employee hra pct
                            if ((!slip.hra || slip.hra === 0) && (emp.hra_pct || emp.HRAPercent)) {
                                const b = Number(slip.basic || emp.basic_monthly || emp.basic || 0);
                                slip.hra = Math.round(b * (Number(emp.hra_pct || emp.HRAPercent) / 100) * 100) / 100;
                            }
                            slip.medical_allowance = slip.medical_allowance || emp.medical_allowance || emp.MedicalAllowance || emp.medical || 0;
                            slip.transport_allowance = slip.transport_allowance || emp.transport_allowance || emp.TransportAllowance || emp.transport || 0;
                            slip.special_allowance = slip.special_allowance || emp.special_allowance || emp.SpecialAllowance || emp.special || 0;
                        }
                    } catch (ex) { console.warn('Failed to merge employee salary fields', ex); }
                    // keep slip for preview and render editable basic field
                    window._currentSlipForRecalc = slip;
                    document.getElementById('recalcDetails').innerHTML = renderRecalcDetails(slip);
                    // attach input listener for live preview
                    const basicEl = document.getElementById('recalc_basic');
                    if (basicEl) basicEl.addEventListener('input', previewRecalc);
                    previewRecalc();
                }
            } catch (e) { document.getElementById('recalcDetails').innerText = 'Unable to load payslip details.'; }
            new bootstrap.Modal(document.getElementById('recalcModal')).show();
        }

        function renderRecalcDetails(slip) {
            if (!slip) return '<div class="small-muted">No payslip data</div>';
            const earningsKeys = ['basic','hra','medical_allowance','transport_allowance','special_allowance','meal_coupons','incentives','other_reimbursement','gross_amount'];
            const deductionsKeys = ['pf_employee','esi_employee','total_deductions','loan_deduction','professional_tax','total_income_tax','other_deduction'];
            // derive sensible defaults
            const defaultWorkingDays = slip.working_days || slip.month_days || 30;
            let defaultHraPercent = 40;
            if (slip.hra && slip.basic) defaultHraPercent = Math.round((Number(slip.hra) / Number(slip.basic)) * 100);
            let html = `<div class="mb-2"><b>${slip.FullName || slip.full_name || ''}</b> — ${slip.payroll_month || slip.payroll_run_id || ''}<div class="small-muted">Employee ID: ${slip.employee_id || ''}</div></div>`;
            html += '<div class="row"><div class="col-md-6"><h6>Earnings</h6><table class="table table-sm"><tbody>';
            // basic input
            const basicVal = slip.basic || slip.remuneration_amount || 0;
            html += `<tr><td>Basic</td><td class="text-end"><input id="recalc_basic" type="number" step="0.01" class="form-control form-control-sm text-end" value="${Number(basicVal)||0}"></td></tr>`;
            // HRA percentage input (compute HRA from percent)
            html += `<tr><td>HRA %</td><td class="text-end"><div class="input-group"><input id="recalc_hra_percent" type="number" step="0.1" class="form-control form-control-sm text-end" value="${defaultHraPercent}"><span class="input-group-text">%</span></div></td></tr>`;
            // payable previews (basic & hra) that reflect loss-of-days
            html += `<tr><td>Payable Basic</td><td class="text-end"><span id="recalc_basic_payable" class="fw-bold">${formatMoney(basicVal)}</span></td></tr>`;
            html += `<tr><td>Payable HRA</td><td class="text-end"><span id="recalc_hra_payable" class="fw-bold">${formatMoney((basicVal * (defaultHraPercent/100))||0)}</span></td></tr>`;
            // other earnings display (will be prorated)
            ['medical_allowance','transport_allowance','special_allowance','meal_coupons','incentives','other_reimbursement'].forEach(k => {
                const val = slip[k] !== undefined ? slip[k] : 0;
                if (val !== 0) html += `<tr><td>${k.replace(/_/g,' ')}</td><td class="text-end"><span class="small-muted">${formatMoney(val)}</span></td></tr>`;
            });
            html += '</tbody></table>';
            // loss of days / working days inputs
            html += `<div class="mt-2"><div class="row"><div class="col"><label class="form-label">Working Days</label><input id="recalc_working_days" type="number" class="form-control form-control-sm" value="${defaultWorkingDays}"></div><div class="col"><label class="form-label">Loss Of Days</label><input id="recalc_loss_of_days" type="number" class="form-control form-control-sm" value="${slip.loss_of_days || 0}"></div></div></div>`;
            html += '</div>';
            // deductions column
            html += '<div class="col-md-6"><h6>Deductions</h6><table class="table table-sm"><tbody>';
            deductionsKeys.forEach(k => { if (slip[k] !== undefined) html += `<tr><td>${k.replace(/_/g,' ')}</td><td class="text-end"><span class="small-muted">${formatMoney(slip[k])}</span></td></tr>`; });
            html += '</tbody></table></div></div>';
            html += '<div class="mt-2"><table class="table table-sm"><tbody><tr><td><b>Gross</b></td><td class="text-end"><b id="recalc_gross">' + formatMoney(slip.gross_amount || slip.remuneration_amount) + '</b></td></tr><tr><td><b>Total Deductions</b></td><td class="text-end" id="recalc_deductions">' + formatMoney(slip.total_deductions || 0) + '</td></tr><tr><td><b>Net Pay</b></td><td class="text-end"><b id="recalc_net">' + formatMoney(slip.net_pay || slip.total_net_pay) + '</b></td></tr></tbody></table></div>';
            // expose current slip for preview calculations
            window._currentSlipForRecalc = slip;
            // ensure recalcNet input shows current net
            setTimeout(() => { const netEl = document.getElementById('recalcNet'); if (netEl) netEl.value = (slip.net_pay || slip.total_net_pay) || '' }, 50);
            return html;
        }

        function previewRecalc() {
            const slip = window._currentSlipForRecalc || {};
            const basicVal = Number(document.getElementById('recalc_basic') ? document.getElementById('recalc_basic').value : (slip.basic||0)) || 0;
            const hraPercent = Number(document.getElementById('recalc_hra_percent') ? document.getElementById('recalc_hra_percent').value : 0) || 0;
            const workingDays = Number(document.getElementById('recalc_working_days') ? document.getElementById('recalc_working_days').value : (slip.working_days || 30)) || 30;
            const lossDays = Number(document.getElementById('recalc_loss_of_days') ? document.getElementById('recalc_loss_of_days').value : (slip.loss_of_days || 0)) || 0;
            const payableDays = Math.max(0, workingDays - lossDays);
            const factor = workingDays > 0 ? (payableDays / workingDays) : 1;
            // compute hra from percent
            const hra = Math.round((basicVal * (hraPercent / 100)) * 100) / 100;
            // sum other earnings from slip and prorate them
            const otherEarningsKeys = ['medical_allowance','transport_allowance','special_allowance','meal_coupons','incentives','other_reimbursement'];
            let otherEarnings = 0;
            otherEarningsKeys.forEach(k => { otherEarnings += Number(slip[k] || 0); });
            // gross before prorate
            // compute payable components after factoring loss-of-days
            const payableBasic = Math.round((basicVal * factor + Number.EPSILON) * 100) / 100;
            const payableHra = Math.round((hra * factor + Number.EPSILON) * 100) / 100;
            const payableOther = Math.round((otherEarnings * factor + Number.EPSILON) * 100) / 100;
            const gross = Math.round((payableBasic + payableHra + payableOther + Number.EPSILON) * 100) / 100;
            // deductions: prefer existing fields scaled by factor, but compute pf/esi if missing
            const deductionsKeys = ['pf_employee','esi_employee','loan_deduction','professional_tax','total_income_tax','other_deduction'];
            let dedTotal = 0;
            // scale known deduction values
            deductionsKeys.forEach(k => { if (slip[k] !== undefined) dedTotal += Number(slip[k] || 0) * factor; });
            // ensure PF (12%) if not present
            if (slip.pf_employee === undefined || slip.pf_employee === null) {
                dedTotal += Math.round((basicVal * 0.12 * factor + Number.EPSILON) * 100) / 100;
            }
            // ensure ESI (1.75% employee share) if not present
            if (slip.esi_employee === undefined || slip.esi_employee === null) {
                dedTotal += Math.round((basicVal * 0.0175 * factor + Number.EPSILON) * 100) / 100;
            }
            const net = Math.round((gross - dedTotal + Number.EPSILON) * 100) / 100;
            // update payable displays
            const pbEl = document.getElementById('recalc_basic_payable'); if (pbEl) pbEl.innerText = formatMoney(payableBasic);
            const phEl = document.getElementById('recalc_hra_payable'); if (phEl) phEl.innerText = formatMoney(payableHra);
            const gEl = document.getElementById('recalc_gross'); if (gEl) gEl.innerText = formatMoney(gross);
            const dEl = document.getElementById('recalc_deductions'); if (dEl) dEl.innerText = formatMoney(dedTotal);
            const nEl = document.getElementById('recalc_net'); if (nEl) nEl.innerText = formatMoney(net);
            const netInput = document.getElementById('recalcNet'); if (netInput) netInput.value = net;
        }

        async function onRecalcSubmit(e) {
            e.preventDefault();
            const empId = document.getElementById('recalcEmpId').value.trim();
            const net = Number(document.getElementById('recalcNet').value) || 0;
            if (!empId || !net) return Swal.fire('Error', 'Employee and net pay required', 'error');
            try {
                // collect detailed values from preview
                const basic = Number((document.getElementById('recalc_basic_payable')?.innerText || '').replace(/,/g,'')) || 0;
                const hra = Number((document.getElementById('recalc_hra_payable')?.innerText || '').replace(/,/g,'')) || 0;
                const gross = Number((document.getElementById('recalc_gross')?.innerText || '').replace(/,/g,'')) || 0;
                const total_deductions = Number((document.getElementById('recalc_deductions')?.innerText || '').replace(/,/g,'')) || 0;
                await axios.post(`${ENDPOINT.payrollRecalculate}/${empId}`, { net_pay: net, basic, hra, gross, total_deductions });
                Swal.fire('Success', 'Recalculated', 'success');
                bootstrap.Modal.getInstance(document.getElementById('recalcModal')).hide();
                await loadPayroll(); await loadDashboard();
            } catch (err) { const msg = err.response && err.response.data && (err.response.data.error || err.response.data.message) ? (err.response.data.error || err.response.data.message) : err.message; Swal.fire('Error', msg, 'error'); }
        }
        async function generatePayroll() {
            const month = prompt('Payroll month (YYYY-MM)', new Date().toISOString().slice(0, 7));
            const type = prompt('Payroll type (Monthly/Bonus)', 'Monthly');
            if (!month) return;
            // Ask whether to include inactive employees or run for a single employee
            const includeInactive = confirm('Include inactive employees in this run? (Cancel = only active)');
            let empId = null;
            if (confirm('Run for a single employee only?')) {
                empId = prompt('Enter employee id (numeric)');
                if (!empId) empId = null;
            }
            try {
                document.getElementById('payrollList').innerHTML = '<div class="small-muted">Generating payroll... please wait.</div>';
                const payload = { payroll_month: month, payroll_type: type };
                if (includeInactive) payload.include_inactive = true;
                if (empId) payload.employee_id = Number(empId);
                const r = await axios.post(ENDPOINT.payrollGenerate, payload);
                Swal.fire('Generated', 'Run: ' + (r.data.run_id || '') + ' — Slips: ' + (r.data.count || 0), 'success');
                await loadPayroll();
                await loadDashboard();
            } catch (err) { Swal.fire('Error', 'Failed to generate payroll', 'error'); console.error(err); }
        }
        function exportPayroll() { const doc = new jspdf.jsPDF(); const text = document.getElementById('payrollList').innerText || 'Payroll'; doc.text(text, 10, 10); doc.save('payroll.pdf'); }

        /* INITIAL LOAD */
        async function initialLoad() { const token = localStorage.getItem('hr_token') || null; const savedUser = JSON.parse(localStorage.getItem('hr_user') || 'null'); if (token) axios.defaults.headers.common['Authorization'] = 'Bearer ' + token; if (savedUser) currentUser = savedUser; setUserUI(); try { await Promise.all([loadAnnouncements(), loadBirthdays(), loadEmployees(), initMasters(), loadPayroll()]); } catch (e) { } loadDashboard(); }
        initialLoad();

        function refreshCurrentPage() { const page = document.getElementById('pageTitle').innerText.toLowerCase(); routeTo(page); }

        async function openProfile() {
            if (!currentUser) return openLogin();
            try {
                const r = await axios.get(API_BASE + '/api/profile');
                const p = r.data || {};
                document.getElementById('profileFullName').value = p.FullName || p.full_name || p.Fullname || '';
                document.getElementById('profileWorkEmail').value = p.WorkEmail || p.work_email || '';
                document.getElementById('profilePersonalEmail').value = p.PersonalEmail || p.personal_email || '';
                document.getElementById('profileLocation').value = p.location || p.Location || '';
                document.getElementById('profileDepartment').value = p.department || p.Department || '';
                document.getElementById('profileDesignation').value = p.designation || p.Designation || '';
                // Date of birth: normalize to yyyy-mm-dd for date input
                let dob = p.DateOfBirth || p.date_of_birth || p.DOB || p.birth_date || '';
                if (dob && dob.indexOf && dob.indexOf('T') !== -1) dob = dob.split('T')[0];
                if (dob && dob.indexOf && dob.indexOf(' ') !== -1) dob = dob.split(' ')[0];
                document.getElementById('profileDOB').value = dob || '';
                document.getElementById('profilePH').value = (p.PhysicallyHandicapped || p.physically_handicapped) ? '1' : '0';
                new bootstrap.Modal(document.getElementById('profileModal')).show();
            } catch (e) { Swal.fire('Error', 'Unable to load profile', 'error'); }
        }

        async function onProfileSave(e) {
            e.preventDefault();
            const personal_email = document.getElementById('profilePersonalEmail').value;
            const physically_handicapped = document.getElementById('profilePH').value;
            const date_of_birth = document.getElementById('profileDOB').value || null;
            try {
                await axios.put(API_BASE + '/api/profile', { personal_email, physically_handicapped, date_of_birth });
                Swal.fire('Saved', 'Profile updated', 'success');
                bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
            } catch (err) { Swal.fire('Error', 'Failed to save profile', 'error'); }
        }

        function formatMoney(v) { if (v === null || v === undefined || v === '') return '—'; return Number(v).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

        function formatPayslipHtml(slip) {
            if (!slip) return '<div class="small-muted">No payslip data</div>';
            const earningsKeys = ['basic','hra','medical_allowance','transport_allowance','special_allowance','meal_coupons','incentives','other_reimbursement','gross_amount'];
            const deductionsKeys = ['pf_employee','esi_employee','total_deductions','loan_deduction','professional_tax','total_income_tax','other_deduction'];
            const meta = `<div class="mb-2"><b>${slip.FullName || slip.full_name || ''}</b> — ${slip.payroll_month || slip.payroll_run_id || ''}<div class="small-muted">Employee ID: ${slip.employee_id || ''}</div></div>`;
            let earnHtml = '<div><h6>Earnings</h6><table class="table table-sm"><tbody>';
            earningsKeys.forEach(k => { if (slip[k] !== undefined) earnHtml += `<tr><td>${k.replace(/_/g,' ')}</td><td class="text-end">${formatMoney(slip[k])}</td></tr>`; });
            earnHtml += '</tbody></table></div>';
            let dedHtml = '<div><h6>Deductions</h6><table class="table table-sm"><tbody>';
            deductionsKeys.forEach(k => { if (slip[k] !== undefined) dedHtml += `<tr><td>${k.replace(/_/g,' ')}</td><td class="text-end">${formatMoney(slip[k])}</td></tr>`; });
            dedHtml += '</tbody></table></div>';
            const summary = `<div class="mt-2"><table class="table table-sm"><tbody><tr><td><b>Gross</b></td><td class="text-end"><b>${formatMoney(slip.gross_amount || slip.remuneration_amount)}</b></td></tr><tr><td><b>Total Deductions</b></td><td class="text-end">${formatMoney(slip.total_deductions || 0)}</td></tr><tr><td><b>Net Pay</b></td><td class="text-end"><b>${formatMoney(slip.net_pay || slip.total_net_pay)}</b></td></tr></tbody></table></div>`;
            return meta + '<div class="row"><div class="col-md-6">' + earnHtml + '</div><div class="col-md-6">' + dedHtml + '</div></div>' + summary;
        }

        async function viewPayslip(empId, slipId) {
            if (!empId) return Swal.fire('Error', 'Employee id required', 'error');
            try {
                let slip = null;
                if (slipId) {
                    const r = await axios.get(`${ENDPOINT.payslipsList}/${empId}/${slipId}`);
                    slip = r.data || null;
                } else {
                    const r = await axios.get(`${ENDPOINT.payslipsList}/${empId}`);
                    slip = (r.data && r.data[0]) || null;
                }
                document.getElementById('payslipModalBody').innerHTML = formatPayslipHtml(slip);
                new bootstrap.Modal(document.getElementById('payslipModal')).show();
            } catch (e) { Swal.fire('Error', 'Unable to load payslip', 'error'); }
        }

        function downloadPayslipPdf() {
            try {
                const html = document.getElementById('payslipModalBody').innerText || document.getElementById('payslipModalBody').innerHTML || 'Payslip';
                const doc = new jspdf.jsPDF({ unit: 'pt', format: 'a4' });
                const lines = String(html).split(/\n|\r/).map(l => l.trim()).filter(l => l);
                let y = 40;
                doc.setFontSize(12);
                for (const line of lines) {
                    const text = line.replace(/<[^>]*>/g, '');
                    doc.text(text, 40, y);
                    y += 14;
                    if (y > 800) { doc.addPage(); y = 40; }
                }
                doc.save('payslip.pdf');
            } catch (e) { Swal.fire('Error', 'Unable to create PDF', 'error'); }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>