<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title>Team Compliance</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="loadData()">
        <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar>
    <ion-segment [(ngModel)]="selectedSegment" (ionChange)="onSegmentChange()">
      <ion-segment-button value="today">
        <ion-label>Today</ion-label>
      </ion-segment-button>
      <ion-segment-button value="week">
        <ion-label>This Week</ion-label>
      </ion-segment-button>
      <ion-segment-button value="month">
        <ion-label>This Month</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <app-loading *ngIf="isLoading"></app-loading>

  <div *ngIf="!isLoading" class="content-container">
    <!-- Today's View -->
    <div *ngIf="selectedSegment === 'today'">
      <!-- Stats Card -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="stats-chart-outline"></ion-icon>
            Team Compliance - {{ selectedDate | date:'mediumDate' }}
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-grid>
            <ion-row>
              <ion-col size="6">
                <div class="stat-box">
                  <div class="stat-value">{{ todayStats.total }}</div>
                  <div class="stat-label">Total Team</div>
                </div>
              </ion-col>
              <ion-col size="6">
                <div class="stat-box">
                  <div class="stat-value danger">{{ todayStats.pending }}</div>
                  <div class="stat-label">
                    <ion-icon name="alert-circle-outline" color="danger"></ion-icon>
                    Pending
                  </div>
                </div>
              </ion-col>
            </ion-row>
          </ion-grid>

          <div class="date-picker">
            <ion-button fill="outline" size="small">
              <ion-icon name="calendar-outline" slot="start"></ion-icon>
              <input 
                type="date" 
                [value]="selectedDate" 
                (change)="onDateChange($event)"
                class="date-input"
              />
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Non-Compliant Team Members -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="people-outline"></ion-icon>
            Non-Compliant Team Members
            <ion-badge color="danger" *ngIf="nonCompliantEmployees.length > 0">
              {{ nonCompliantEmployees.length }}
            </ion-badge>
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-searchbar 
            [(ngModel)]="searchTerm"
            placeholder="Search by name, emp number, or department"
            debounce="300">
          </ion-searchbar>

          <div class="bulk-actions" *ngIf="nonCompliantEmployees.length > 0">
            <ion-button 
              expand="block"
              (click)="sendBulkReminders()">
              <ion-icon name="send-outline" slot="start"></ion-icon>
              Send Reminders to All ({{ nonCompliantEmployees.length }})
            </ion-button>
          </div>

          <ion-list *ngIf="filteredEmployees.length > 0">
            <ion-item *ngFor="let emp of filteredEmployees">
              <ion-label>
                <h3>{{ emp.name }}</h3>
                <p>{{ emp.EmployeeNumber }} â€¢ {{ emp.department }}</p>
                <p class="reminder-info" *ngIf="emp.reminder_count > 0">
                  <ion-badge [color]="getReminderBadgeColor(emp.reminder_count)">
                    {{ emp.reminder_count }} reminder(s) sent
                  </ion-badge>
                  <span class="last-reminder" *ngIf="emp.last_reminder_sent">
                    Last: {{ emp.last_reminder_sent | date:'short' }}
                  </span>
                </p>
              </ion-label>
              <ion-button 
                slot="end" 
                fill="outline"
                size="small"
                (click)="sendReminder(emp)">
                <ion-icon name="send-outline" slot="start"></ion-icon>
                Remind
              </ion-button>
            </ion-item>
          </ion-list>

          <div *ngIf="filteredEmployees.length === 0" class="empty-state">
            <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
            <p *ngIf="!searchTerm">All team members are compliant! ðŸŽ‰</p>
            <p *ngIf="searchTerm">No matching employees found</p>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Week/Month View -->
    <div *ngIf="selectedSegment !== 'today'">
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="time-outline"></ion-icon>
            {{ selectedSegment === 'week' ? 'This Week' : 'This Month' }} Summary
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="info-message">
            <ion-icon name="stats-chart-outline"></ion-icon>
            <p>Detailed historical compliance data coming soon</p>
          </div>

          <!-- Show today's non-compliant as a preview -->
          <ion-list *ngIf="nonCompliantEmployees.length > 0">
            <ion-item *ngFor="let emp of nonCompliantEmployees.slice(0, 5)">
              <ion-label>
                <h3>{{ emp.name }}</h3>
                <p>{{ emp.department }}</p>
              </ion-label>
              <ion-badge slot="end" color="warning">
                {{ emp.reminder_count || 0 }} reminders
              </ion-badge>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>
    </div>
  </div>
</ion-content>
