<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start" *ngIf="isEditMode">
      <ion-button (click)="toggleEditMode()">Cancel</ion-button>
    </ion-buttons>
    <ion-title>{{ isEditMode ? 'Edit Profile' : 'Profile' }}</ion-title>
    <ion-buttons slot="end" *ngIf="isEditMode">
      <ion-button (click)="saveProfile()" [disabled]="!profileForm.valid">
        <strong>Save</strong>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="profile-container">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-container">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Loading profile...</p>
    </div>

    <!-- Profile Content -->
    <div *ngIf="!isLoading">
      <!-- Profile Header Card -->
      <ion-card class="profile-header-card">
        <div class="header-gradient">
          <ion-avatar class="profile-avatar">
            <img [src]="getProfileImageUrl()" 
                 alt="Profile" 
                 (error)="handleImageError($event)">
          </ion-avatar>
          <ion-button class="upload-button" fill="clear" (click)="fileInput.click()">
            <ion-icon slot="icon-only" name="camera-outline"></ion-icon>
          </ion-button>
          <input #fileInput type="file" accept="image/*" style="display: none" (change)="onImageSelected($event)">
        </div>
        <div class="profile-info">
          <h1>{{ employeeData?.FullName || user?.name }}</h1>
          <p>{{ employeeData?.WorkEmail || user?.email }}</p>
          <ion-badge [color]="employeeData?.EmploymentStatus === 'Active' ? 'success' : 'medium'">
            {{ employeeData?.EmploymentStatus || 'Active' }}
          </ion-badge>
        </div>
      </ion-card>

      <!-- User Information -->
      <ion-card>
        <ion-card-content>
          <!-- View Mode -->
          <ion-list lines="none" *ngIf="!isEditMode">
            <ion-item>
              <ion-icon slot="start" name="person-outline" color="primary"></ion-icon>
              <ion-label>
                <p>Full Name</p>
                <h3>{{ employeeData?.FullName || user?.name }}</h3>
              </ion-label>
            </ion-item>

            <ion-item *ngIf="employeeData?.EmployeeNumber">
              <ion-icon slot="start" name="card-outline" color="primary"></ion-icon>
              <ion-label>
                <p>Employee Number</p>
                <h3>{{ employeeData?.EmployeeNumber }}</h3>
              </ion-label>
            </ion-item>

            <ion-item>
              <ion-icon slot="start" name="mail-outline" color="primary"></ion-icon>
              <ion-label>
                <p>Work Email</p>
                <h3>{{ employeeData?.WorkEmail || user?.email }}</h3>
              </ion-label>
            </ion-item>

            <ion-item *ngIf="employeeData?.PersonalEmail">
              <ion-icon slot="start" name="mail-outline" color="primary"></ion-icon>
              <ion-label>
                <p>Personal Email</p>
                <h3>{{ employeeData?.PersonalEmail }}</h3>
              </ion-label>
            </ion-item>

            <ion-item *ngIf="employeeData?.DateOfBirth">
              <ion-icon slot="start" name="calendar-outline" color="primary"></ion-icon>
              <ion-label>
                <p>Date of Birth</p>
                <h3>{{ employeeData?.DateOfBirth | date:'MMM d, y' }}</h3>
              </ion-label>
            </ion-item>

            <ion-item *ngIf="employeeData?.Gender">
              <ion-icon slot="start" name="person-outline" color="primary"></ion-icon>
              <ion-label>
                <p>Gender</p>
                <h3>{{ employeeData?.Gender }}</h3>
              </ion-label>
            </ion-item>

            <ion-item *ngIf="employeeData?.BloodGroup">
              <ion-icon slot="start" name="water-outline" color="primary"></ion-icon>
              <ion-label>
                <p>Blood Group</p>
                <h3>{{ employeeData?.BloodGroup }}</h3>
              </ion-label>
            </ion-item>

            <ion-item *ngIf="employeeData?.MaritalStatus">
              <ion-icon slot="start" name="heart-outline" color="primary"></ion-icon>
              <ion-label>
                <p>Marital Status</p>
                <h3>{{ employeeData?.MaritalStatus }}</h3>
              </ion-label>
            </ion-item>

            <ion-item *ngIf="employeeData?.department_name">
              <ion-icon slot="start" name="business-outline" color="primary"></ion-icon>
              <ion-label>
                <p>Department</p>
                <h3>{{ employeeData?.department_name }}</h3>
              </ion-label>
            </ion-item>

            <ion-item *ngIf="employeeData?.designation_name">
              <ion-icon slot="start" name="briefcase-outline" color="primary"></ion-icon>
              <ion-label>
                <p>Designation</p>
                <h3>{{ employeeData?.designation_name }}</h3>
              </ion-label>
            </ion-item>

            <ion-item *ngIf="employeeData?.location_name">
              <ion-icon slot="start" name="location-outline" color="primary"></ion-icon>
              <ion-label>
                <p>Location</p>
                <h3>{{ employeeData?.location_name }}</h3>
              </ion-label>
            </ion-item>

            <ion-item *ngIf="user?.role">
              <ion-icon slot="start" name="shield-outline" color="primary"></ion-icon>
              <ion-label>
                <p>Role</p>
                <h3>{{ user?.role | titlecase }}</h3>
              </ion-label>
            </ion-item>
          </ion-list>

          <!-- Edit Mode -->
          <form [formGroup]="profileForm" *ngIf="isEditMode">
            <ion-list lines="full">
              <ion-item>
                <ion-input 
                  label="Personal Email" 
                  labelPlacement="floating"
                  type="email"
                  formControlName="PersonalEmail">
                </ion-input>
              </ion-item>

              <ion-item>
                <ion-input 
                  label="Date of Birth" 
                  labelPlacement="floating"
                  type="date"
                  formControlName="DateOfBirth">
                </ion-input>
              </ion-item>

              <ion-item>
                <ion-input 
                  label="Gender" 
                  labelPlacement="floating"
                  formControlName="Gender"
                  placeholder="Male/Female/Other">
                </ion-input>
              </ion-item>

              <ion-item>
                <ion-input 
                  label="Blood Group" 
                  labelPlacement="floating"
                  formControlName="BloodGroup"
                  placeholder="A+, B+, O+, etc.">
                </ion-input>
              </ion-item>

              <ion-item>
                <ion-input 
                  label="Marital Status" 
                  labelPlacement="floating"
                  formControlName="MaritalStatus"
                  placeholder="Single/Married">
                </ion-input>
              </ion-item>

              <div class="section-header">
                <h3>Current Address</h3>
              </div>

              <ion-item>
                <ion-input 
                  label="Address Line 1" 
                  labelPlacement="floating"
                  formControlName="current_address_line1">
                </ion-input>
              </ion-item>

              <ion-item>
                <ion-input 
                  label="Address Line 2" 
                  labelPlacement="floating"
                  formControlName="current_address_line2">
                </ion-input>
              </ion-item>

              <ion-item>
                <ion-input 
                  label="City" 
                  labelPlacement="floating"
                  formControlName="current_city">
                </ion-input>
              </ion-item>

              <ion-item>
                <ion-input 
                  label="State" 
                  labelPlacement="floating"
                  formControlName="current_state">
                </ion-input>
              </ion-item>

              <ion-item>
                <ion-input 
                  label="Zip Code" 
                  labelPlacement="floating"
                  formControlName="current_zip">
                </ion-input>
              </ion-item>

              <ion-item>
                <ion-input 
                  label="Country" 
                  labelPlacement="floating"
                  formControlName="current_country">
                </ion-input>
              </ion-item>

              <div class="section-header">
                <h3>Family Information</h3>
              </div>

              <ion-item>
                <ion-input 
                  label="Father's Name" 
                  labelPlacement="floating"
                  formControlName="father_name">
                </ion-input>
              </ion-item>

              <ion-item>
                <ion-input 
                  label="Mother's Name" 
                  labelPlacement="floating"
                  formControlName="mother_name">
                </ion-input>
              </ion-item>

              <ion-item>
                <ion-input 
                  label="Spouse Name" 
                  labelPlacement="floating"
                  formControlName="spouse_name">
                </ion-input>
              </ion-item>
            </ion-list>
          </form>
        </ion-card-content>
      </ion-card>

      <!-- Menu Options -->
      <ion-card>
        <ion-card-content>
          <ion-list>
            <ion-item 
              *ngFor="let item of menuItems" 
              button 
              detail="true"
              (click)="handleMenuClick(item.action)">
              <ion-icon 
                slot="start" 
                [name]="item.icon" 
                [color]="item.color || 'primary'">
              </ion-icon>
              <ion-label [color]="item.color">{{ item.label }}</ion-label>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>
    </div>
  </div>
</ion-content>
