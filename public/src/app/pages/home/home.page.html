<ion-header class="ion-no-border">
  <ion-toolbar class="header-toolbar">
    <ion-title class="header-title">
      <div class="title-content">
        <h1>Dashboard</h1>
        <p class="subtitle">Welcome back, {{ user?.name || 'User' }}!</p>
      </div>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="goToNotifications()">
        <ion-icon slot="icon-only" name="notifications-outline" class="notification-icon"></ion-icon>
        <ion-badge color="danger" class="notification-badge">3</ion-badge>
      </ion-button>
      <ion-button fill="clear" (click)="goToProfile()">
        <ion-avatar class="header-avatar">
          <img [src]="getProfileImageUrl()" 
               alt="Profile" 
               (error)="handleImageError($event)">
        </ion-avatar>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="dashboard-content">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="dashboard-wrapper">
    <!-- Top Statistics Cards -->
    <div class="stats-row">
      <div class="stat-card stat-primary">
        <div class="stat-icon">
          <ion-icon name="time-outline"></ion-icon>
        </div>
        <div class="stat-content">
          <p class="stat-label">Work Hours</p>
          <h2 class="stat-value">{{ stats.workHours }}</h2>
          <p class="stat-change positive">+2.5% from last week</p>
        </div>
      </div>

      <div class="stat-card stat-success">
        <div class="stat-icon">
          <ion-icon name="checkmark-circle-outline"></ion-icon>
        </div>
        <div class="stat-content">
          <p class="stat-label">Attendance Rate</p>
          <h2 class="stat-value">{{ stats.attendanceRate }}%</h2>
          <p class="stat-change positive">+5% this month</p>
        </div>
      </div>

      <div class="stat-card stat-warning">
        <div class="stat-icon">
          <ion-icon name="calendar-outline"></ion-icon>
        </div>
        <div class="stat-content">
          <p class="stat-label">Leaves Used</p>
          <h2 class="stat-value">{{ stats.leavesUsed | number:'1.0-0' }}/20</h2>
          <p class="stat-change neutral">{{ (20 - stats.leavesUsed) | number:'1.0-0' }} remaining</p>
        </div>
      </div>

      <div class="stat-card stat-info">
        <div class="stat-icon">
          <ion-icon name="hourglass-outline"></ion-icon>
        </div>
        <div class="stat-content">
          <p class="stat-label">Pending</p>
          <h2 class="stat-value">{{ stats.leavesPending }}</h2>
          <p class="stat-change neutral">Leave requests</p>
        </div>
      </div>
    </div>

    <!-- Attendance Card -->
    <ion-card class="attendance-card">
      <div class="card-header">
        <div class="header-left">
          <h2>Today's Attendance</h2>
          <p class="date-display">{{ currentTime }}</p>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <ion-badge [color]="todayAttendance ? 'success' : 'medium'">
            {{ todayAttendance ? 'Checked In' : 'Not Checked In' }}
          </ion-badge>
          <ion-button fill="clear" size="small" (click)="navigateTo('attendance')">
            <ion-icon name="eye-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
      </div>
      
      <div class="attendance-time-section">
        <div class="time-display">
          <div class="time-item">
            <ion-icon name="log-in-outline" class="time-icon in"></ion-icon>
            <div>
              <p class="time-label">Check In</p>
              <h3 class="time-value">{{ formattedCheckIn }}</h3>
            </div>
          </div>
          
          <div class="time-divider"></div>
          
          <div class="time-item">
            <ion-icon name="log-out-outline" class="time-icon out"></ion-icon>
            <div>
              <p class="time-label">Check Out</p>
              <h3 class="time-value">{{ formattedCheckOut }}</h3>
            </div>
          </div>
          
          <div class="time-divider"></div>
          
          <div class="time-item">
            <ion-icon name="time-outline" class="time-icon total"></ion-icon>
            <div>
              <p class="time-label">Total Hours</p>
              <h3 class="time-value">{{ stats.workHours }}</h3>
            </div>
          </div>
        </div>

        <div class="action-buttons">
          <ion-button expand="block" class="check-btn check-in-btn" 
            *ngIf="canPunchIn" 
            [disabled]="isLoading"
            (click)="punchIn()">
            <ion-icon name="log-in-outline" slot="start"></ion-icon>
            Punch In
          </ion-button>
          <ion-button expand="block" class="check-btn check-out-btn" 
            *ngIf="canPunchOut" 
            [disabled]="isLoading"
            (click)="punchOut()">
            <ion-icon name="log-out-outline" slot="start"></ion-icon>
            Punch Out
          </ion-button>
          <div class="quick-action-btns" *ngIf="todayAttendance">
            <ion-button fill="outline" size="small" (click)="navigateTo('leave-request')">
              <ion-icon name="document-text-outline" slot="start"></ion-icon>
              Apply Leave
            </ion-button>
            <ion-button fill="outline" size="small" (click)="navigateTo('timesheets')">
              <ion-icon name="time-outline" slot="start"></ion-icon>
              Timesheet
            </ion-button>
          </div>
        </div>
      </div>
    </ion-card>

    <!-- Main Grid Layout -->
    <div class="content-grid">
      <!-- Left Column -->
      <div class="grid-left">
        <!-- Quick Actions -->
        <ion-card class="quick-actions-card">
          <ion-card-header>
            <ion-card-title>Quick Actions</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="action-grid">
              <div class="action-item" (click)="navigateTo('attendance')">
                <div class="action-icon primary">
                  <ion-icon name="time-outline"></ion-icon>
                </div>
                <p>Attendance</p>
              </div>
              <div class="action-item" (click)="navigateTo('leaves')">
                <div class="action-icon success">
                  <ion-icon name="calendar-outline"></ion-icon>
                </div>
                <p>Leave</p>
              </div>
              <div class="action-item" (click)="navigateTo('team')">
                <div class="action-icon warning">
                  <ion-icon name="people-outline"></ion-icon>
                </div>
                <p>Team</p>
              </div>
              <div class="action-item" (click)="navigateTo('payroll')">
                <div class="action-icon info">
                  <ion-icon name="document-text-outline"></ion-icon>
                </div>
                <p>Payslip</p>
              </div>
            </div>
            
            <!-- Admin Quick Actions -->
            <div class="action-grid admin-actions" *ngIf="isAdmin">
              <div class="action-item" (click)="navigateTo('admin/dashboard')">
                <div class="action-icon danger">
                  <ion-icon name="shield-outline"></ion-icon>
                </div>
                <p>Admin Panel</p>
              </div>
              <div class="action-item" (click)="navigateTo('admin/bulk-upload')">
                <div class="action-icon secondary">
                  <ion-icon name="cloud-upload-outline"></ion-icon>
                </div>
                <p>Bulk Upload</p>
              </div>
              <div class="action-item" (click)="navigateTo('admin/master-data')">
                <div class="action-icon tertiary">
                  <ion-icon name="settings-outline"></ion-icon>
                </div>
                <p>Master Data</p>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Announcements -->
        <ion-card class="announcements-card">
          <ion-card-header>
            <div class="card-header-with-action">
              <ion-card-title>
                <ion-icon name="megaphone-outline"></ion-icon>
                Announcements
              </ion-card-title>
              <ion-button fill="clear" size="small">
                View All
                <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
              </ion-button>
            </div>
          </ion-card-header>
          <ion-card-content>
            <div class="announcement-list" *ngIf="announcements.length > 0">
              <div class="announcement-item" *ngFor="let announcement of announcements">
                <div class="announcement-dot"></div>
                <div class="announcement-content">
                  <p class="announcement-title">{{ announcement.title }}</p>
                  <p class="announcement-message">{{ announcement.message }}</p>
                  <p class="announcement-time">
                    <ion-icon name="time-outline"></ion-icon>
                    {{ formatAnnouncementDate(announcement.created_at) }}
                  </p>
                </div>
              </div>
            </div>
            <div class="empty-state" *ngIf="announcements.length === 0">
              <ion-icon name="megaphone-outline"></ion-icon>
              <p>No announcements yet</p>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Attendance Chart -->
        <ion-card class="chart-card">
          <ion-card-header>
            <div class="card-header-with-action">
              <ion-card-title>Attendance Overview</ion-card-title>
              <ion-badge color="success">+6% improvement</ion-badge>
            </div>
          </ion-card-header>
          <ion-card-content>
            <div class="simple-chart">
              <div class="chart-bar" style="height: 60%">
                <span class="bar-value">60%</span>
              </div>
              <div class="chart-bar" style="height: 80%">
                <span class="bar-value">80%</span>
              </div>
              <div class="chart-bar" style="height: 70%">
                <span class="bar-value">70%</span>
              </div>
              <div class="chart-bar" style="height: 90%">
                <span class="bar-value">90%</span>
              </div>
              <div class="chart-bar" style="height: 75%">
                <span class="bar-value">75%</span>
              </div>
              <div class="chart-bar" style="height: 85%">
                <span class="bar-value">85%</span>
              </div>
              <div class="chart-bar" style="height: 95%">
                <span class="bar-value">95%</span>
              </div>
            </div>
            <div class="chart-labels">
              <span>Mon</span>
              <span>Tue</span>
              <span>Wed</span>
              <span>Thu</span>
              <span>Fri</span>
              <span>Sat</span>
              <span>Sun</span>
            </div>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Right Column -->
      <div class="grid-right">
        <!-- Leave Balance -->
        <ion-card class="leave-card">
          <ion-card-header>
            <div class="card-header-with-action">
              <ion-card-title>
                <ion-icon name="calendar-outline"></ion-icon>
                Leave Balance
              </ion-card-title>
              <ion-button fill="clear" size="small" (click)="navigateTo('leaves')">
                View All
              </ion-button>
            </div>
          </ion-card-header>
          <ion-card-content>
            <div class="leave-grid" *ngIf="leaveBalances.length > 0; else noLeaveData">
              <div class="leave-type-item" *ngFor="let leave of leaveBalances">
                <div class="leave-icon" [ngClass]="{
                  'primary': leave.type_code === 'AL' || leave.type_code === 'PL',
                  'success': leave.type_code === 'SL' || leave.type_code === 'ML',
                  'warning': leave.type_code === 'CL',
                  'danger': leave.type_code === 'LWP' || leave.type_code === 'UL'
                }">
                  <ion-icon [name]="getLeaveIcon(leave.type_code)"></ion-icon>
                </div>
                <div class="leave-info">
                  <p class="leave-count">{{ leave.used_days || 0 }}<span>/{{ leave.allocated_days || 0 }}</span></p>
                  <p class="leave-name">{{ leave.type_name || leave.leave_type_name }}</p>
                  <p class="leave-remaining">{{ leave.available_days || 0 }} remaining</p>
                </div>
              </div>
            </div>
            <ng-template #noLeaveData>
              <div class="leave-grid">
                <div class="leave-type-item">
                  <div class="leave-icon primary">
                    <ion-icon name="sunny-outline"></ion-icon>
                  </div>
                  <div class="leave-info">
                    <p class="leave-count">-- <span>/--</span></p>
                    <p class="leave-name">No leave data</p>
                  </div>
                </div>
              </div>
            </ng-template>
          </ion-card-content>
        </ion-card>

        <!-- Upcoming Events -->
        <ion-card class="events-card">
          <ion-card-header>
            <div class="card-header-with-action">
              <ion-card-title>
                <ion-icon name="balloon-outline"></ion-icon>
                Today's Birthdays
              </ion-card-title>
            </div>
          </ion-card-header>
          <ion-card-content>
            <div class="event-list" *ngIf="birthdays.length > 0">
              <div class="event-item birthday" *ngFor="let birthday of birthdays">
                <ion-avatar class="birthday-avatar">
                  <img [src]="birthday.ProfilePicture || 'assets/avatar-placeholder.png'" 
                       [alt]="birthday.FirstName + ' ' + birthday.LastName"
                       (error)="handleImageError($event)">
                </ion-avatar>
                <div class="event-details">
                  <p class="event-title">{{ birthday.FirstName }} {{ birthday.LastName }}</p>
                  <p class="event-type">
                    <ion-icon name="balloon-outline"></ion-icon>
                    {{ formatBirthdayDate(birthday.DateOfBirth) }}
                  </p>
                  <p class="event-email">{{ birthday.WorkEmail }}</p>
                </div>
                <div class="birthday-actions">
                  <ion-button fill="clear" size="small" (click)="viewBirthdayWishes(birthday)">
                    <ion-icon name="eye-outline" slot="icon-only"></ion-icon>
                  </ion-button>
                  <ion-button fill="clear" size="small" (click)="sendBirthdayWish(birthday)">
                    <ion-icon name="send-outline" slot="icon-only"></ion-icon>
                  </ion-button>
                </div>
              </div>
            </div>
            <div class="empty-state" *ngIf="birthdays.length === 0">
              <ion-icon name="balloon-outline"></ion-icon>
              <p>No birthdays today</p>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Team Members -->
        <ion-card class="team-card" *ngIf="teamMembers.length > 0">
          <ion-card-header>
            <div class="card-header-with-action">
              <ion-card-title>
                <ion-icon name="people-outline"></ion-icon>
                {{ teamInfo?.type === 'reporting_team' ? 'My Team' : 'Team Members' }}
              </ion-card-title>
              <ion-button fill="clear" size="small" (click)="navigateTo('employees')">
                View All
              </ion-button>
            </div>
          </ion-card-header>
          <ion-card-content>
            <div class="team-list">
              <div class="team-member" *ngFor="let member of teamMembers.slice(0, 5)">
                <ion-avatar class="member-avatar">
                  <img [src]="getTeamMemberImageUrl(member)" 
                       [alt]="member.FirstName + ' ' + member.LastName" 
                       (error)="handleImageError($event)">
                </ion-avatar>
                <div class="member-info">
                  <p class="member-name">{{ member.FirstName }} {{ member.LastName }}</p>
                  <p class="member-role">{{ member.designation_name || member.DesignationName || 'Employee' }}</p>
                </div>
                <ion-badge color="success">
                  Active
                </ion-badge>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
      </div>
    </div>
  </div>

  <!-- HR/Admin FAB Button for Adding Announcements -->
  <ion-fab slot="fixed" vertical="bottom" horizontal="end" *ngIf="isHR">
    <ion-fab-button (click)="addAnnouncement()">
      <ion-icon name="add-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>
