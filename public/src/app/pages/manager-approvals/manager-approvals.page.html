<ion-header>
  <ion-toolbar>
    <ion-title>Manager Approvals</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="approvals-container">
    <!-- Segment Control -->
    <ion-segment [value]="selectedSegment" (ionChange)="segmentChanged($event)">
      <ion-segment-button value="leaves">
        <ion-icon name="calendar-outline"></ion-icon>
        <ion-label>Leave Requests</ion-label>
      </ion-segment-button>
      <ion-segment-button value="wfh">
        <ion-icon name="home-outline"></ion-icon>
        <ion-label>WFH Requests</ion-label>
      </ion-segment-button>
      <ion-segment-button value="timesheets">
        <ion-icon name="time-outline"></ion-icon>
        <ion-label>Timesheets</ion-label>
      </ion-segment-button>
      <ion-segment-button value="attendance">
        <ion-icon name="checkmark-circle-outline"></ion-icon>
        <ion-label>Attendance</ion-label>
      </ion-segment-button>
    </ion-segment>

    <!-- Pending Leaves -->
    <div *ngIf="selectedSegment === 'leaves'">
      <div class="section-header">
        <h3>Pending Leave Requests</h3>
        <ion-badge color="warning">{{ pendingLeaves.length }}</ion-badge>
      </div>

      <ion-card *ngIf="pendingLeaves.length === 0">
        <ion-card-content class="empty-state">
          <ion-icon name="checkmark-circle-outline" size="large" color="success"></ion-icon>
          <p>No pending leave requests</p>
        </ion-card-content>
      </ion-card>

      <ion-card *ngFor="let leave of pendingLeaves" class="approval-card">
        <ion-card-header>
          <div class="card-header-content">
            <div>
              <ion-card-title>{{ leave.FirstName }} {{ leave.LastName }}</ion-card-title>
              <p class="employee-details">{{ leave.EmployeeNumber }} • {{ leave.WorkEmail }}</p>
            </div>
            <ion-badge color="primary">{{ leave.type_name }}</ion-badge>
          </div>
        </ion-card-header>
        <ion-card-content>
          <div class="leave-details">
            <div class="detail-row">
              <ion-icon name="calendar-outline"></ion-icon>
              <span><strong>Period:</strong> {{ leave.start_date | date:'MMM d' }} - {{ leave.end_date | date:'MMM d, y' }}</span>
            </div>
            <div class="detail-row">
              <ion-icon name="time-outline"></ion-icon>
              <span><strong>Duration:</strong> {{ leave.total_days }} day(s)</span>
            </div>
            <div class="detail-row">
              <ion-icon name="document-text-outline"></ion-icon>
              <span><strong>Reason:</strong> {{ leave.reason }}</span>
            </div>
            <div class="detail-row">
              <ion-icon name="calendar-outline"></ion-icon>
              <span><strong>Applied:</strong> {{ leave.applied_at | date:'MMM d, y h:mm a' }}</span>
            </div>
          </div>

          <div class="action-buttons">
            <ion-button 
              expand="block" 
              color="success" 
              (click)="approveLeave(leave)"
              [disabled]="isLoading">
              <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
              Approve
            </ion-button>
            <ion-button 
              expand="block" 
              color="danger" 
              fill="outline"
              (click)="rejectLeave(leave)"
              [disabled]="isLoading">
              <ion-icon slot="start" name="close-circle-outline"></ion-icon>
              Reject
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Pending WFH Requests -->
    <div *ngIf="selectedSegment === 'wfh'">
      <div class="section-header">
        <h3>Pending WFH/Remote Requests</h3>
        <ion-badge color="warning">{{ pendingWFH.length }}</ion-badge>
      </div>

      <ion-card *ngIf="pendingWFH.length === 0">
        <ion-card-content class="empty-state">
          <ion-icon name="checkmark-circle-outline" size="large" color="success"></ion-icon>
          <p>No pending WFH/Remote requests</p>
        </ion-card-content>
      </ion-card>

      <ion-card *ngFor="let request of pendingWFH" class="approval-card">
        <ion-card-header>
          <div class="card-header-content">
            <div>
              <ion-card-title>{{ request.FirstName }} {{ request.LastName }}</ion-card-title>
              <p class="employee-details">{{ request.EmployeeNumber }}</p>
            </div>
            <ion-badge [color]="request.leave_type === 'WFH' ? 'success' : 'tertiary'">{{ request.leave_type }}</ion-badge>
          </div>
        </ion-card-header>
        <ion-card-content>
          <div class="leave-details">
            <div class="detail-row">
              <ion-icon name="calendar-outline"></ion-icon>
              <span><strong>Date:</strong> {{ request.start_date | date:'MMM d, y (EEEE)' }}</span>
            </div>
            <div class="detail-row">
              <ion-icon name="home-outline"></ion-icon>
              <span><strong>Work Mode:</strong> {{ request.leave_type }}</span>
            </div>
            <div class="detail-row" *ngIf="request.reason">
              <ion-icon name="document-text-outline"></ion-icon>
              <span><strong>Reason:</strong> {{ request.reason }}</span>
            </div>
            <div class="detail-row">
              <ion-icon name="time-outline"></ion-icon>
              <span><strong>Applied:</strong> {{ request.applied_at | date:'MMM d, y h:mm a' }}</span>
            </div>
          </div>

          <div class="action-buttons">
            <ion-button 
              expand="block" 
              color="success" 
              (click)="approveWFH(request)"
              [disabled]="isLoading">
              <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
              Approve
            </ion-button>
            <ion-button 
              expand="block" 
              color="danger" 
              fill="outline"
              (click)="rejectWFH(request)"
              [disabled]="isLoading">
              <ion-icon slot="start" name="close-circle-outline"></ion-icon>
              Reject
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Pending Timesheets -->
    <div *ngIf="selectedSegment === 'timesheets'">
      <div class="section-header">
        <h3>Pending Timesheets</h3>
        <ion-badge color="warning">{{ pendingTimesheets.length }}</ion-badge>
      </div>

      <ion-card *ngIf="pendingTimesheets.length === 0">
        <ion-card-content class="empty-state">
          <ion-icon name="checkmark-circle-outline" size="large" color="success"></ion-icon>
          <p>No pending timesheets</p>
        </ion-card-content>
      </ion-card>

      <ion-card *ngFor="let timesheet of pendingTimesheets" class="approval-card">
        <ion-card-header>
          <div class="card-header-content">
            <div>
              <ion-card-title>{{ timesheet.FirstName }} {{ timesheet.LastName }}</ion-card-title>
              <p class="employee-details">{{ timesheet.EmployeeNumber }} • {{ timesheet.WorkEmail }}</p>
            </div>
            <ion-badge [color]="timesheet.timesheet_type === 'project' ? 'primary' : 'secondary'">
              {{ timesheet.timesheet_type | titlecase }}
            </ion-badge>
          </div>
        </ion-card-header>
        <ion-card-content>
          <div class="timesheet-details">
            <div class="detail-row">
              <ion-icon name="calendar-outline"></ion-icon>
              <span><strong>Date:</strong> {{ timesheet.date | date:'MMM d, y' }}</span>
            </div>
            <div class="detail-row">
              <ion-icon name="time-outline"></ion-icon>
              <span><strong>Hours:</strong> {{ timesheet.total_hours }}h</span>
            </div>
            <div class="detail-row" *ngIf="timesheet.project_name">
              <ion-icon name="briefcase-outline"></ion-icon>
              <span><strong>Project:</strong> {{ timesheet.project_name }} ({{ timesheet.project_code }})</span>
            </div>
            <div class="detail-row" *ngIf="timesheet.work_description">
              <ion-icon name="document-text-outline"></ion-icon>
              <span><strong>Description:</strong> {{ timesheet.work_description }}</span>
            </div>
            <div class="detail-row">
              <ion-icon name="calendar-outline"></ion-icon>
              <span><strong>Submitted:</strong> {{ timesheet.submission_date | date:'MMM d, y h:mm a' }}</span>
            </div>
          </div>

          <div class="action-buttons">
            <ion-button 
              expand="block" 
              color="success" 
              (click)="approveTimesheet(timesheet)"
              [disabled]="isLoading">
              <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
              Approve
            </ion-button>
            <ion-button 
              expand="block" 
              color="danger" 
              fill="outline"
              (click)="rejectTimesheet(timesheet)"
              [disabled]="isLoading">
              <ion-icon slot="start" name="close-circle-outline"></ion-icon>
              Reject
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Team Attendance Report -->
    <div *ngIf="selectedSegment === 'attendance'">
      <div class="section-header">
        <h3>
          <ion-icon name="analytics-outline"></ion-icon>
          Team Attendance Report
        </h3>
        <div style="display: flex; gap: 8px; align-items: center;">
          <ion-button size="small" fill="clear" (click)="toggleDebugInfo()">
            <ion-icon name="bug-outline" slot="icon-only"></ion-icon>
          </ion-button>
          <ion-datetime 
            [(ngModel)]="selectedDate" 
            (ionChange)="onDateChange($event)"
            presentation="date"
            [max]="maxDate"
            size="small">
          </ion-datetime>
        </div>
      </div>

      <!-- Debug Info Panel -->
      <ion-card *ngIf="showDebugInfo" style="background: #f0f0f0;">
        <ion-card-header>
          <ion-card-title style="font-size: 14px;">Debug Info</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <pre style="font-size: 11px; overflow-x: auto;">{{ getDebugData() | json }}</pre>
        </ion-card-content>
      </ion-card>

      <!-- Loading State -->
      <ion-card *ngIf="isLoadingAttendance">
        <ion-card-content class="empty-state">
          <ion-icon name="hourglass-outline" size="large" color="primary"></ion-icon>
          <p>Loading attendance data...</p>
        </ion-card-content>
      </ion-card>

      <!-- Summary Cards -->
      <div class="summary-grid" *ngIf="!isLoadingAttendance && teamAttendance?.summary">
        <ion-card class="summary-card" [style.background]="'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'">
          <ion-card-content>
            <ion-icon name="people-outline" style="font-size: 24px; color: white; opacity: 0.8;"></ion-icon>
            <div class="summary-value" style="color: white;">{{ teamAttendance.summary.total_team || 0 }}</div>
            <div class="summary-label" style="color: rgba(255,255,255,0.9);">Total Team</div>
          </ion-card-content>
        </ion-card>
        <ion-card class="summary-card present" [style.background]="'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)'">
          <ion-card-content>
            <ion-icon name="checkmark-circle" style="font-size: 24px; color: white; opacity: 0.8;"></ion-icon>
            <div class="summary-value" style="color: white;">{{ teamAttendance.summary.present || 0 }}</div>
            <div class="summary-label" style="color: rgba(255,255,255,0.9);">Present</div>
          </ion-card-content>
        </ion-card>
        <ion-card class="summary-card absent" [style.background]="'linear-gradient(135deg, #eb3349 0%, #f45c43 100%)'">
          <ion-card-content>
            <ion-icon name="close-circle" style="font-size: 24px; color: white; opacity: 0.8;"></ion-icon>
            <div class="summary-value" style="color: white;">{{ teamAttendance.summary.absent || 0 }}</div>
            <div class="summary-label" style="color: rgba(255,255,255,0.9);">Absent</div>
          </ion-card-content>
        </ion-card>
        <ion-card class="summary-card on-leave" [style.background]="'linear-gradient(135deg, #f7971e 0%, #ffd200 100%)'">
          <ion-card-content>
            <ion-icon name="calendar" style="font-size: 24px; color: white; opacity: 0.8;"></ion-icon>
            <div class="summary-value" style="color: white;">{{ teamAttendance.summary.on_leave || 0 }}</div>
            <div class="summary-label" style="color: rgba(255,255,255,0.9);">On Leave</div>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Empty State for No Team -->
      <ion-card *ngIf="!isLoadingAttendance && teamAttendance && teamAttendance.summary && teamAttendance.summary.total_team === 0">
        <ion-card-content class="empty-state">
          <ion-icon name="people-outline" size="large" color="medium"></ion-icon>
          <p><strong>No team members found</strong></p>
          <small>You need team members reporting to you to view attendance. Please contact HR if this is incorrect.</small>
        </ion-card-content>
      </ion-card>

      <!-- Empty State for No Attendance -->
      <ion-card *ngIf="!isLoadingAttendance && teamAttendance && teamAttendance.summary && teamAttendance.summary.total_team > 0 && (!teamAttendance.attendance || teamAttendance.attendance.length === 0)">
        <ion-card-content class="empty-state">
          <ion-icon name="calendar-outline" size="large" color="medium"></ion-icon>
          <p>No attendance records for {{ selectedDate | date:'MMM d, y' }}</p>
          <small>Your {{ teamAttendance.summary.total_team }} team members haven't marked attendance yet for this date</small>
        </ion-card-content>
      </ion-card>

      <!-- Attendance List -->
      <div *ngIf="!isLoadingAttendance && teamAttendance?.attendance && teamAttendance.attendance.length > 0">
        <div class="section-header">
          <h3>Attendance Details ({{ teamAttendance.attendance.length }} records)</h3>
        </div>
        <ion-card *ngFor="let record of teamAttendance.attendance" class="approval-card">
        <ion-card-header>
          <div class="card-header-content">
            <div>
              <ion-card-title>{{ record.FirstName }} {{ record.LastName }}</ion-card-title>
              <p class="employee-details">{{ record.EmployeeNumber }}</p>
            </div>
            <ion-badge [color]="getAttendanceStatusColor(record.status)">
              <ion-icon [name]="getAttendanceStatusIcon(record.status)" slot="start"></ion-icon>
              {{ record.status | titlecase }}
            </ion-badge>
          </div>
        </ion-card-header>
        <ion-card-content>
          <div class="leave-details">
            <div class="detail-row" *ngIf="record.check_in_time">
              <ion-icon name="time-outline" color="success"></ion-icon>
              <span><strong>Check In:</strong> {{ record.check_in_time | date:'h:mm a' }}</span>
            </div>
            <div class="detail-row" *ngIf="record.check_out_time">
              <ion-icon name="time-outline" color="danger"></ion-icon>
              <span><strong>Check Out:</strong> {{ record.check_out_time | date:'h:mm a' }}</span>
            </div>
            <div class="detail-row" *ngIf="record.work_hours">
              <ion-icon name="hourglass-outline"></ion-icon>
              <span><strong>Work Hours:</strong> {{ record.work_hours }}h</span>
            </div>
            <div class="detail-row" *ngIf="record.work_mode">
              <ion-icon name="location-outline"></ion-icon>
              <span><strong>Mode:</strong> {{ record.work_mode }}</span>
            </div>
            <div class="detail-row" *ngIf="record.total_punches">
              <ion-icon name="finger-print-outline"></ion-icon>
              <span><strong>Total Punches:</strong> {{ record.total_punches }}</span>
            </div>
          </div>
        </ion-card-content>
      </ion-card>
      </div>
    </div>


  </div>
</ion-content>
