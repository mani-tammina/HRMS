<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/admin"></ion-back-button>
    </ion-buttons>
    <ion-title>Analytics Dashboard</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="page-container">
    <!-- View Selector -->
    <ion-segment [(ngModel)]="selectedView" (ionChange)="onViewChange($event)">
      <ion-segment-button value="overview">
        <ion-label>Overview</ion-label>
      </ion-segment-button>
      <ion-segment-button value="attendance">
        <ion-label>Attendance</ion-label>
      </ion-segment-button>
      <ion-segment-button value="leaves">
        <ion-label>Leaves</ion-label>
      </ion-segment-button>
      <ion-segment-button value="timesheets">
        <ion-label>Timesheets</ion-label>
      </ion-segment-button>
    </ion-segment>

    <!-- Period Selector (not shown for overview) -->
    @if (selectedView !== 'overview') {
      <ion-card class="period-card">
        <ion-card-content>
          <ion-select [(ngModel)]="selectedPeriod" (ionChange)="onPeriodChange($event)" interface="popover">
            <ion-select-option value="week">Last 7 Days</ion-select-option>
            <ion-select-option value="month">Last 30 Days</ion-select-option>
            <ion-select-option value="quarter">Last 3 Months</ion-select-option>
          </ion-select>
        </ion-card-content>
      </ion-card>
    }

    @if (isLoading) {
      <app-loading message="Loading analytics..." type="spinner"></app-loading>
    }

    <!-- Overview Tab -->
    @if (!isLoading && selectedView === 'overview' && adminDashboard) {
      <ion-grid>
        <ion-row>
          <ion-col size="6" sizeMd="3">
            <app-stat-card
              title="Total Employees"
              [value]="adminDashboard.total_employees"
              icon="people-outline"
              iconColor="primary">
            </app-stat-card>
          </ion-col>
          <ion-col size="6" sizeMd="3">
            <app-stat-card
              title="Active"
              [value]="adminDashboard.active_employees"
              [subtitle]="adminDashboard.on_leave_today + ' on leave today'"
              icon="checkmark-circle-outline"
              iconColor="success">
            </app-stat-card>
          </ion-col>
          <ion-col size="6" sizeMd="3">
            <app-stat-card
              title="Present Today"
              [value]="adminDashboard.present_today"
              [subtitle]="adminDashboard.attendance_rate + '% rate'"
              icon="calendar-outline"
              iconColor="primary">
            </app-stat-card>
          </ion-col>
          <ion-col size="6" sizeMd="3">
            <app-stat-card
              title="Avg Work Hours"
              [value]="adminDashboard.avg_work_hours + 'h'"
              icon="time-outline"
              iconColor="tertiary">
            </app-stat-card>
          </ion-col>
        </ion-row>
      </ion-grid>

      <ion-grid>
        <ion-row>
          <ion-col size="6" sizeMd="4">
            <app-stat-card
              title="Active Projects"
              [value]="adminDashboard.active_projects"
              icon="briefcase-outline"
              iconColor="primary">
            </app-stat-card>
          </ion-col>
          <ion-col size="6" sizeMd="4">
            <app-stat-card
              title="Pending Leaves"
              [value]="adminDashboard.pending_leaves"
              icon="document-text-outline"
              iconColor="warning">
            </app-stat-card>
          </ion-col>
          <ion-col size="6" sizeMd="4">
            <app-stat-card
              title="Pending Timesheets"
              [value]="adminDashboard.pending_timesheets"
              icon="time-outline"
              iconColor="warning">
            </app-stat-card>
          </ion-col>
        </ion-row>
      </ion-grid>

      <ion-grid>
        <ion-row>
          <ion-col size="6">
            <app-stat-card
              title="Recent Joinings"
              [value]="adminDashboard.recent_joinings"
              subtitle="This month"
              icon="person-add-outline"
              iconColor="success">
            </app-stat-card>
          </ion-col>
          <ion-col size="6">
            <app-stat-card
              title="Upcoming Birthdays"
              [value]="adminDashboard.upcoming_birthdays"
              subtitle="Next 7 days"
              icon="gift-outline"
              iconColor="tertiary">
            </app-stat-card>
          </ion-col>
        </ion-row>
      </ion-grid>
    }

    <!-- Attendance Analytics Tab -->
    @if (!isLoading && selectedView === 'attendance' && attendanceAnalytics) {
      <ion-grid>
        <ion-row>
          <ion-col size="6" sizeMd="3">
            <app-stat-card
              title="Working Days"
              [value]="attendanceAnalytics.overall_stats.total_working_days"
              icon="calendar-outline"
              iconColor="primary">
            </app-stat-card>
          </ion-col>
          <ion-col size="6" sizeMd="3">
            <app-stat-card
              title="Attendance Rate"
              [value]="attendanceAnalytics.overall_stats.avg_attendance_rate + '%'"
              icon="trending-up-outline"
              iconColor="success">
            </app-stat-card>
          </ion-col>
          <ion-col size="6" sizeMd="3">
            <app-stat-card
              title="Present"
              [value]="attendanceAnalytics.overall_stats.total_present"
              icon="checkmark-circle-outline"
              iconColor="success">
            </app-stat-card>
          </ion-col>
          <ion-col size="6" sizeMd="3">
            <app-stat-card
              title="Late Arrivals"
              [value]="attendanceAnalytics.overall_stats.total_late"
              icon="time-outline"
              iconColor="warning">
            </app-stat-card>
          </ion-col>
        </ion-row>
      </ion-grid>

      <!-- Department-wise Attendance -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>Department-wise Attendance</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          @for (dept of attendanceAnalytics.department_wise; track dept.department) {
            <div class="analytics-row">
              <div class="row-info">
                <span class="row-label">{{ dept.department }}</span>
                <span class="row-value">{{ dept.attendance_rate }}%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="dept.attendance_rate"></div>
              </div>
            </div>
          }
        </ion-card-content>
      </ion-card>

      <!-- Work Mode Distribution -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>Work Mode Distribution</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="distribution-grid">
            @for (mode of attendanceAnalytics.work_mode_distribution; track mode.work_mode) {
              <div class="distribution-item">
                <div class="item-label">{{ mode.work_mode }}</div>
                <div class="item-value">{{ mode.count }}</div>
                <div class="item-percentage">{{ mode.percentage }}%</div>
              </div>
            }
          </div>
        </ion-card-content>
      </ion-card>
    }

    <!-- Leave Analytics Tab -->
    @if (!isLoading && selectedView === 'leaves' && leaveAnalytics) {
      <ion-grid>
        <ion-row>
          <ion-col size="6" sizeMd="3">
            <app-stat-card
              title="Total Leaves"
              [value]="leaveAnalytics.overall_stats.total_leaves"
              icon="calendar-outline"
              iconColor="primary">
            </app-stat-card>
          </ion-col>
          <ion-col size="6" sizeMd="3">
            <app-stat-card
              title="Approved"
              [value]="leaveAnalytics.overall_stats.approved_leaves"
              icon="checkmark-circle-outline"
              iconColor="success">
            </app-stat-card>
          </ion-col>
          <ion-col size="6" sizeMd="3">
            <app-stat-card
              title="Pending"
              [value]="leaveAnalytics.overall_stats.pending_leaves"
              icon="time-outline"
              iconColor="warning">
            </app-stat-card>
          </ion-col>
          <ion-col size="6" sizeMd="3">
            <app-stat-card
              title="Rejected"
              [value]="leaveAnalytics.overall_stats.rejected_leaves"
              icon="close-circle-outline"
              iconColor="danger">
            </app-stat-card>
          </ion-col>
        </ion-row>
      </ion-grid>

      <!-- Leave Type Distribution -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>Leave Type Distribution</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          @for (type of leaveAnalytics.leave_type_distribution; track type.leave_type) {
            <div class="analytics-row">
              <div class="row-info">
                <span class="row-label">{{ type.leave_type }}</span>
                <span class="row-value">{{ type.count }} ({{ type.percentage }}%)</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="type.percentage"></div>
              </div>
            </div>
          }
        </ion-card-content>
      </ion-card>
    }

    <!-- Timesheet Analytics Tab -->
    @if (!isLoading && selectedView === 'timesheets' && timesheetAnalytics) {
      <ion-grid>
        <ion-row>
          <ion-col size="6" sizeMd="3">
            <app-stat-card
              title="Total Submissions"
              [value]="timesheetAnalytics.overall_stats.total_submissions"
              icon="document-text-outline"
              iconColor="primary">
            </app-stat-card>
          </ion-col>
          <ion-col size="6" sizeMd="3">
            <app-stat-card
              title="Avg Hours/Day"
              [value]="timesheetAnalytics.overall_stats.avg_hours_per_day + 'h'"
              icon="time-outline"
              iconColor="tertiary">
            </app-stat-card>
          </ion-col>
          <ion-col size="6" sizeMd="3">
            <app-stat-card
              title="Total Hours"
              [value]="timesheetAnalytics.overall_stats.total_hours + 'h'"
              icon="trending-up-outline"
              iconColor="success">
            </app-stat-card>
          </ion-col>
          <ion-col size="6" sizeMd="3">
            <app-stat-card
              title="Compliance Rate"
              [value]="timesheetAnalytics.overall_stats.compliance_rate + '%'"
              icon="checkmark-circle-outline"
              iconColor="success">
            </app-stat-card>
          </ion-col>
        </ion-row>
      </ion-grid>

      <!-- Project-wise Hours -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>Project-wise Hours</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          @for (project of timesheetAnalytics.project_wise_hours; track project.project_name) {
            <div class="project-row">
              <div class="project-info">
                <div class="project-name">{{ project.project_name }}</div>
                <div class="project-meta">{{ project.employee_count }} employees</div>
              </div>
              <div class="project-hours">{{ project.total_hours }}h</div>
            </div>
          }
        </ion-card-content>
      </ion-card>
    }

    <!-- Pull to Refresh -->
    <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
      <ion-refresher-content></ion-refresher-content>
    </ion-refresher>
  </div>
</ion-content>
