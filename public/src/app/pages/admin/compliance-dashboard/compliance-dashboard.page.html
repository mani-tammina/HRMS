<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/admin"></ion-back-button>
    </ion-buttons>
    <ion-title>Compliance Dashboard</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="loadDashboard()">
        <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button (click)="exportReport()">
        <ion-icon name="download-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar>
    <ion-segment [(ngModel)]="selectedSegment" (ionChange)="deselectAll()">
      <ion-segment-button value="overview">
        <ion-label>Overview</ion-label>
      </ion-segment-button>
      <ion-segment-button value="non-compliant">
        <ion-label>Non-Compliant</ion-label>
        <ion-badge *ngIf="dashboard?.today?.non_compliant_count" color="danger">
          {{ dashboard?.today?.non_compliant_count }}
        </ion-badge>
      </ion-segment-button>
      <ion-segment-button value="trends">
        <ion-label>Trends</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <app-loading *ngIf="isLoading"></app-loading>

  <div *ngIf="!isLoading && dashboard">
    <!-- Overview Segment -->
    <div *ngIf="selectedSegment === 'overview'" class="segment-content">
      <!-- Today's Stats -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="stats-chart-outline"></ion-icon>
            Today's Compliance
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-grid>
            <ion-row>
              <ion-col size="6" size-md="3">
                <div class="stat-box">
                  <div class="stat-value">{{ dashboard?.today?.total_employees }}</div>
                  <div class="stat-label">Total Employees</div>
                </div>
              </ion-col>
              <ion-col size="6" size-md="3">
                <div class="stat-box">
                  <div class="stat-value success">{{ dashboard?.today?.submitted_count }}</div>
                  <div class="stat-label">
                    <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
                    Submitted
                  </div>
                </div>
              </ion-col>
              <ion-col size="6" size-md="3">
                <div class="stat-box">
                  <div class="stat-value danger">{{ dashboard?.today?.non_compliant_count }}</div>
                  <div class="stat-label">
                    <ion-icon name="alert-circle-outline" color="danger"></ion-icon>
                    Pending
                  </div>
                </div>
              </ion-col>
              <ion-col size="6" size-md="3">
                <div class="stat-box">
                  <div class="stat-value" 
                       [class]="getComplianceRateColor(dashboard?.today?.compliance_rate || 0)">
                    {{ dashboard?.today?.compliance_rate?.toFixed(1) }}%
                  </div>
                  <div class="stat-label">Compliance Rate</div>
                </div>
              </ion-col>
            </ion-row>
          </ion-grid>

          <div class="progress-bar">
            <div class="progress-fill success" 
                 [style.width.%]="dashboard?.today?.compliance_rate || 0">
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Weekly Stats -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="time-outline"></ion-icon>
            This Week
            <ion-icon 
              [name]="getTrendIcon(dashboard?.weekly_trends || [])" 
              [color]="getTrendColor(dashboard?.weekly_trends || [])"
              class="trend-icon">
            </ion-icon>
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-grid>
            <ion-row>
              <ion-col size="6" size-md="3">
                <div class="stat-box">
                  <div class="stat-value">{{ dashboard?.this_week?.avg_compliance_rate?.toFixed(1) }}%</div>
                  <div class="stat-label">Avg Compliance</div>
                </div>
              </ion-col>
              <ion-col size="6" size-md="3">
                <div class="stat-box">
                  <div class="stat-value">{{ dashboard?.this_week?.total_submitted }}</div>
                  <div class="stat-label">Total Submitted</div>
                </div>
              </ion-col>
              <ion-col size="6" size-md="3">
                <div class="stat-box">
                  <div class="stat-value">{{ dashboard?.this_week?.reminders_sent }}</div>
                  <div class="stat-label">Reminders Sent</div>
                </div>
              </ion-col>
              <ion-col size="6" size-md="3">
                <div class="stat-box">
                  <div class="stat-value">{{ dashboard?.this_week?.auto_reminders }}</div>
                  <div class="stat-label">Auto Reminders</div>
                </div>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-card-content>
      </ion-card>

      <!-- Monthly Stats -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="stats-chart-outline"></ion-icon>
            This Month
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-grid>
            <ion-row>
              <ion-col size="6" size-md="4">
                <div class="stat-box">
                  <div class="stat-value">{{ dashboard?.this_month?.working_days }}</div>
                  <div class="stat-label">Working Days</div>
                </div>
              </ion-col>
              <ion-col size="6" size-md="4">
                <div class="stat-box">
                  <div class="stat-value success">{{ dashboard?.this_month?.completed_days }}</div>
                  <div class="stat-label">Days Compliant</div>
                </div>
              </ion-col>
              <ion-col size="12" size-md="4">
                <div class="stat-box">
                  <div class="stat-value" 
                       [class]="getComplianceRateColor(dashboard?.this_month?.avg_compliance_rate || 0)">
                    {{ dashboard?.this_month?.avg_compliance_rate?.toFixed(1) }}%
                  </div>
                  <div class="stat-label">Monthly Avg</div>
                </div>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-card-content>
      </ion-card>

      <!-- Pending Actions -->
      <ion-card *ngIf="dashboard?.pending_validations?.count && dashboard.pending_validations.count > 0">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="alert-circle-outline" color="warning"></ion-icon>
            Pending Validations
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list>
            <ion-item *ngFor="let item of dashboard?.pending_validations?.items">
              <ion-label>
                <h3>{{ item.type === 'timesheet' ? 'Timesheet' : 'Client Upload' }}</h3>
                <p>{{ item.employee_name }} - {{ item.date }}</p>
              </ion-label>
              <ion-badge slot="end" color="warning">Pending</ion-badge>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <!-- Quick Actions -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>Quick Actions</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-grid>
            <ion-row>
              <ion-col size="12" size-md="6">
                <ion-button 
                  expand="block" 
                  (click)="sendReminders()"
                  [disabled]="!dashboard?.today?.non_compliant_count || dashboard.today.non_compliant_count === 0">
                  <ion-icon name="send-outline" slot="start"></ion-icon>
                  Send Reminders ({{ dashboard?.today?.non_compliant_count || 0 }})
                </ion-button>
              </ion-col>
              <ion-col size="12" size-md="6">
                <ion-button 
                  expand="block" 
                  color="secondary"
                  (click)="closeMonth()">
                  <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
                  Close Month
                </ion-button>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Non-Compliant Segment -->
    <div *ngIf="selectedSegment === 'non-compliant'" class="segment-content">
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="people-outline"></ion-icon>
            Non-Compliant Employees ({{ dashboard?.today?.non_compliant_count || 0 }})
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-searchbar 
            [(ngModel)]="searchTerm"
            placeholder="Search by name, emp number, or department"
            debounce="300">
          </ion-searchbar>

          <div class="bulk-actions" *ngIf="filteredNonCompliant.length > 0">
            <ion-button 
              size="small" 
              (click)="selectAll()" 
              [disabled]="selectedEmployees.length === filteredNonCompliant.length">
              Select All
            </ion-button>
            <ion-button 
              size="small" 
              fill="outline"
              (click)="deselectAll()"
              [disabled]="selectedEmployees.length === 0">
              Deselect All
            </ion-button>
            <ion-button 
              size="small" 
              color="primary"
              (click)="sendReminders(selectedEmployees)"
              [disabled]="selectedEmployees.length === 0">
              <ion-icon name="send-outline" slot="start"></ion-icon>
              Send Reminders ({{ selectedEmployees.length }})
            </ion-button>
          </div>

          <ion-list *ngIf="filteredNonCompliant.length > 0">
            <ion-item *ngFor="let emp of filteredNonCompliant">
              <ion-checkbox 
                slot="start" 
                [checked]="isEmployeeSelected(emp.id)"
                (ionChange)="toggleEmployeeSelection(emp.id)">
              </ion-checkbox>
              <ion-label>
                <h3>{{ emp.name }}</h3>
                <p>{{ emp.EmployeeNumber }} â€¢ {{ emp.department }}</p>
                <p class="text-small text-muted">
                  Last reminder: {{ emp.last_reminder_sent || 'Never' }}
                </p>
              </ion-label>
              <div slot="end" class="reminder-info">
                <ion-badge color="warning">{{ emp.reminder_count || 0 }} reminders</ion-badge>
              </div>
            </ion-item>
          </ion-list>

          <div *ngIf="filteredNonCompliant.length === 0" class="empty-state">
            <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
            <p>All employees are compliant!</p>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Trends Segment -->
    <div *ngIf="selectedSegment === 'trends'" class="segment-content">
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="trending-up-outline"></ion-icon>
            Weekly Compliance Trends
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="trend-chart">
            <div *ngFor="let day of dashboard?.weekly_trends" class="trend-day">
              <div class="trend-bar-container">
                <div class="trend-bar" 
                     [style.height.%]="day.rate"
                     [class]="getComplianceRateColor(day.rate)">
                </div>
              </div>
              <div class="trend-label">
                <div class="trend-date">{{ day.date | date:'EEE' }}</div>
                <div class="trend-rate">{{ day.rate.toFixed(0) }}%</div>
                <div class="trend-count text-small">{{ day.submitted }}/{{ day.total }}</div>
              </div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="stats-chart-outline"></ion-icon>
            Reminder Statistics
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list>
            <ion-item>
              <ion-label>Total Reminders Sent</ion-label>
              <ion-badge slot="end">{{ dashboard?.this_week?.reminders_sent || 0 }}</ion-badge>
            </ion-item>
            <ion-item>
              <ion-label>Automated Reminders</ion-label>
              <ion-badge slot="end" color="primary">{{ dashboard?.this_week?.auto_reminders || 0 }}</ion-badge>
            </ion-item>
            <ion-item>
              <ion-label>Manual Reminders</ion-label>
              <ion-badge slot="end" color="secondary">
                {{ (dashboard?.this_week?.reminders_sent || 0) - (dashboard?.this_week?.auto_reminders || 0) }}
              </ion-badge>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>
    </div>
  </div>

  <div *ngIf="!isLoading && !dashboard" class="empty-state">
    <ion-icon name="alert-circle-outline" color="warning"></ion-icon>
    <p>No compliance data available</p>
  </div>
</ion-content>
