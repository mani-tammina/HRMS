<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/admin/projects"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ projectId ? 'Project Details' : 'New Project' }}</ion-title>
    <ion-buttons slot="end">
      @if (projectId) {
        <ion-button (click)="showEditModal = true">
          <ion-icon name="create-outline" slot="icon-only"></ion-icon>
        </ion-button>
        <ion-button color="danger" (click)="deleteProject()">
          <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
        </ion-button>
      }
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  @if (isLoading) {
    <app-loading type="spinner"></app-loading>
  } @else if (!project && !projectId) {
    <ion-card>
      <ion-card-content>
        <div class="empty-state">
          <ion-icon name="briefcase-outline" style="font-size: 64px; color: var(--ion-color-medium);"></ion-icon>
          <p>Create a new project</p>
          <ion-button (click)="showEditModal = true">
            <ion-icon name="add-outline" slot="start"></ion-icon>
            Create Project
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>
  } @else if (project) {
    <!-- Segment Control -->
    <ion-segment [(ngModel)]="selectedSegment">
      <ion-segment-button value="details">
        <ion-label>Details</ion-label>
      </ion-segment-button>
      <ion-segment-button value="shifts">
        <ion-label>Shifts</ion-label>
      </ion-segment-button>
      <ion-segment-button value="team">
        <ion-label>Team</ion-label>
      </ion-segment-button>
    </ion-segment>

    <!-- Details Tab -->
    @if (selectedSegment === 'details') {
      <ion-card>
        <ion-card-header>
          <ion-card-title>{{ project.project_name }}</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list>
            <ion-item>
              <ion-label>
                <h3>Project Code</h3>
                <p>{{ project.project_code }}</p>
              </ion-label>
            </ion-item>

            <ion-item>
              <ion-label>
                <h3>Client</h3>
                <p>{{ project.client_name }}</p>
              </ion-label>
            </ion-item>

            <ion-item>
              <ion-label>
                <h3>Status</h3>
                <p><ion-badge [color]="getStatusColor(project.status)">{{ project.status }}</ion-badge></p>
              </ion-label>
            </ion-item>

            <ion-item>
              <ion-label>
                <h3>Duration</h3>
                <p>{{ formatDate(project.start_date) }} - {{ formatDate(project.end_date) }}</p>
              </ion-label>
            </ion-item>

            @if (project.description) {
              <ion-item>
                <ion-label>
                  <h3>Description</h3>
                  <p>{{ project.description }}</p>
                </ion-label>
              </ion-item>
            }
          </ion-list>
        </ion-card-content>
      </ion-card>
    }

    <!-- Shifts Tab -->
    @if (selectedSegment === 'shifts') {
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            Project Shifts
            <ion-button size="small" (click)="showShiftModal = true">
              <ion-icon name="add-outline" slot="start"></ion-icon>
              Add Shift
            </ion-button>
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          @if (project.shifts && project.shifts.length > 0) {
            <ion-list>
              @for (shift of project.shifts; track shift.id) {
                <ion-item>
                  <ion-label>
                    <h3>{{ shift.shift_name }}</h3>
                    <p>{{ shift.start_time }} - {{ shift.end_time }} ({{ shift.timezone }})</p>
                    <p><ion-badge>{{ shift.shift_type }}</ion-badge></p>
                  </ion-label>
                </ion-item>
              }
            </ion-list>
          } @else {
            <div class="empty-state">
              <p>No shifts configured</p>
              <ion-button size="small" (click)="showShiftModal = true">
                <ion-icon name="add-outline" slot="start"></ion-icon>
                Add First Shift
              </ion-button>
            </div>
          }
        </ion-card-content>
      </ion-card>
    }

    <!-- Team Tab -->
    @if (selectedSegment === 'team') {
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            Team Members
            <ion-button size="small" (click)="showAssignModal = true">
              <ion-icon name="person-add-outline" slot="start"></ion-icon>
              Assign Employee
            </ion-button>
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          @if (project.assignments && project.assignments.length > 0) {
            <ion-list>
              @for (assignment of project.assignments; track assignment.id) {
                <ion-item>
                  <ion-label>
                    <h3>{{ assignment.employee_name || 'Unknown' }}</h3>
                    <p>{{ assignment.role_in_project }}</p>
                    <p>Allocation: {{ assignment.allocation_percentage }}%</p>
                    <p>{{ formatDate(assignment.assignment_start_date) }} - {{ formatDate(assignment.assignment_end_date) }}</p>
                  </ion-label>
                </ion-item>
              }
            </ion-list>
          } @else {
            <div class="empty-state">
              <p>No team members assigned</p>
              <ion-button size="small" (click)="showAssignModal = true">
                <ion-icon name="person-add-outline" slot="start"></ion-icon>
                Assign First Employee
              </ion-button>
            </div>
          }
        </ion-card-content>
      </ion-card>
    }
  }

  <!-- Project Edit Modal -->
  <ion-modal [isOpen]="showEditModal" (didDismiss)="showEditModal = false">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>{{ projectId ? 'Edit Project' : 'New Project' }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="showEditModal = false">Close</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <form [formGroup]="projectForm">
          <ion-list>
            <ion-item>
              <ion-label position="stacked">Project Code *</ion-label>
              <ion-input type="text" formControlName="project_code" placeholder="e.g., PRJ-001"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Project Name *</ion-label>
              <ion-input type="text" formControlName="project_name" placeholder="Enter project name"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Client Name *</ion-label>
              <ion-input type="text" formControlName="client_name" placeholder="Enter client name"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Status *</ion-label>
              <ion-select formControlName="status">
                <ion-select-option value="active">Active</ion-select-option>
                <ion-select-option value="completed">Completed</ion-select-option>
                <ion-select-option value="on_hold">On Hold</ion-select-option>
                <ion-select-option value="cancelled">Cancelled</ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Start Date *</ion-label>
              <ion-input type="date" formControlName="start_date"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">End Date</ion-label>
              <ion-input type="date" formControlName="end_date"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Description</ion-label>
              <ion-textarea formControlName="description" rows="4" placeholder="Project description"></ion-textarea>
            </ion-item>
          </ion-list>

          <div style="padding: 16px;">
            <ion-button expand="block" (click)="saveProject()">
              <ion-icon name="save-outline" slot="start"></ion-icon>
              Save Project
            </ion-button>
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Shift Modal -->
  <ion-modal [isOpen]="showShiftModal" (didDismiss)="showShiftModal = false">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Add Shift</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="showShiftModal = false">Close</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <form [formGroup]="shiftForm">
          <ion-list>
            <ion-item>
              <ion-label position="stacked">Shift Name *</ion-label>
              <ion-input type="text" formControlName="shift_name" placeholder="e.g., Morning Shift"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Shift Type *</ion-label>
              <ion-select formControlName="shift_type">
                <ion-select-option value="day">Day</ion-select-option>
                <ion-select-option value="night">Night</ion-select-option>
                <ion-select-option value="flexible">Flexible</ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Start Time *</ion-label>
              <ion-input type="time" formControlName="start_time"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">End Time *</ion-label>
              <ion-input type="time" formControlName="end_time"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Timezone *</ion-label>
              <ion-input type="text" formControlName="timezone" placeholder="e.g., UTC, IST"></ion-input>
            </ion-item>
          </ion-list>

          <div style="padding: 16px;">
            <ion-button expand="block" (click)="saveShift()">
              <ion-icon name="save-outline" slot="start"></ion-icon>
              Add Shift
            </ion-button>
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Assignment Modal -->
  <ion-modal [isOpen]="showAssignModal" (didDismiss)="showAssignModal = false">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Assign Employee</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="showAssignModal = false">Close</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <form [formGroup]="assignForm">
          <ion-list>
            <ion-item>
              <ion-label position="stacked">Employee *</ion-label>
              <ion-select formControlName="employee_id" placeholder="Select Employee">
                @for (emp of employees; track emp.id) {
                  <ion-select-option [value]="emp.id">
                    {{ emp.name }} ({{ emp.email }})
                  </ion-select-option>
                }
              </ion-select>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Role in Project *</ion-label>
              <ion-input type="text" formControlName="role_in_project" placeholder="e.g., Developer, Designer"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Allocation Percentage *</ion-label>
              <ion-input type="number" formControlName="allocation_percentage" min="0" max="100" placeholder="0-100"></ion-input>
            </ion-item>

            @if (project?.shifts && (project?.shifts?.length || 0) > 0) {
              <ion-item>
                <ion-label position="stacked">Shift</ion-label>
                <ion-select formControlName="shift_id" placeholder="Select Shift (Optional)">
                  @for (shift of project?.shifts; track shift.id) {
                    <ion-select-option [value]="shift.id">
                      {{ shift.shift_name }} ({{ shift.start_time }} - {{ shift.end_time }})
                    </ion-select-option>
                  }
                </ion-select>
              </ion-item>
            }

            <ion-item>
              <ion-label position="stacked">Assignment Start Date *</ion-label>
              <ion-input type="date" formControlName="assignment_start_date"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Assignment End Date</ion-label>
              <ion-input type="date" formControlName="assignment_end_date"></ion-input>
            </ion-item>
          </ion-list>

          <div style="padding: 16px;">
            <ion-button expand="block" (click)="assignEmployee()">
              <ion-icon name="person-add-outline" slot="start"></ion-icon>
              Assign Employee
            </ion-button>
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
