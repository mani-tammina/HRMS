<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/admin/assets"></ion-back-button>
    </ion-buttons>
    <ion-title>Asset Allocation</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="page-container">
    <!-- Segment Control -->
    <ion-segment [(ngModel)]="selectedView" (ionChange)="onViewChange($event)">
      <ion-segment-button value="allocate">
        <ion-label>Allocate</ion-label>
      </ion-segment-button>
      <ion-segment-button value="active">
        <ion-label>Active ({{ activeAllocations.length }})</ion-label>
      </ion-segment-button>
      <ion-segment-button value="return">
        <ion-label>Return</ion-label>
      </ion-segment-button>
    </ion-segment>

    <!-- Allocate View -->
    @if (selectedView === 'allocate') {
      <ion-card>
        <ion-card-header>
          <ion-card-title>Allocate Asset to Employee</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <form [formGroup]="allocationForm">
            <ion-item>
              <ion-label position="stacked">Asset *</ion-label>
              <ion-select formControlName="asset_id" placeholder="Select Asset">
                @for (asset of availableAssets; track asset.id) {
                  <ion-select-option [value]="asset.id">
                    {{ asset.asset_name }} ({{ asset.asset_tag }})
                  </ion-select-option>
                }
              </ion-select>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Employee *</ion-label>
              <ion-select formControlName="employee_id" placeholder="Select Employee">
                @for (emp of employees; track emp.id) {
                  <ion-select-option [value]="emp.id">
                    {{ emp.name }} ({{ emp.email }})
                  </ion-select-option>
                }
              </ion-select>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Allocation Date *</ion-label>
              <ion-input type="date" formControlName="allocation_date"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Expected Return Date</ion-label>
              <ion-input type="date" formControlName="expected_return_date"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Notes</ion-label>
              <ion-textarea formControlName="allocation_notes" rows="3" placeholder="Any special notes..."></ion-textarea>
            </ion-item>

            <div class="button-container">
              <ion-button expand="block" (click)="allocateAsset()" [disabled]="allocationForm.invalid">
                <ion-icon slot="start" name="checkmark-done-outline"></ion-icon>
                Allocate Asset
              </ion-button>
            </div>
          </form>
        </ion-card-content>
      </ion-card>
    }

    <!-- Active Allocations View -->
    @if (selectedView === 'active') {
      @if (activeAllocations.length === 0) {
        <ion-card>
          <ion-card-content class="empty-state">
            <ion-icon name="cube-outline" size="large"></ion-icon>
            <h3>No Active Allocations</h3>
            <p>All assets are currently available</p>
          </ion-card-content>
        </ion-card>
      } @else {
        @for (allocation of activeAllocations; track allocation.id) {
          <ion-card class="allocation-card">
            <ion-card-header>
              <div class="allocation-header">
                <ion-card-title>{{ allocation.asset_name }}</ion-card-title>
                <ion-badge [color]="getStatusColor(allocation.allocation_status)">
                  {{ allocation.allocation_status | titlecase }}
                </ion-badge>
              </div>
            </ion-card-header>
            <ion-card-content>
              <div class="allocation-details">
                <div class="detail-row">
                  <span class="label">Employee:</span>
                  <span class="value">{{ allocation.employee_name }} ({{ allocation.employee_code }})</span>
                </div>
                <div class="detail-row">
                  <span class="label">Asset Tag:</span>
                  <span class="value">{{ allocation.asset_tag }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Allocated:</span>
                  <span class="value">{{ formatDate(allocation.allocation_date) }}</span>
                </div>
                @if (allocation.expected_return_date) {
                  <div class="detail-row">
                    <span class="label">Expected Return:</span>
                    <span class="value">{{ formatDate(allocation.expected_return_date) }}</span>
                  </div>
                }
                @if (allocation.allocation_notes) {
                  <div class="detail-row">
                    <span class="label">Notes:</span>
                    <span class="value">{{ allocation.allocation_notes }}</span>
                  </div>
                }
              </div>
              <ion-button expand="block" fill="outline" (click)="selectAllocationForReturn(allocation)">
                <ion-icon slot="start" name="arrow-back-outline"></ion-icon>
                Process Return
              </ion-button>
            </ion-card-content>
          </ion-card>
        }
      }
    }

    <!-- Return View -->
    @if (selectedView === 'return') {
      @if (!selectedAllocation) {
        <ion-card>
          <ion-card-content class="empty-state">
            <ion-icon name="arrow-back-outline" size="large"></ion-icon>
            <h3>Select an Asset to Return</h3>
            <p>Go to Active tab and click "Process Return" on any allocation</p>
          </ion-card-content>
        </ion-card>
      } @else {
        <ion-card>
          <ion-card-header>
            <ion-card-title>Return Asset</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="return-info">
              <div class="info-row">
                <span class="label">Asset:</span>
                <span class="value">{{ selectedAllocation.asset_name }}</span>
              </div>
              <div class="info-row">
                <span class="label">Employee:</span>
                <span class="value">{{ selectedAllocation.employee_name }}</span>
              </div>
              <div class="info-row">
                <span class="label">Allocated Since:</span>
                <span class="value">{{ formatDate(selectedAllocation.allocation_date) }}</span>
              </div>
            </div>

            <form [formGroup]="returnForm">
              <ion-item>
                <ion-label position="stacked">Return Condition *</ion-label>
                <ion-select formControlName="return_condition">
                  <ion-select-option value="new">New</ion-select-option>
                  <ion-select-option value="good">Good</ion-select-option>
                  <ion-select-option value="fair">Fair</ion-select-option>
                  <ion-select-option value="poor">Poor</ion-select-option>
                  <ion-select-option value="damaged">Damaged</ion-select-option>
                </ion-select>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Return Notes</ion-label>
                <ion-textarea formControlName="return_notes" rows="4" placeholder="Condition details, any issues..."></ion-textarea>
              </ion-item>

              <div class="button-container">
                <ion-button expand="block" (click)="returnAsset()" [disabled]="returnForm.invalid">
                  <ion-icon slot="start" name="checkmark-done-outline"></ion-icon>
                  Confirm Return
                </ion-button>
              </div>
            </form>
          </ion-card-content>
        </ion-card>
      }
    }
  </div>
</ion-content>
