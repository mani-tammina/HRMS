<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/admin/leave-plans"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ plan.name || 'Leave Plan Details' }}</ion-title>
    <ion-buttons slot="end">
      <ion-button *ngIf="!isEditing" (click)="toggleEdit()">
        <ion-icon slot="icon-only" name="create-outline"></ion-icon>
      </ion-button>
      <ion-button *ngIf="isEditing" (click)="savePlan()" [disabled]="isSaving">
        <ion-icon slot="icon-only" name="save-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p>Loading plan details...</p>
  </div>

  <div *ngIf="!isLoading">
    <!-- Basic Info -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Basic Information</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item>
            <ion-input 
              label="Plan Name" 
              labelPlacement="stacked"
              [(ngModel)]="plan.name"
              [readonly]="!isEditing"
              placeholder="Enter plan name">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-textarea 
              label="Description" 
              labelPlacement="stacked"
              [(ngModel)]="plan.description"
              [readonly]="!isEditing"
              rows="3"
              placeholder="Enter description">
            </ion-textarea>
          </ion-item>

          <ion-item>
            <ion-select 
              label="Leave Year Start Month" 
              labelPlacement="stacked"
              [(ngModel)]="plan.leave_year_start_month"
              [disabled]="!isEditing">
              <ion-select-option *ngFor="let month of months" [value]="month.value">
                {{ month.name }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-input 
              label="Leave Year Start Day" 
              labelPlacement="stacked"
              type="number"
              [(ngModel)]="plan.leave_year_start_day"
              [readonly]="!isEditing"
              min="1"
              max="31"
              placeholder="1-31">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-toggle 
              [(ngModel)]="plan.is_active"
              [disabled]="!isEditing">
              Active Status
            </ion-toggle>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Leave Allocations -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          Leave Allocations
          <ion-button 
            *ngIf="isEditing" 
            fill="clear" 
            size="small" 
            (click)="addAllocation()">
            <ion-icon slot="start" name="add-outline"></ion-icon>
            Add
          </ion-button>
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div *ngIf="!plan.allocations || plan.allocations.length === 0" class="empty-message">
          <p>No allocations added yet</p>
          <ion-button *ngIf="isEditing" (click)="addAllocation()">
            <ion-icon slot="start" name="add-outline"></ion-icon>
            Add Allocation
          </ion-button>
        </div>

        <ion-list *ngIf="plan.allocations && plan.allocations.length > 0">
          <ion-item *ngFor="let allocation of plan.allocations; let i = index">
            <div class="allocation-item">
              <div class="allocation-row">
                <ion-select 
                  label="Leave Type"
                  labelPlacement="stacked"
                  [(ngModel)]="allocation.leave_type_id"
                  [disabled]="!isEditing"
                  class="allocation-select">
                  <ion-select-option *ngFor="let type of leaveTypes" [value]="type.id">
                    {{ type.type_name }} ({{ type.type_code }})
                  </ion-select-option>
                </ion-select>

                <ion-input 
                  label="Days"
                  labelPlacement="stacked"
                  type="number"
                  [(ngModel)]="allocation.days_allocated"
                  [readonly]="!isEditing"
                  min="0"
                  class="allocation-input">
                </ion-input>
              </div>

              <div class="allocation-row">
                <ion-toggle 
                  [(ngModel)]="allocation.prorate_on_joining"
                  [disabled]="!isEditing">
                  Prorate on Joining
                </ion-toggle>

                <ion-button 
                  *ngIf="isEditing" 
                  fill="clear" 
                  color="danger" 
                  size="small"
                  (click)="removeAllocation(i)">
                  <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                </ion-button>
              </div>

              <div *ngIf="!isEditing && allocation.type_name" class="readonly-info">
                <p><strong>{{ allocation.type_name }}</strong> ({{ allocation.type_code }})</p>
                <ion-badge color="primary">{{ allocation.days_allocated }} days</ion-badge>
                <ion-badge *ngIf="allocation.prorate_on_joining" color="secondary">Prorated</ion-badge>
              </div>
            </div>
          </ion-item>
        </ion-list>

        <ion-button 
          expand="block" 
          fill="outline" 
          (click)="goToLeaveTypes()"
          style="margin-top: 16px;">
          Manage Leave Types
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Save Button -->
    <div *ngIf="isEditing" class="save-section">
      <ion-button expand="block" color="primary" (click)="savePlan()" [disabled]="isSaving">
        <ion-icon slot="start" name="save-outline"></ion-icon>
        {{ isSaving ? 'Saving...' : 'Save Changes' }}
      </ion-button>
      <ion-button expand="block" fill="outline" (click)="toggleEdit()">
        Cancel
      </ion-button>
    </div>
  </div>
</ion-content>
