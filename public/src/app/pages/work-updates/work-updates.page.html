<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Project Work Updates</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Active Projects Section -->
  <ion-card *ngIf="projects.length > 0">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="briefcase-outline"></ion-icon>
        Active Projects
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-list>
        <ion-item *ngFor="let project of projects">
          <ion-label>
            <h2>{{ project.project_name }}</h2>
            <p>Client: {{ project.client_name }}</p>
            <p>Shift: {{ project.shift_name }} ({{ project.shift_type }})</p>
            <p class="shift-time">{{ project.start_time }} - {{ project.end_time }}</p>
          </ion-label>
          <ion-badge slot="end" color="primary">Active</ion-badge>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>

  <!-- No Projects Message -->
  <ion-card *ngIf="projects.length === 0">
    <ion-card-content class="text-center">
      <ion-icon name="alert-circle-outline" size="large" color="warning"></ion-icon>
      <h2>No Active Projects</h2>
      <p>You are not currently assigned to any projects.</p>
    </ion-card-content>
  </ion-card>

  <!-- Recent Work Updates -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="document-text-outline"></ion-icon>
        Recent Work Updates
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-list *ngIf="workUpdates.length > 0">
        <ion-item *ngFor="let update of workUpdates">
          <ion-label>
            <h2>{{ update.project_name }}</h2>
            <p>{{ update.update_date | date:'mediumDate' }} - {{ update.hours_worked }} hours</p>
            <p class="description">{{ update.work_description | slice:0:100 }}...</p>
            <div class="chips">
              <ion-chip [color]="getStatusColor(update.status)">
                <ion-label>{{ update.status }}</ion-label>
              </ion-chip>
              <ion-chip color="success" *ngIf="update.timesheet_id">
                <ion-icon name="checkmark-circle-outline"></ion-icon>
                <ion-label>Timesheet Uploaded</ion-label>
              </ion-chip>
              <ion-chip color="tertiary" *ngIf="update.is_verified">
                <ion-icon name="checkmark-circle-outline"></ion-icon>
                <ion-label>Verified</ion-label>
              </ion-chip>
            </div>
          </ion-label>
          <div slot="end" class="action-buttons">
            <ion-button fill="clear" size="small" *ngIf="update.timesheet_id" 
                        (click)="downloadTimesheet(update.timesheet_id!)">
              <ion-icon name="cloud-upload-outline"></ion-icon>
            </ion-button>
            <ion-button fill="clear" size="small" color="danger" 
                        *ngIf="update.status === 'draft'" 
                        (click)="deleteUpdate(update.id)">
              <ion-icon name="close-circle-outline"></ion-icon>
            </ion-button>
          </div>
        </ion-item>
      </ion-list>

      <div *ngIf="workUpdates.length === 0" class="text-center">
        <p>No work updates found</p>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- FAB for New Update -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button (click)="openSubmitModal()">
      <ion-icon name="add-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- Submit Work Update Modal -->
  <ion-modal [isOpen]="showSubmitModal" (didDismiss)="showSubmitModal = false">
    <ng-template>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-title>Submit Work Update</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="showSubmitModal = false">Close</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <form>
          <!-- Project Selection -->
          <ion-item>
            <ion-label position="stacked">Project *</ion-label>
            <ion-select [(ngModel)]="updateForm.projectId" 
                        name="projectId"
                        (ionChange)="onProjectChange($event)"
                        placeholder="Select project">
              <ion-select-option *ngFor="let project of projects" 
                                 [value]="project.project_id">
                {{ project.project_name }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Selected Project Info -->
          <ion-card *ngIf="selectedProject" class="project-info-card">
            <ion-card-content>
              <p><strong>Client:</strong> {{ selectedProject.client_name }}</p>
              <p><strong>Shift:</strong> {{ selectedProject.shift_name }}</p>
              <p><strong>Time:</strong> {{ selectedProject.start_time }} - {{ selectedProject.end_time }}</p>
            </ion-card-content>
          </ion-card>

          <!-- Update Date -->
          <ion-item>
            <ion-label position="stacked">Date *</ion-label>
            <ion-datetime [(ngModel)]="updateForm.updateDate" 
                          name="updateDate"
                          presentation="date"
                          [max]="maxDate">
            </ion-datetime>
          </ion-item>

          <!-- Shift Start Time -->
          <ion-item>
            <ion-label position="stacked">Shift Start Time *</ion-label>
            <ion-datetime [(ngModel)]="updateForm.shiftStartTime" 
                          name="shiftStartTime"
                          presentation="time"
                          (ionChange)="calculateHoursWorked()">
            </ion-datetime>
          </ion-item>

          <!-- Shift End Time -->
          <ion-item>
            <ion-label position="stacked">Shift End Time *</ion-label>
            <ion-datetime [(ngModel)]="updateForm.shiftEndTime" 
                          name="shiftEndTime"
                          presentation="time"
                          (ionChange)="calculateHoursWorked()">
            </ion-datetime>
          </ion-item>

          <!-- Hours Worked (Calculated) -->
          <ion-item>
            <ion-label position="stacked">Hours Worked</ion-label>
            <ion-input [(ngModel)]="updateForm.hoursWorked" 
                       name="hoursWorked"
                       type="number" 
                       step="0.5"
                       readonly>
            </ion-input>
          </ion-item>

          <!-- Work Description -->
          <ion-item>
            <ion-label position="stacked">Work Description *</ion-label>
            <ion-textarea [(ngModel)]="updateForm.workDescription" 
                          name="workDescription"
                          rows="4" 
                          placeholder="Describe the work performed today..."
                          required>
            </ion-textarea>
          </ion-item>

          <!-- Tasks Completed -->
          <ion-item>
            <ion-label position="stacked">Tasks Completed</ion-label>
            <ion-textarea [(ngModel)]="updateForm.tasksCompleted" 
                          name="tasksCompleted"
                          rows="3" 
                          placeholder="List specific tasks completed...">
            </ion-textarea>
          </ion-item>

          <!-- Challenges Faced -->
          <ion-item>
            <ion-label position="stacked">Challenges Faced</ion-label>
            <ion-textarea [(ngModel)]="updateForm.challengesFaced" 
                          name="challengesFaced"
                          rows="3" 
                          placeholder="Any challenges or blockers...">
            </ion-textarea>
          </ion-item>

          <!-- Client Timesheet Upload -->
          <ion-item>
            <ion-label position="stacked">
              Client Timesheet * 
              <small>(PDF, Excel, CSV, or Image - Max 10MB)</small>
            </ion-label>
            <input type="file" 
                   accept=".pdf,.xlsx,.xls,.csv,.png,.jpg,.jpeg" 
                   (change)="onFileSelected($event)"
                   class="file-input">
          </ion-item>

          <ion-item *ngIf="updateForm.clientTimesheet">
            <ion-label>
              <ion-chip color="success">
                <ion-icon name="document-text-outline"></ion-icon>
                <ion-label>{{ updateForm.clientTimesheet.name }}</ion-label>
              </ion-chip>
            </ion-label>
          </ion-item>

          <!-- Action Buttons -->
          <div class="button-group ion-margin-top">
            <ion-button expand="block" (click)="submitUpdate(true)" color="medium">
              <ion-icon name="document-text-outline" slot="start"></ion-icon>
              Save as Draft
            </ion-button>
            <ion-button expand="block" (click)="submitUpdate(false)" color="primary">
              <ion-icon name="cloud-upload-outline" slot="start"></ion-icon>
              Submit Update
            </ion-button>
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
