<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Timesheet Compliance Dashboard</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="navigateToVerificationQueue()">
        <ion-icon name="document-text-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- View Selector -->
  <ion-toolbar>
    <ion-segment [(ngModel)]="selectedView" (ionChange)="onViewChange($event)">
      <ion-segment-button value="dashboard">
        <ion-label>Dashboard</ion-label>
      </ion-segment-button>
      <ion-segment-button value="non-compliant">
        <ion-label>Non-Compliant</ion-label>
      </ion-segment-button>
      <ion-segment-button value="payroll">
        <ion-label>Payroll</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Statistics Card -->
  <ion-card *ngIf="statistics" class="stats-card">
    <ion-card-header>
      <ion-card-title>Overall Statistics (Last 30 Days)</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="6" size-md="3">
            <div class="stat-box">
              <ion-icon name="people-outline" color="primary"></ion-icon>
              <h3>{{ statistics.total_employees_tracked || 0 }}</h3>
              <p>Total Employees</p>
            </div>
          </ion-col>
          <ion-col size="6" size-md="3">
            <div class="stat-box">
              <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
              <h3>{{ statistics.total_compliant || 0 }}</h3>
              <p>Compliant</p>
            </div>
          </ion-col>
          <ion-col size="6" size-md="3">
            <div class="stat-box">
              <ion-icon name="warning-outline" color="warning"></ion-icon>
              <h3>{{ statistics.total_update_only || 0 }}</h3>
              <p>Update Only</p>
            </div>
          </ion-col>
          <ion-col size="6" size-md="3">
            <div class="stat-box">
              <ion-icon name="alert-circle-outline" color="danger"></ion-icon>
              <h3>{{ statistics.total_missing || 0 }}</h3>
              <p>Missing</p>
            </div>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <!-- Dashboard View -->
  <div *ngIf="selectedView === 'dashboard'">
    <!-- Date Filter -->
    <ion-card>
      <ion-card-content>
        <ion-item>
          <ion-label>Select Date</ion-label>
          <ion-button fill="outline" id="date-picker-trigger">
            {{ selectedDate | date:'mediumDate' }}
          </ion-button>
        </ion-item>
        <ion-item>
          <ion-label>Filter by Status</ion-label>
          <ion-select [(ngModel)]="filterStatus" placeholder="All">
            <ion-select-option value="all">All</ion-select-option>
            <ion-select-option value="green">Green (Compliant)</ion-select-option>
            <ion-select-option value="yellow">Yellow (Partial)</ion-select-option>
            <ion-select-option value="red">Red (Missing)</ion-select-option>
          </ion-select>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <!-- Traffic Light Dashboard -->
    <ion-card *ngFor="let project of filteredDashboard">
      <ion-card-header>
        <ion-card-title>
          {{ project.project_name }}
          <ion-badge [color]="getTrafficLightColor(project.traffic_light_status)" slot="end">
            <ion-icon [name]="getTrafficLightIcon(project.traffic_light_status)"></ion-icon>
          </ion-badge>
        </ion-card-title>
        <ion-card-subtitle>
          {{ project.client_name }} • {{ project.compliance_date | date:'mediumDate' }}
        </ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="3">
              <div class="metric">
                <ion-icon name="people-outline"></ion-icon>
                <strong>{{ project.total_employees }}</strong>
                <span>Total</span>
              </div>
            </ion-col>
            <ion-col size="3">
              <div class="metric success">
                <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
                <strong>{{ project.compliant_count }}</strong>
                <span>Compliant</span>
              </div>
            </ion-col>
            <ion-col size="3">
              <div class="metric warning">
                <ion-icon name="warning-outline" color="warning"></ion-icon>
                <strong>{{ project.update_only_count }}</strong>
                <span>Partial</span>
              </div>
            </ion-col>
            <ion-col size="3">
              <div class="metric danger">
                <ion-icon name="alert-circle-outline" color="danger"></ion-icon>
                <strong>{{ project.missing_count }}</strong>
                <span>Missing</span>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>
        <ion-button expand="block" fill="outline" size="small" 
                    (click)="viewProjectDetails(project.project_id, project.compliance_date)">
          View Details
        </ion-button>
      </ion-card-content>
    </ion-card>

    <div *ngIf="filteredDashboard.length === 0" class="empty-state">
      <ion-icon name="document-text-outline" size="large" color="medium"></ion-icon>
      <p>No project data available</p>
    </div>
  </div>

  <!-- Non-Compliant View -->
  <div *ngIf="selectedView === 'non-compliant'">
    <ion-card>
      <ion-card-content>
        <ion-searchbar [(ngModel)]="searchTerm" 
                       placeholder="Search employees..."
                       animated>
        </ion-searchbar>
      </ion-card-content>
    </ion-card>

    <ion-card>
      <ion-card-header>
        <ion-card-title>
          Non-Compliant Employees
          <ion-badge color="danger">{{ filteredNonCompliant.length }}</ion-badge>
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list *ngIf="filteredNonCompliant.length > 0">
          <ion-item *ngFor="let employee of filteredNonCompliant">
            <ion-label>
              <h2>{{ employee.first_name }} {{ employee.last_name }}</h2>
              <p>{{ employee.employee_code }} • {{ employee.email }}</p>
              <p><strong>Project:</strong> {{ employee.project_name }}</p>
              <p><strong>Shift:</strong> {{ employee.shift_name }} ({{ employee.shift_type }})</p>
              <div class="status-chips">
                <ion-chip [color]="getComplianceStatusColor(employee.compliance_status)">
                  <ion-label>{{ getComplianceStatusLabel(employee.compliance_status) }}</ion-label>
                </ion-chip>
                <ion-chip color="success" *ngIf="employee.has_work_update">
                  <ion-icon name="checkmark-circle-outline"></ion-icon>
                  <ion-label>Update Submitted</ion-label>
                </ion-chip>
                <ion-chip color="danger" *ngIf="!employee.has_client_timesheet">
                  <ion-icon name="alert-circle-outline"></ion-icon>
                  <ion-label>No Timesheet</ion-label>
                </ion-chip>
                <ion-chip color="warning" *ngIf="employee.reminder_count > 0">
                  <ion-label>{{ employee.reminder_count }} Reminders</ion-label>
                </ion-chip>
              </div>
            </ion-label>
            <div slot="end" class="action-buttons">
              <ion-button fill="clear" size="small" (click)="sendReminder(employee)">
                <ion-icon name="mail-outline"></ion-icon>
              </ion-button>
              <ion-button fill="clear" size="small" (click)="viewEmployeeDetails(employee.employee_id)">
                <ion-icon name="eye-outline"></ion-icon>
              </ion-button>
            </div>
          </ion-item>
        </ion-list>

        <div *ngIf="filteredNonCompliant.length === 0" class="empty-state">
          <ion-icon name="checkmark-circle-outline" size="large" color="success"></ion-icon>
          <p>All employees are compliant!</p>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Payroll View -->
  <div *ngIf="selectedView === 'payroll'">
    <ion-card *ngIf="payrollStatus">
      <ion-card-header>
        <ion-card-title>Payroll Period Status</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item>
            <ion-label>
              <h3>Current Period</h3>
              <p>{{ payrollStatus.payrollPeriodLock?.payroll_period || 'Not set' }}</p>
            </ion-label>
            <ion-badge slot="end" [color]="payrollStatus.payrollPeriodLock?.lock_status === 'locked' ? 'success' : 'warning'">
              {{ payrollStatus.payrollPeriodLock?.lock_status || 'Open' }}
            </ion-badge>
          </ion-item>

          <ion-item>
            <ion-label>
              <h3>Pending Verifications</h3>
              <p>Submissions awaiting review</p>
            </ion-label>
            <ion-badge slot="end" [color]="payrollStatus.pendingVerifications?.total_pending > 0 ? 'danger' : 'success'">
              {{ payrollStatus.pendingVerifications?.total_pending || 0 }}
            </ion-badge>
          </ion-item>

          <ion-item>
            <ion-label>
              <h3>Flagged Submissions</h3>
              <p>Items requiring attention</p>
            </ion-label>
            <ion-badge slot="end" [color]="payrollStatus.pendingVerifications?.flagged_count > 0 ? 'warning' : 'success'">
              {{ payrollStatus.pendingVerifications?.flagged_count || 0 }}
            </ion-badge>
          </ion-item>
        </ion-list>

        <div class="ion-margin-top">
          <ion-button expand="block" 
                      color="danger"
                      [disabled]="payrollStatus.payrollPeriodLock?.lock_status === 'locked' || payrollStatus.pendingVerifications?.total_pending > 0"
                      (click)="lockPayrollPeriod()">
            <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
            Lock Payroll Period
          </ion-button>
          <p class="hint-text" *ngIf="payrollStatus.pendingVerifications?.total_pending > 0">
            <ion-icon name="warning-outline" color="warning"></ion-icon>
            Cannot lock period with pending verifications
          </p>
        </div>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
