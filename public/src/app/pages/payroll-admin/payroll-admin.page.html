
<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Payroll Configuration & Management</ion-title>
  </ion-toolbar>
  <ion-toolbar>
    <ion-segment [(ngModel)]="tab" color="secondary">
      <ion-segment-button value="components"><ion-label>Salary Components</ion-label></ion-segment-button>
      <ion-segment-button value="templates"><ion-label>Templates</ion-label></ion-segment-button>
      <ion-segment-button value="composition"><ion-label>Template Builder</ion-label></ion-segment-button>
      <ion-segment-button value="contracts"><ion-label>Employee Contracts</ion-label></ion-segment-button>
      <ion-segment-button value="periods"><ion-label>Payroll Periods</ion-label></ion-segment-button>
      <ion-segment-button value="payslips"><ion-label>Payslips</ion-label></ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content class="modern-payroll-admin">
  <ion-grid fixed>
    <ion-row>
      <ion-col size="12">
        <ion-card *ngIf="tab === 'components'">
          <ion-card-header>
            <ion-card-title>Salary Components</ion-card-title>
            <p>Define all possible salary components (earnings, deductions, contributions, reimbursements).</p>
          </ion-card-header>
          <ion-card-content>
            <form (ngSubmit)="addComponent()" class="form-inline">
              <ion-row>
                <ion-col size="2"><ion-input [(ngModel)]="componentForm.code" name="code" label="Code" placeholder="Code"></ion-input></ion-col>
                <ion-col size="2"><ion-input [(ngModel)]="componentForm.name" name="name" label="Name" placeholder="Name"></ion-input></ion-col>
                <ion-col size="3"><ion-input [(ngModel)]="componentForm.description" name="description" label="Description" placeholder="Description"></ion-input></ion-col>
                <ion-col size="2"><ion-select [(ngModel)]="componentForm.type" name="type" label="Type"><ion-select-option value="earning">Earning</ion-select-option><ion-select-option value="deduction">Deduction</ion-select-option><ion-select-option value="contribution">Contribution</ion-select-option><ion-select-option value="reimbursement">Reimbursement</ion-select-option></ion-select></ion-col>
                <ion-col size="1"><ion-select [(ngModel)]="componentForm.is_taxable" name="is_taxable" label="Taxable"><ion-select-option [value]="true">Yes</ion-select-option><ion-select-option [value]="false">No</ion-select-option></ion-select></ion-col>
                <ion-col size="1"><ion-select [(ngModel)]="componentForm.is_active" name="is_active" label="Active"><ion-select-option [value]="true">Yes</ion-select-option><ion-select-option [value]="false">No</ion-select-option></ion-select></ion-col>
                <ion-col size="1"><ion-button expand="block" type="submit" color="success">Add</ion-button></ion-col>
              </ion-row>
            </form>
            <ion-list lines="full">
              <ion-item *ngFor="let comp of components">
                <ion-label><b>{{comp.code}}</b> - {{comp.name}} <span class="muted">({{comp.type}})</span></ion-label>
                <ion-badge color="medium" slot="end">{{comp.is_active ? 'Active' : 'Inactive'}}</ion-badge>
                <ion-button size="small" (click)="updateComponent(comp.id)">Edit</ion-button>
                <ion-button size="small" color="danger" (click)="deleteComponent(comp.id)">Delete</ion-button>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>

        <ion-card *ngIf="tab === 'templates'">
          <ion-card-header>
            <ion-card-title>Salary Structure Templates</ion-card-title>
            <p>Create reusable templates for salary structures (e.g., Standard, Executive, Contractual).</p>
          </ion-card-header>
          <ion-card-content>
            <form (ngSubmit)="addTemplate()" class="form-inline">
              <ion-row>
                <ion-col size="4"><ion-input [(ngModel)]="templateForm.template_name" name="template_name" label="Name" placeholder="Template Name"></ion-input></ion-col>
                <ion-col size="5"><ion-input [(ngModel)]="templateForm.description" name="description" label="Description" placeholder="Description"></ion-input></ion-col>
                <ion-col size="2"><ion-select [(ngModel)]="templateForm.is_active" name="is_active" label="Active"><ion-select-option [value]="true">Yes</ion-select-option><ion-select-option [value]="false">No</ion-select-option></ion-select></ion-col>
                <ion-col size="1"><ion-button expand="block" type="submit" color="success">Add</ion-button></ion-col>
              </ion-row>
            </form>
            <ion-list lines="full">
              <ion-item *ngFor="let tpl of templates">
                <ion-label><b>{{tpl.template_name}}</b> <span class="muted">{{tpl.description}}</span></ion-label>
                <ion-badge color="medium" slot="end">{{tpl.is_active ? 'Active' : 'Inactive'}}</ion-badge>
                <ion-button size="small" (click)="updateTemplate(tpl.id)">Edit</ion-button>
                <ion-button size="small" color="danger" (click)="deleteTemplate(tpl.id)">Delete</ion-button>
                <ion-button size="small" color="primary" (click)="selectTemplate(tpl)">Build</ion-button>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>

        <ion-card *ngIf="tab === 'composition'">
          <ion-card-header>
            <ion-card-title>Template Builder</ion-card-title>
            <p>Assign components and rules to the selected template.</p>
          </ion-card-header>
          <ion-card-content>
            <ng-container *ngIf="selectedTemplate; else selectTemplateMsg">
              <h3>{{selectedTemplate.template_name}}</h3>
              <form (ngSubmit)="addComposition(selectedTemplate.id)" class="form-inline">
                <ion-row>
                  <ion-col size="3"><ion-select [(ngModel)]="compositionForm.component_id" name="component_id" label="Component"><ion-select-option *ngFor="let comp of components" [value]="comp.id">{{comp.name}}</ion-select-option></ion-select></ion-col>
                  <ion-col size="2"><ion-select [(ngModel)]="compositionForm.amount_type" name="amount_type" label="Type"><ion-select-option value="fixed">Fixed</ion-select-option><ion-select-option value="percentage">Percentage</ion-select-option></ion-select></ion-col>
                  <ion-col size="2"><ion-input [(ngModel)]="compositionForm.value" name="value" label="Value" type="number" placeholder="Value"></ion-input></ion-col>
                  <ion-col size="2"><ion-input [(ngModel)]="compositionForm.sort_order" name="sort_order" label="Order" type="number" placeholder="Order"></ion-input></ion-col>
                  <ion-col size="2"><ion-select [(ngModel)]="compositionForm.is_active" name="is_active" label="Active"><ion-select-option [value]="true">Yes</ion-select-option><ion-select-option [value]="false">No</ion-select-option></ion-select></ion-col>
                  <ion-col size="1"><ion-button expand="block" type="submit" color="success">Add</ion-button></ion-col>
                </ion-row>
              </form>
              <ion-list lines="full">
                <ion-item *ngFor="let comp of composition">
                  <ion-label><b>{{comp.name}}</b> <span class="muted">({{comp.amount_type}}: {{comp.value}})</span></ion-label>
                  <ion-badge color="medium" slot="end">{{comp.is_active ? 'Active' : 'Inactive'}}</ion-badge>
                  <ion-button size="small" (click)="updateComposition(selectedTemplate.id, comp.id)">Edit</ion-button>
                  <ion-button size="small" color="danger" (click)="deleteComposition(selectedTemplate.id, comp.id)">Delete</ion-button>
                </ion-item>
              </ion-list>
            </ng-container>
            <ng-template #selectTemplateMsg>
              <ion-card color="warning"><ion-card-content><p>Please select a template in the Templates tab to build its composition.</p></ion-card-content></ion-card>
            </ng-template>
          </ion-card-content>
        </ion-card>

        <ion-card *ngIf="tab === 'contracts'">
          <ion-card-header>
            <ion-card-title>Employee Salary Contracts</ion-card-title>
            <p>Assign templates to employees with contract periods.</p>
          </ion-card-header>
          <ion-card-content>
            <form (ngSubmit)="addContract()" class="form-inline">
              <ion-row>
                <ion-col size="2"><ion-input [(ngModel)]="contractForm.employee_id" name="employee_id" label="Employee ID" placeholder="Employee ID"></ion-input></ion-col>
                <ion-col size="3"><ion-select [(ngModel)]="contractForm.template_id" name="template_id" label="Template"><ion-select-option *ngFor="let tpl of templates" [value]="tpl.id">{{tpl.template_name}}</ion-select-option></ion-select></ion-col>
                <ion-col size="2"><ion-input [(ngModel)]="contractForm.contract_start_date" name="contract_start_date" label="Start Date" type="date"></ion-input></ion-col>
                <ion-col size="2"><ion-input [(ngModel)]="contractForm.contract_end_date" name="contract_end_date" label="End Date" type="date"></ion-input></ion-col>
                <ion-col size="2"><ion-select [(ngModel)]="contractForm.is_active" name="is_active" label="Active"><ion-select-option [value]="true">Yes</ion-select-option><ion-select-option [value]="false">No</ion-select-option></ion-select></ion-col>
                <ion-col size="1"><ion-button expand="block" type="submit" color="success">Add</ion-button></ion-col>
              </ion-row>
            </form>
            <ion-list lines="full">
              <ion-item *ngFor="let contract of contracts">
                <ion-label><b>{{contract.EmployeeNumber}}</b> - {{contract.FullName}} <span class="muted">({{contract.template_name}})</span></ion-label>
                <ion-badge color="medium" slot="end">{{contract.is_active ? 'Active' : 'Inactive'}}</ion-badge>
                <ion-button size="small" (click)="updateContract(contract.id)">Edit</ion-button>
                <ion-button size="small" color="danger" (click)="deleteContract(contract.id)">Delete</ion-button>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>

        <ion-card *ngIf="tab === 'periods'">
          <ion-card-header>
            <ion-card-title>Payroll Periods</ion-card-title>
            <p>Define payroll periods and run payroll for each period.</p>
          </ion-card-header>
          <ion-card-content>
            <form (ngSubmit)="addPeriod()" class="form-inline">
              <ion-row>
                <ion-col size="2"><ion-input [(ngModel)]="periodForm.period_code" name="period_code" label="Code" placeholder="Code"></ion-input></ion-col>
                <ion-col size="3"><ion-input [(ngModel)]="periodForm.period_start" name="period_start" label="Start Date" type="date"></ion-input></ion-col>
                <ion-col size="3"><ion-input [(ngModel)]="periodForm.period_end" name="period_end" label="End Date" type="date"></ion-input></ion-col>
                <ion-col size="2"><ion-select [(ngModel)]="periodForm.status" name="status" label="Status"><ion-select-option value="open">Open</ion-select-option><ion-select-option value="processing">Processing</ion-select-option><ion-select-option value="closed">Closed</ion-select-option><ion-select-option value="locked">Locked</ion-select-option></ion-select></ion-col>
                <ion-col size="2"><ion-button expand="block" type="submit" color="success">Add</ion-button></ion-col>
              </ion-row>
            </form>
            <ion-list lines="full">
              <ion-item *ngFor="let period of periods">
                <ion-label><b>{{period.period_code}}</b> <span class="muted">({{period.period_start}} - {{period.period_end}})</span></ion-label>
                <ion-badge color="medium" slot="end">{{period.status}}</ion-badge>
                <ion-button size="small" (click)="updatePeriod(period.id)">Edit</ion-button>
                <ion-button size="small" color="danger" (click)="deletePeriod(period.id)">Delete</ion-button>
                <ion-button size="small" color="primary" [disabled]="loading" (click)="runPayroll(period.id)">Run Payroll</ion-button>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>

        <ion-card *ngIf="tab === 'payslips'">
          <ion-card-header>
            <ion-card-title>Payslips</ion-card-title>
            <p>View generated payslips and their breakdown.</p>
          </ion-card-header>
          <ion-card-content>
            <ion-list lines="full">
              <ion-item *ngFor="let payslip of payslips">
                <ion-label><b>{{payslip.FullName}}</b> ({{payslip.EmployeeNumber}}) <span class="muted">Net Pay: ₹{{payslip.net_pay}}</span></ion-label>
                <ion-button size="small" color="primary" (click)="viewPayslipItems(payslip)">View Items</ion-button>
              </ion-item>
            </ion-list>
            <div *ngIf="selectedPayslip">
              <h3>Itemized Payslip</h3>
              <ion-list lines="full">
                <ion-item *ngFor="let item of payslipItems">
                  <ion-label><b>{{item.name}}</b> ({{item.component_type}}): ₹{{item.amount}}</ion-label>
                </ion-item>
              </ion-list>
            </div>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>
</ion-content>
