<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/admin/timesheet/verification-queue"></ion-back-button>
    </ion-buttons>
    <ion-title>Verification Comparison</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Loading comparison data...</p>
  </div>

  <div *ngIf="!isLoading && comparisonData">
    <!-- Employee & Project Info -->
    <ion-card class="info-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="person-outline"></ion-icon>
          {{ comparisonData.workUpdate.first_name }} {{ comparisonData.workUpdate.last_name }}
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="12" size-md="6">
              <div class="info-item">
                <ion-icon name="briefcase-outline" color="primary"></ion-icon>
                <div>
                  <strong>Project</strong>
                  <p>{{ comparisonData.workUpdate.project_name }}</p>
                </div>
              </div>
            </ion-col>
            <ion-col size="12" size-md="6">
              <div class="info-item">
                <ion-icon name="calendar-outline" color="primary"></ion-icon>
                <div>
                  <strong>Date</strong>
                  <p>{{ formatDate(comparisonData.workUpdate.update_date) }}</p>
                </div>
              </div>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size="12" size-md="6">
              <div class="info-item">
                <strong>Employee Code:</strong> {{ comparisonData.workUpdate.employee_code }}
              </div>
            </ion-col>
            <ion-col size="12" size-md="6">
              <div class="info-item">
                <strong>Client:</strong> {{ comparisonData.workUpdate.client_name }}
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <!-- Side-by-Side Comparison -->
    <ion-grid>
      <ion-row>
        <!-- Internal Work Update -->
        <ion-col size="12" size-lg="6">
          <ion-card class="comparison-card">
            <ion-card-header>
              <ion-card-title class="card-title-internal">
                <ion-icon name="document-text-outline"></ion-icon>
                Internal Work Update
              </ion-card-title>
              <ion-badge [color]="getStatusColor(comparisonData.workUpdate.status)">
                {{ comparisonData.workUpdate.status }}
              </ion-badge>
            </ion-card-header>
            <ion-card-content>
              <ion-list>
                <ion-item>
                  <ion-label>
                    <h3>Shift Times</h3>
                    <p>{{ formatTime(comparisonData.workUpdate.shift_start_time) }} - 
                       {{ formatTime(comparisonData.workUpdate.shift_end_time) }}</p>
                  </ion-label>
                </ion-item>

                <ion-item>
                  <ion-label>
                    <h3>Hours Worked</h3>
                    <p class="hours-large">{{ comparisonData.workUpdate.hours_worked }} hours</p>
                  </ion-label>
                </ion-item>

                <ion-item>
                  <ion-label>
                    <h3>Work Description</h3>
                    <p class="description-text">{{ comparisonData.workUpdate.work_description }}</p>
                  </ion-label>
                </ion-item>

                <ion-item *ngIf="comparisonData.workUpdate.tasks_completed">
                  <ion-label>
                    <h3>Tasks Completed</h3>
                    <p class="description-text">{{ comparisonData.workUpdate.tasks_completed }}</p>
                  </ion-label>
                </ion-item>

                <ion-item *ngIf="comparisonData.workUpdate.challenges_faced">
                  <ion-label>
                    <h3>Challenges Faced</h3>
                    <p class="description-text">{{ comparisonData.workUpdate.challenges_faced }}</p>
                  </ion-label>
                </ion-item>

                <ion-item>
                  <ion-label>
                    <h3>Submitted At</h3>
                    <p>{{ comparisonData.workUpdate.submission_timestamp | date:'medium' }}</p>
                  </ion-label>
                </ion-item>
              </ion-list>
            </ion-card-content>
          </ion-card>
        </ion-col>

        <!-- Client Timesheet -->
        <ion-col size="12" size-lg="6">
          <ion-card class="comparison-card">
            <ion-card-header>
              <ion-card-title class="card-title-client">
                <ion-icon name="cloud-download-outline"></ion-icon>
                Client Timesheet
              </ion-card-title>
              <ion-badge [color]="comparisonData.clientTimesheet?.is_verified ? 'success' : 'warning'">
                {{ comparisonData.clientTimesheet?.is_verified ? 'Verified' : 'Unverified' }}
              </ion-badge>
            </ion-card-header>
            <ion-card-content>
              <div *ngIf="comparisonData.clientTimesheet; else noTimesheet">
                <ion-list>
                  <ion-item>
                    <ion-label>
                      <h3>File Name</h3>
                      <p>{{ comparisonData.clientTimesheet.file_name }}</p>
                    </ion-label>
                  </ion-item>

                  <ion-item>
                    <ion-label>
                      <h3>File Type</h3>
                      <p>{{ comparisonData.clientTimesheet.file_type }}</p>
                    </ion-label>
                  </ion-item>

                  <ion-item>
                    <ion-label>
                      <h3>File Size</h3>
                      <p>{{ (comparisonData.clientTimesheet.file_size / 1024).toFixed(2) }} KB</p>
                    </ion-label>
                  </ion-item>

                  <ion-item>
                    <ion-label>
                      <h3>Uploaded At</h3>
                      <p>{{ comparisonData.clientTimesheet.uploaded_at | date:'medium' }}</p>
                    </ion-label>
                  </ion-item>
                </ion-list>

                <ion-button expand="block" fill="outline" (click)="downloadTimesheet()" class="ion-margin-top">
                  <ion-icon name="cloud-download-outline" slot="start"></ion-icon>
                  Download Timesheet
                </ion-button>
              </div>

              <ng-template #noTimesheet>
                <div class="no-timesheet">
                  <ion-icon name="warning-outline" size="large" color="warning"></ion-icon>
                  <h3>No Client Timesheet Uploaded</h3>
                  <p>The employee has not uploaded a client timesheet for this update.</p>
                </div>
              </ng-template>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- Verification History -->
    <ion-card *ngIf="comparisonData.verificationHistory && comparisonData.verificationHistory.length > 0">
      <ion-card-header>
        <ion-card-title>Verification History</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item *ngFor="let verification of comparisonData.verificationHistory">
            <ion-label>
              <h3>{{ verification.verified_by_name }}</h3>
              <p>{{ verification.verification_timestamp | date:'medium' }}</p>
              <ion-chip [color]="getStatusColor(verification.verification_status)">
                <ion-label>{{ verification.verification_status }}</ion-label>
              </ion-chip>
              <p *ngIf="verification.verification_notes" class="notes">
                <strong>Notes:</strong> {{ verification.verification_notes }}
              </p>
              <p *ngIf="verification.hours_discrepancy !== 0">
                <strong>Hours Discrepancy:</strong> {{ verification.hours_discrepancy }}
              </p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Audit Log -->
    <ion-card *ngIf="comparisonData.auditLog && comparisonData.auditLog.length > 0">
      <ion-card-header>
        <ion-card-title>Audit Log</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item *ngFor="let log of comparisonData.auditLog">
            <ion-label>
              <h3>{{ log.action_type }}</h3>
              <p>{{ log.action_by_name }} â€¢ {{ log.action_timestamp | date:'medium' }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Verification Actions -->
    <ion-card class="action-card" *ngIf="comparisonData.workUpdate.status === 'submitted'">
      <ion-card-header>
        <ion-card-title>Verification Actions</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="12" size-md="4">
              <ion-button expand="block" color="success" (click)="openVerificationModal('approved')">
                <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
                Approve
              </ion-button>
            </ion-col>
            <ion-col size="12" size-md="4">
              <ion-button expand="block" color="warning" (click)="openVerificationModal('flagged')">
                <ion-icon name="warning-outline" slot="start"></ion-icon>
                Flag
              </ion-button>
            </ion-col>
            <ion-col size="12" size-md="4">
              <ion-button expand="block" color="danger" (click)="openVerificationModal('rejected')">
                <ion-icon name="close-circle-outline" slot="start"></ion-icon>
                Reject
              </ion-button>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Verification Modal -->
  <ion-modal [isOpen]="showVerificationModal" (didDismiss)="showVerificationModal = false">
    <ng-template>
      <ion-header>
        <ion-toolbar [color]="verificationForm.verificationStatus === 'approved' ? 'success' : verificationForm.verificationStatus === 'flagged' ? 'warning' : 'danger'">
          <ion-title>{{ verificationForm.verificationStatus | titlecase }} Verification</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="showVerificationModal = false">Close</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <form>
          <ion-item>
            <ion-label position="stacked">Verification Notes</ion-label>
            <ion-textarea [(ngModel)]="verificationForm.verificationNotes"
                          name="notes"
                          rows="4"
                          placeholder="Add any notes or comments about this verification...">
            </ion-textarea>
          </ion-item>

          <ion-item *ngIf="verificationForm.verificationStatus !== 'approved'">
            <ion-label position="stacked">Hours Discrepancy</ion-label>
            <ion-input [(ngModel)]="verificationForm.hoursDiscrepancy"
                       name="discrepancy"
                       type="number"
                       step="0.5"
                       placeholder="0.0">
            </ion-input>
          </ion-item>

          <ion-button expand="block" 
                      [color]="verificationForm.verificationStatus === 'approved' ? 'success' : verificationForm.verificationStatus === 'flagged' ? 'warning' : 'danger'"
                      class="ion-margin-top"
                      (click)="submitVerification()">
            Submit {{ verificationForm.verificationStatus | titlecase }}
          </ion-button>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
