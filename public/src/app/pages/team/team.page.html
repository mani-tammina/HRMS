<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>My Team</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="team-container">
    <!-- Team Attendance Report Section -->
    <div class="attendance-section">
      <div class="section-header">
        <h3>
          <ion-icon name="analytics-outline"></ion-icon>
          Today's Team Attendance
        </h3>
        <ion-datetime 
          *ngIf="isManagerOrHR"
          [(ngModel)]="selectedDate" 
          (ionChange)="onDateChange($event)"
          presentation="date"
          [max]="maxDate"
          size="small">
        </ion-datetime>
      </div>

      <!-- Loading State -->
      <ion-card *ngIf="isLoadingAttendance">
        <ion-card-content class="empty-state">
          <ion-icon name="hourglass-outline" size="large" color="medium"></ion-icon>
          <p>Loading attendance...</p>
        </ion-card-content>
      </ion-card>

      <!-- Summary Cards -->
      <div class="summary-grid" *ngIf="!isLoadingAttendance && teamAttendance?.summary">
        <div class="summary-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <ion-icon name="people-outline"></ion-icon>
          <div class="summary-content">
            <div class="summary-value" style="color: white;">{{ teamAttendance.summary.total_team || 0 }}</div>
            <div class="summary-label" style="color: rgba(255,255,255,0.9);">Total Team</div>
          </div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
          <ion-icon name="checkmark-circle-outline"></ion-icon>
          <div class="summary-content">
            <div class="summary-value" style="color: white;">{{ teamAttendance.summary.present || 0 }}</div>
            <div class="summary-label" style="color: rgba(255,255,255,0.9);">Present</div>
          </div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
          <ion-icon name="close-circle-outline"></ion-icon>
          <div class="summary-content">
            <div class="summary-value" style="color: white;">{{ teamAttendance.summary.absent || 0 }}</div>
            <div class="summary-label" style="color: rgba(255,255,255,0.9);">Absent</div>
          </div>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
          <ion-icon name="calendar-outline"></ion-icon>
          <div class="summary-content">
            <div class="summary-value" style="color: white;">{{ teamAttendance.summary.on_leave || 0 }}</div>
            <div class="summary-label" style="color: rgba(255,255,255,0.9);">On Leave</div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <ion-card *ngIf="!isLoadingAttendance && teamAttendance && teamAttendance.summary && teamAttendance.summary.total_team === 0">
        <ion-card-content class="empty-state">
          <ion-icon name="people-outline" size="large" color="medium"></ion-icon>
          <p><strong>No team members found</strong></p>
          <small>You need team members reporting to you to view attendance.</small>
        </ion-card-content>
      </ion-card>

      <!-- Attendance List -->
      <div *ngIf="!isLoadingAttendance && teamAttendance?.attendance && teamAttendance.attendance.length > 0">
        <ion-card *ngFor="let record of teamAttendance.attendance" class="attendance-card">
          <ion-card-content>
            <div class="attendance-info">
              <div class="employee-info">
                <strong>{{ record.FirstName }} {{ record.LastName }}</strong>
                <small>{{ record.EmployeeNumber }}</small>
              </div>
              <ion-badge [color]="getAttendanceStatusColor(record.status)">
                {{ record.status }}
              </ion-badge>
            </div>
            <div class="attendance-details">
              <div class="detail-row" *ngIf="record.first_check_in">
                <ion-icon name="checkmark-circle-outline"></ion-icon>
                <span><strong>Check In:</strong> {{ record.first_check_in | date:'short' }}</span>
              </div>
              <div class="detail-row" *ngIf="record.last_check_out">
                <ion-icon name="close-circle-outline"></ion-icon>
                <span><strong>Check Out:</strong> {{ record.last_check_out | date:'short' }}</span>
              </div>
              <div class="detail-row" *ngIf="record.gross_hours">
                <ion-icon name="hourglass-outline"></ion-icon>
                <span><strong>Work Hours:</strong> {{ record.gross_hours }}h</span>
              </div>
              <div class="detail-row" *ngIf="record.work_mode">
                <ion-icon name="location-outline"></ion-icon>
                <span><strong>Mode:</strong> {{ record.work_mode }}</span>
              </div>
              <div class="detail-row" *ngIf="record.total_punches">
                <ion-icon name="finger-print-outline"></ion-icon>
                <span><strong>Total Punches:</strong> {{ record.total_punches }}</span>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
      </div>
    </div>

    <!-- Divider -->
    <div class="divider" *ngIf="teamMembers.length > 0"></div>

    <!-- Team Members List Section -->
    <div class="section-header">
      <h3>{{ teamInfo?.message || 'Team Members' }}</h3>
      <ion-badge color="primary">{{ teamMembers.length }}</ion-badge>
    </div>

    <!-- Loading State -->
    <ion-card *ngIf="isLoading">
      <ion-card-content class="empty-state">
        <ion-icon name="people-outline" size="large" color="medium"></ion-icon>
        <p>Loading team members...</p>
      </ion-card-content>
    </ion-card>

    <!-- Empty State -->
    <ion-card *ngIf="!isLoading && teamMembers.length === 0">
      <ion-card-content class="empty-state">
        <ion-icon name="people-outline" size="large" color="medium"></ion-icon>
        <p>No team members found</p>
        <small>You may not have any team members reporting to you, or you may not be part of a team yet.</small>
      </ion-card-content>
    </ion-card>

    <!-- Team List -->
    <ion-card *ngFor="let member of teamMembers" class="team-card" button (click)="viewMemberDetails(member)">
      <ion-card-header>
        <div class="card-header-content">
          <div>
            <ion-card-title>{{ member.FirstName }} {{ member.LastName }}</ion-card-title>
            <p class="employee-details">{{ member.EmployeeNumber }} â€¢ {{ member.WorkEmail }}</p>
          </div>
          <ion-badge [color]="member.EmploymentStatus === 'Working' ? 'success' : 'medium'">
            {{ member.EmploymentStatus }}
          </ion-badge>
        </div>
      </ion-card-header>
      <ion-card-content>
        <div class="member-details">
          <div class="detail-row" *ngIf="member.designation_name">
            <ion-icon name="briefcase-outline"></ion-icon>
            <span><strong>Designation:</strong> {{ member.designation_name }}</span>
          </div>
          <div class="detail-row" *ngIf="member.department_name">
            <ion-icon name="business-outline"></ion-icon>
            <span><strong>Department:</strong> {{ member.department_name }}</span>
          </div>
          <div class="detail-row" *ngIf="member.location_name">
            <ion-icon name="location-outline"></ion-icon>
            <span><strong>Location:</strong> {{ member.location_name }}</span>
          </div>
          <div class="detail-row" *ngIf="member.PersonalEmail">
            <ion-icon name="mail-outline"></ion-icon>
            <span><strong>Personal Email:</strong> {{ member.PersonalEmail }}</span>
          </div>
          <div class="detail-row" *ngIf="member.ContactNumber">
            <ion-icon name="call-outline"></ion-icon>
            <span><strong>Contact:</strong> {{ member.ContactNumber }}</span>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
