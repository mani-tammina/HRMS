<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/employees"></ion-back-button>
    </ion-buttons>
    <ion-title>Employee Details</ion-title>
    <ion-buttons slot="end">
      <ion-button *ngIf="isHR" (click)="openEditModal()">
        <ion-icon name="create-outline"></ion-icon>
        Edit
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p>Loading employee details...</p>
  </div>

  <div class="page-content" *ngIf="!isLoading && employee">
    <!-- Profile Header -->
    <div class="profile-header">
      <ion-avatar class="profile-avatar">
        <img [src]="employee.ProfilePicture || 'assets/avatar-placeholder.png'" 
             [alt]="employee.FirstName" 
             (error)="handleImageError($event)">
      </ion-avatar>
      <h1>{{ employee.FirstName }} {{ employee.LastName }}</h1>
      <p class="designation">{{ employee.designation_name || employee.Designation }}</p>
      <ion-badge [color]="getStatusColor(employee.EmploymentStatus)">
        {{ employee.EmploymentStatus || 'Active' }}
      </ion-badge>
    </div>

    <!-- Basic Information -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="card-outline"></ion-icon>
          Basic Information
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="none">
          <ion-item *ngIf="employee.EmployeeNumber">
            <ion-icon slot="start" name="card-outline" color="primary"></ion-icon>
            <ion-label>
              <p>Employee Number</p>
              <h3>{{ employee.EmployeeNumber }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.DateOfJoining">
            <ion-icon slot="start" name="calendar-outline" color="primary"></ion-icon>
            <ion-label>
              <p>Date of Joining</p>
              <h3>{{ employee.DateOfJoining | date }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.DateOfBirth">
            <ion-icon slot="start" name="calendar-outline" color="success"></ion-icon>
            <ion-label>
              <p>Date of Birth</p>
              <h3>{{ employee.DateOfBirth | date }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.Gender">
            <ion-icon slot="start" name="person-outline" color="primary"></ion-icon>
            <ion-label>
              <p>Gender</p>
              <h3>{{ employee.Gender }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.MaritalStatus">
            <ion-icon slot="start" name="person-outline" color="secondary"></ion-icon>
            <ion-label>
              <p>Marital Status</p>
              <h3>{{ employee.MaritalStatus }}</h3>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Contact Information -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="call-outline"></ion-icon>
          Contact Information
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="none">
          <ion-item *ngIf="employee.WorkEmail">
            <ion-icon slot="start" name="mail-outline" color="primary"></ion-icon>
            <ion-label>
              <p>Work Email</p>
              <h3>{{ employee.WorkEmail }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.PersonalEmail">
            <ion-icon slot="start" name="mail-outline" color="secondary"></ion-icon>
            <ion-label>
              <p>Personal Email</p>
              <h3>{{ employee.PersonalEmail }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.ContactNumber">
            <ion-icon slot="start" name="call-outline" color="primary"></ion-icon>
            <ion-label>
              <p>Phone Number</p>
              <h3>{{ employee.ContactNumber }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.EmergencyContactNumber">
            <ion-icon slot="start" name="alert-circle-outline" color="danger"></ion-icon>
            <ion-label>
              <p>Emergency Contact</p>
              <h3>{{ employee.EmergencyContactNumber }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.EmergencyContactName">
            <ion-icon slot="start" name="person-outline" color="danger"></ion-icon>
            <ion-label>
              <p>Emergency Contact Name</p>
              <h3>{{ employee.EmergencyContactName }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.Address">
            <ion-icon slot="start" name="home-outline" color="primary"></ion-icon>
            <ion-label class="ion-text-wrap">
              <p>Address</p>
              <h3>{{ employee.Address }}</h3>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Work Information -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="briefcase-outline"></ion-icon>
          Work Information
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="none">
          <ion-item *ngIf="employee.designation_name">
            <ion-icon slot="start" name="briefcase-outline" color="primary"></ion-icon>
            <ion-label>
              <p>Designation</p>
              <h3>{{ employee.designation_name }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.secondary_designation_name">
            <ion-icon slot="start" name="briefcase-outline" color="secondary"></ion-icon>
            <ion-label>
              <p>Secondary Designation</p>
              <h3>{{ employee.secondary_designation_name }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.department_name">
            <ion-icon slot="start" name="business-outline" color="primary"></ion-icon>
            <ion-label>
              <p>Department</p>
              <h3>{{ employee.department_name }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.sub_department_name">
            <ion-icon slot="start" name="business-outline" color="secondary"></ion-icon>
            <ion-label>
              <p>Sub Department</p>
              <h3>{{ employee.sub_department_name }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.location_name">
            <ion-icon slot="start" name="location-outline" color="primary"></ion-icon>
            <ion-label>
              <p>Location</p>
              <h3>{{ employee.location_name }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.business_unit_name">
            <ion-icon slot="start" name="business-outline" color="tertiary"></ion-icon>
            <ion-label>
              <p>Business Unit</p>
              <h3>{{ employee.business_unit_name }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.legal_entity_name">
            <ion-icon slot="start" name="shield-outline" color="warning"></ion-icon>
            <ion-label>
              <p>Legal Entity</p>
              <h3>{{ employee.legal_entity_name }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.cost_center_code">
            <ion-icon slot="start" name="cash-outline" color="success"></ion-icon>
            <ion-label>
              <p>Cost Center</p>
              <h3>{{ employee.cost_center_code }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.manager_first_name">
            <ion-icon slot="start" name="person-outline" color="primary"></ion-icon>
            <ion-label>
              <p>Reporting Manager</p>
              <h3>{{ employee.manager_first_name }} {{ employee.manager_last_name }}</h3>
              <p *ngIf="employee.manager_employee_number">#{{ employee.manager_employee_number }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Compensation & Band -->
    <ion-card *ngIf="employee.band_name || employee.pay_grade_name">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="cash-outline"></ion-icon>
          Compensation
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="none">
          <ion-item *ngIf="employee.band_name">
            <ion-icon slot="start" name="card-outline" color="primary"></ion-icon>
            <ion-label>
              <p>Band</p>
              <h3>{{ employee.band_name }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.pay_grade_name">
            <ion-icon slot="start" name="cash-outline" color="success"></ion-icon>
            <ion-label>
              <p>Pay Grade</p>
              <h3>{{ employee.pay_grade_name }}</h3>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Policies -->
    <ion-card *ngIf="employee.leave_plan_name || employee.shift_policy_name || employee.attendance_policy_name">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="clipboard-outline"></ion-icon>
          Policies & Plans
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="none">
          <ion-item *ngIf="employee.leave_plan_name">
            <ion-icon slot="start" name="calendar-outline" color="primary"></ion-icon>
            <ion-label>
              <p>Leave Plan</p>
              <h3>{{ employee.leave_plan_name }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.shift_policy_name">
            <ion-icon slot="start" name="time-outline" color="primary"></ion-icon>
            <ion-label>
              <p>Shift Policy</p>
              <h3>{{ employee.shift_policy_name }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.weekly_off_policy_name">
            <ion-icon slot="start" name="calendar-outline" color="secondary"></ion-icon>
            <ion-label>
              <p>Weekly Off Policy</p>
              <h3>{{ employee.weekly_off_policy_name }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.attendance_policy_name">
            <ion-icon slot="start" name="clipboard-outline" color="primary"></ion-icon>
            <ion-label>
              <p>Attendance Policy</p>
              <h3>{{ employee.attendance_policy_name }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.attendance_capture_scheme_name">
            <ion-icon slot="start" name="time-outline" color="secondary"></ion-icon>
            <ion-label>
              <p>Attendance Capture</p>
              <h3>{{ employee.attendance_capture_scheme_name }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.holiday_list_name">
            <ion-icon slot="start" name="calendar-outline" color="success"></ion-icon>
            <ion-label>
              <p>Holiday List</p>
              <h3>{{ employee.holiday_list_name }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.expense_policy_name">
            <ion-icon slot="start" name="cash-outline" color="warning"></ion-icon>
            <ion-label>
              <p>Expense Policy</p>
              <h3>{{ employee.expense_policy_name }}</h3>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Additional Information -->
    <ion-card *ngIf="employee.PAN || employee.Aadhaar || employee.UAN || employee.BankAccountNumber">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="shield-outline"></ion-icon>
          Additional Information
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="none">
          <ion-item *ngIf="employee.PAN">
            <ion-icon slot="start" name="card-outline" color="primary"></ion-icon>
            <ion-label>
              <p>PAN Number</p>
              <h3>{{ employee.PAN }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.Aadhaar">
            <ion-icon slot="start" name="card-outline" color="secondary"></ion-icon>
            <ion-label>
              <p>Aadhaar Number</p>
              <h3>{{ employee.Aadhaar }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.UAN">
            <ion-icon slot="start" name="card-outline" color="tertiary"></ion-icon>
            <ion-label>
              <p>UAN Number</p>
              <h3>{{ employee.UAN }}</h3>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.BankAccountNumber">
            <ion-icon slot="start" name="cash-outline" color="success"></ion-icon>
            <ion-label>
              <p>Bank Account</p>
              <h3>{{ employee.BankAccountNumber }}</h3>
              <p *ngIf="employee.BankName">{{ employee.BankName }}</p>
            </ion-label>
          </ion-item>

          <ion-item *ngIf="employee.IFSCCode">
            <ion-icon slot="start" name="business-outline" color="primary"></ion-icon>
            <ion-label>
              <p>IFSC Code</p>
              <h3>{{ employee.IFSCCode }}</h3>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Edit Modal -->
  <ion-modal [isOpen]="showEditModal" (didDismiss)="closeEditModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Edit Employee Master Details</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeEditModal()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <form (ngSubmit)="saveEdits()">
          <ion-list lines="full">
            <ion-item>
              <ion-label position="stacked">Reporting Manager</ion-label>
              <ion-input placeholder="Search manager..." [(ngModel)]="managerSearch" name="managerSearch" clearInput></ion-input>
              <ion-select [(ngModel)]="editForm.reporting_manager_id" name="reporting_manager_id" interface="popover">
                <ion-select-option *ngFor="let mgr of filteredManagers" [value]="mgr.id">{{ mgr.name }}</ion-select-option>
              </ion-select>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">Leave Plan</ion-label>
              <ion-select [(ngModel)]="editForm.leave_plan_id" name="leave_plan_id">
                <ion-select-option *ngFor="let plan of masterData.leavePlans" [value]="plan.id">{{ plan.name }}</ion-select-option>
              </ion-select>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">Shift Policy</ion-label>
              <ion-select [(ngModel)]="editForm.shift_policy_id" name="shift_policy_id">
                <ion-select-option *ngFor="let sp of masterData.shiftPolicies" [value]="sp.id">{{ sp.name }}</ion-select-option>
              </ion-select>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">Attendance Policy</ion-label>
              <ion-select [(ngModel)]="editForm.attendance_policy_id" name="attendance_policy_id">
                <ion-select-option *ngFor="let ap of masterData.attendancePolicies" [value]="ap.id">{{ ap.name }}</ion-select-option>
              </ion-select>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">Pay Grade</ion-label>
              <ion-select [(ngModel)]="editForm.PayGradeId" name="PayGradeId">
                <ion-select-option *ngFor="let pg of masterData.payGrades" [value]="pg.id">{{ pg.name }}</ion-select-option>
              </ion-select>
            </ion-item>
          </ion-list>
          <ion-list lines="full" *ngIf="salaryStructure">
            <ion-item>
              <ion-label position="stacked">Basic Salary</ion-label>
              <ion-input type="number" [(ngModel)]="salaryStructure.basic_salary" name="basic_salary"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">HRA</ion-label>
              <ion-input type="number" [(ngModel)]="salaryStructure.hra" name="hra" [readonly]="payrollDefaults?.hra_percent"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">Conveyance</ion-label>
              <ion-input type="number" [(ngModel)]="salaryStructure.conveyance" name="conveyance"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">Special Allowance</ion-label>
              <ion-input type="number" [(ngModel)]="salaryStructure.special_allowance" name="special_allowance"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">PF Contribution</ion-label>
              <ion-input type="number" [(ngModel)]="salaryStructure.pf_contribution" name="pf_contribution"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">ESI</ion-label>
              <ion-input type="number" [(ngModel)]="salaryStructure.esi" name="esi"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">Professional Tax</ion-label>
              <ion-input type="number" [(ngModel)]="salaryStructure.professional_tax" name="professional_tax"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">Other Deductions</ion-label>
              <ion-input type="number" [(ngModel)]="salaryStructure.other_deductions" name="other_deductions"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">Effective From</ion-label>
              <ion-datetime display-format="YYYY-MM-DD" [(ngModel)]="salaryStructure.effective_from" name="effective_from"></ion-datetime>
            </ion-item>
          </ion-list>
          <ion-footer>
            <ion-button expand="block" type="submit" color="primary">Save</ion-button>
          </ion-footer>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Empty State -->
  <div *ngIf="!isLoading && !employee" class="empty-state">
    <ion-icon name="person-outline" size="large"></ion-icon>
    <h2>Employee Not Found</h2>
    <p>Unable to load employee details</p>
  </div>
</ion-content>
