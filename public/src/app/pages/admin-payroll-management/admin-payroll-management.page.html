<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Payroll Management</ion-title>
  </ion-toolbar>

  <!-- Segments -->
  <ion-toolbar>
    <ion-segment [(ngModel)]="selectedSegment" (ionChange)="segmentChanged($event)">
      <ion-segment-button value="runs">
        <ion-label>Payroll Runs</ion-label>
      </ion-segment-button>
      <ion-segment-button value="slips">
        <ion-label>Payslips</ion-label>
      </ion-segment-button>
      <ion-segment-button value="structures">
        <ion-label>Salary Setup</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Payroll Runs Tab -->
  <div *ngIf="selectedSegment === 'runs'">
    <!-- Generate Payroll Card -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Generate New Payroll</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="6">
              <ion-item>
                <ion-select [(ngModel)]="generateForm.month" label="Month" label-placement="stacked">
                  <ion-select-option [value]="1">January</ion-select-option>
                  <ion-select-option [value]="2">February</ion-select-option>
                  <ion-select-option [value]="3">March</ion-select-option>
                  <ion-select-option [value]="4">April</ion-select-option>
                  <ion-select-option [value]="5">May</ion-select-option>
                  <ion-select-option [value]="6">June</ion-select-option>
                  <ion-select-option [value]="7">July</ion-select-option>
                  <ion-select-option [value]="8">August</ion-select-option>
                  <ion-select-option [value]="9">September</ion-select-option>
                  <ion-select-option [value]="10">October</ion-select-option>
                  <ion-select-option [value]="11">November</ion-select-option>
                  <ion-select-option [value]="12">December</ion-select-option>
                </ion-select>
              </ion-item>
            </ion-col>
            <ion-col size="6">
              <ion-item>
                <ion-input 
                  [(ngModel)]="generateForm.year" 
                  type="number" 
                  label="Year"
                  label-placement="stacked"
                  [min]="2020" 
                  [max]="2030">
                </ion-input>
              </ion-item>
            </ion-col>
          </ion-row>
        </ion-grid>
        <ion-button expand="block" (click)="generatePayroll()" [disabled]="loading">
          <ion-icon name="add-circle" slot="start"></ion-icon>
          Generate Payroll
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Loading -->
    <div *ngIf="loading" class="loading-container">
      <ion-spinner></ion-spinner>
      <p>Loading payroll runs...</p>
    </div>

    <!-- Payroll Runs List -->
    <ion-card *ngFor="let run of payrollRuns" (click)="viewRunDetails(run.id)">
      <ion-card-content>
        <div class="run-header">
          <div>
            <h3>{{ getMonthName(run.month) }} {{ run.year }}</h3>
            <p class="run-meta">
              <ion-chip [color]="getStatusColor(run.status)" size="small">
                {{ run.status }}
              </ion-chip>
              <span class="slip-count">{{ run.slip_count }} employees</span>
            </p>
          </div>
          <div class="run-amount">
            <h2>₹{{ run.total_payout | number:'1.2-2' }}</h2>
            <p>Total Payout</p>
          </div>
        </div>
        
        <div class="run-footer">
          <span class="run-date">
            <ion-icon name="calendar"></ion-icon>
            {{ run.created_at | date: 'MMM dd, yyyy' }}
          </span>
          <ion-button fill="clear" size="small">
            <ion-icon name="eye" slot="start"></ion-icon>
            View Details
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Empty State -->
    <div *ngIf="!loading && payrollRuns.length === 0" class="empty-state">
      <ion-icon name="document-text" color="medium"></ion-icon>
      <h3>No Payroll Runs</h3>
      <p>Generate your first payroll run to get started.</p>
    </div>
  </div>

  <!-- Payslips Tab -->
  <div *ngIf="selectedSegment === 'slips'">
    <!-- Loading -->
    <div *ngIf="loading" class="loading-container">
      <ion-spinner></ion-spinner>
      <p>Loading payslips...</p>
    </div>

    <!-- Payslips List -->
    <ion-card *ngFor="let slip of allPayslips" (click)="viewPayslip(slip.id)">
      <ion-card-content>
        <div class="slip-header">
          <div class="employee-info">
            <ion-avatar>
              <img [src]="'assets/images/default-avatar.png'" alt="Employee">
            </ion-avatar>
            <div>
              <h3>{{ slip.FirstName }} {{ slip.LastName }}</h3>
              <p>{{ getMonthName(slip.month) }} {{ slip.year }}</p>
            </div>
          </div>
          <div class="slip-amount">
            <h3>₹{{ slip.net_salary | number:'1.2-2' }}</h3>
            <ion-chip [color]="getStatusColor(slip.status)" size="small">
              {{ slip.status }}
            </ion-chip>
          </div>
        </div>
        
        <div class="slip-details">
          <div class="detail-item">
            <span class="label">Gross:</span>
            <span class="value">₹{{ slip.gross_salary | number:'1.2-2' }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Deductions:</span>
            <span class="value">₹{{ slip.total_deductions | number:'1.2-2' }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Days Worked:</span>
            <span class="value">{{ slip.days_worked }} / {{ slip.days_in_month }}</span>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Empty State -->
    <div *ngIf="!loading && allPayslips.length === 0" class="empty-state">
      <ion-icon name="cash" color="medium"></ion-icon>
      <h3>No Payslips</h3>
      <p>Generate payroll to create payslips.</p>
    </div>
  </div>

  <!-- Salary Structures Tab -->
  <div *ngIf="selectedSegment === 'structures'">
    <!-- Add Button -->
    <div class="fab-container">
      <ion-button (click)="openSalaryStructureModal()" color="primary">
        <ion-icon name="add-circle" slot="start"></ion-icon>
        Add Salary Structure
      </ion-button>
    </div>

    <!-- Employees List -->
    <ion-card *ngFor="let employee of employees">
      <ion-card-content>
        <div class="employee-card">
          <div class="employee-info">
            <ion-avatar>
              <img [src]="'assets/images/default-avatar.png'" alt="Employee">
            </ion-avatar>
            <div>
              <h3>{{ employee.FirstName }} {{ employee.LastName }}</h3>
              <p>{{ employee.Designation }}</p>
            </div>
          </div>
          <ion-button fill="outline" size="small" (click)="openSalaryStructureModal(employee)">
            <ion-icon name="create" slot="start"></ion-icon>
            Setup Salary
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Empty State -->
    <div *ngIf="!loading && employees.length === 0" class="empty-state">
      <ion-icon name="people" color="medium"></ion-icon>
      <h3>No Employees</h3>
      <p>Add employees to setup salary structures.</p>
    </div>
  </div>

  <!-- Salary Structure Modal -->
  <ion-modal [isOpen]="showSalaryModal" (didDismiss)="showSalaryModal = false">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Salary Structure</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="showSalaryModal = false">Close</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <ion-list>
          <ion-item *ngIf="!salaryForm.employee_id">
            <ion-select [(ngModel)]="salaryForm.employee_id" label="Employee" label-placement="stacked">
              <ion-select-option *ngFor="let emp of employees" [value]="emp.id">
                {{ emp.FirstName }} {{ emp.LastName }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item-divider>
            <ion-label>Earnings</ion-label>
          </ion-item-divider>

          <ion-item>
            <ion-input 
              [(ngModel)]="salaryForm.basic" 
              type="number" 
              label="Basic Salary"
              label-placement="stacked"
              (ionChange)="calculateSalary()">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-input 
              [(ngModel)]="salaryForm.hra" 
              type="number" 
              label="HRA"
              label-placement="stacked"
              (ionChange)="calculateSalary()">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-input 
              [(ngModel)]="salaryForm.conveyance" 
              type="number" 
              label="Conveyance"
              label-placement="stacked"
              (ionChange)="calculateSalary()">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-input 
              [(ngModel)]="salaryForm.special_allowance" 
              type="number" 
              label="Special Allowance"
              label-placement="stacked"
              (ionChange)="calculateSalary()">
            </ion-input>
          </ion-item>

          <ion-item-divider>
            <ion-label>Deductions</ion-label>
          </ion-item-divider>

          <ion-item>
            <ion-input 
              [(ngModel)]="salaryForm.pf" 
              type="number" 
              label="PF"
              label-placement="stacked"
              (ionChange)="calculateSalary()">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-input 
              [(ngModel)]="salaryForm.esi" 
              type="number" 
              label="ESI"
              label-placement="stacked"
              (ionChange)="calculateSalary()">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-input 
              [(ngModel)]="salaryForm.professional_tax" 
              type="number" 
              label="Professional Tax"
              label-placement="stacked"
              (ionChange)="calculateSalary()">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-input 
              [(ngModel)]="salaryForm.other_deductions" 
              type="number" 
              label="Other Deductions"
              label-placement="stacked"
              (ionChange)="calculateSalary()">
            </ion-input>
          </ion-item>

          <ion-item-divider>
            <ion-label>Summary</ion-label>
          </ion-item-divider>

          <ion-item>
            <ion-label>
              <h2>Gross Salary</h2>
              <h3 class="salary-amount">₹{{ salaryForm.gross_salary | number:'1.2-2' }}</h3>
            </ion-label>
          </ion-item>

          <ion-item>
            <ion-label>
              <h2>Net Salary</h2>
              <h3 class="salary-amount salary-net">₹{{ salaryForm.net_salary | number:'1.2-2' }}</h3>
            </ion-label>
          </ion-item>
        </ion-list>

        <div class="modal-footer">
          <ion-button expand="block" (click)="saveSalaryStructure()">
            <ion-icon name="checkmark-circle" slot="start"></ion-icon>
            Save Salary Structure
          </ion-button>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
