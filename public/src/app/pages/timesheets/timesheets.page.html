<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/home"></ion-back-button>
    </ion-buttons>
    <ion-title>My Timesheets</ion-title>
    <ion-buttons slot="end" *ngIf="hasProjectAssignment">
      <ion-button (click)="openUploadModal()">
        <ion-icon name="cloud-upload-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  
  <ion-toolbar>
    <ion-segment [(ngModel)]="selectedStatus" (ionChange)="segmentChanged($event)">
      <ion-segment-button value="all">
        <ion-label>All</ion-label>
      </ion-segment-button>
      <ion-segment-button value="pending">
        <ion-label>Pending</ion-label>
      </ion-segment-button>
      <ion-segment-button value="approved">
        <ion-label>Approved</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Assignment Status Card -->
  <ion-card *ngIf="hasProjectAssignment" class="info-card">
    <ion-card-content>
      <ion-icon name="checkmark-outline" color="success"></ion-icon>
      <span>You are assigned to projects - submit project timesheets</span>
    </ion-card-content>
  </ion-card>

  <!-- Timesheets List -->
  <div *ngIf="!isLoading && timesheets.length > 0">
    <ion-card *ngFor="let timesheet of timesheets" class="timesheet-card">
      <ion-card-content>
        <div class="timesheet-header">
          <div>
            <h3>{{formatDate($any(timesheet).date || timesheet.timesheet_date)}}</h3>
            <!-- Show project info for project timesheets -->
            <p class="project-info" *ngIf="$any(timesheet).timesheet_source === 'project' && $any(timesheet).project_name">
              <ion-icon name="briefcase-outline"></ion-icon>
              {{$any(timesheet).project_name}} - {{$any(timesheet).client_name}}
            </p>
            <p class="work-mode" *ngIf="$any(timesheet).hours_breakdown?.work_mode">
              <ion-badge color="medium" style="font-size: 11px;">
                {{$any(timesheet).timesheet_source === 'project' ? 'Project' : 'Regular'}}
              </ion-badge>
              {{$any(timesheet).hours_breakdown.work_mode}}
            </p>
          </div>
          <ion-badge [color]="getStatusColor(timesheet.status)">
            {{timesheet.status}}
          </ion-badge>
        </div>

        <div class="timesheet-details">
          <div class="detail-row" *ngIf="$any(timesheet).hours_breakdown?.shift_start && $any(timesheet).hours_breakdown?.shift_end">
            <ion-icon name="time-outline"></ion-icon>
            <span>{{$any(timesheet).hours_breakdown.shift_start}} - {{$any(timesheet).hours_breakdown.shift_end}}</span>
          </div>
          <div class="detail-row">
            <ion-icon name="time-outline"></ion-icon>
            <span>Hours Worked: {{$any(timesheet).total_hours || timesheet.actual_hours_worked}}h</span>
          </div>
          <div class="detail-row" *ngIf="$any(timesheet).hours_breakdown?.regular_hours">
            <ion-icon name="checkmark-outline"></ion-icon>
            <span>Regular: {{$any(timesheet).hours_breakdown.regular_hours}}h</span>
          </div>
        </div>

        <!-- Tasks for both regular and project timesheets -->
        <div class="tasks-section" *ngIf="$any(timesheet).hours_breakdown?.tasks || $any(timesheet).work_description">
          <strong>Tasks/Work Description:</strong>
          <p>{{$any(timesheet).hours_breakdown?.tasks || $any(timesheet).work_description}}</p>
        </div>

        <div class="challenges-section" *ngIf="$any(timesheet).notes">
          <strong>Notes:</strong>
          <p>{{$any(timesheet).notes}}</p>
        </div>

        <!-- Client Timesheet Status for Project Timesheets -->
        <div class="client-timesheet-status" *ngIf="$any(timesheet).timesheet_source === 'project'">
          <div class="status-row">
            <ion-icon name="document-text-outline"></ion-icon>
            <span>Client Timesheet: </span>
            <ion-badge [color]="getClientTimesheetStatusColor($any(timesheet).client_timesheet_status || 'not_uploaded')">
              {{getClientTimesheetStatusLabel($any(timesheet).client_timesheet_status || 'not_uploaded')}}
            </ion-badge>
          </div>
          <div class="upload-date" *ngIf="$any(timesheet).client_timesheet_upload_date">
            <small>Uploaded: {{formatDate($any(timesheet).client_timesheet_upload_date)}}</small>
          </div>
        </div>

        <div class="submission-time" *ngIf="$any(timesheet).submission_date">
          <ion-icon name="calendar-outline"></ion-icon>
          <span>Submitted: {{formatDate($any(timesheet).submission_date)}}</span>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Empty State -->
  <ion-card *ngIf="!isLoading && timesheets.length === 0">
    <ion-card-content class="empty-state">
      <ion-icon name="time-outline" size="large"></ion-icon>
      <h3>No Timesheets</h3>
      <p>You haven't submitted any timesheets yet</p>
      <ion-button (click)="openSubmitModal()">
        <ion-icon name="add-outline" slot="start"></ion-icon>
        Submit Timesheet
      </ion-button>
    </ion-card-content>
  </ion-card>

  <!-- FAB Button -->
  <ion-fab slot="fixed" vertical="bottom" horizontal="end">
    <ion-fab-button (click)="openSubmitModal()">
      <ion-icon name="add-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- Submit Timesheet Modal -->
  <ion-modal [isOpen]="showSubmitModal" (didDismiss)="closeSubmitModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Submit Timesheet</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeSubmitModal()">Close</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content>
        <div class="modal-content">
          <ion-list>
            <ion-item>
              <ion-label position="stacked">Date</ion-label>
              <ion-input type="date" [(ngModel)]="newTimesheet.timesheet_date"></ion-input>
            </ion-item>

            <!-- Project Selector (Only for project-assigned employees) -->
            <ion-item *ngIf="hasProjectAssignment && projectAssignments.length > 0">
              <ion-label position="stacked">Project *</ion-label>
              <ion-select [(ngModel)]="newTimesheet.project_id" placeholder="Select Project">
                <ion-select-option *ngFor="let project of projectAssignments" [value]="project.project_id">
                  {{project.project_name}} - {{project.client_name}}
                </ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Work Mode</ion-label>
              <ion-select [(ngModel)]="newTimesheet.work_mode">
                <ion-select-option value="Office">Office</ion-select-option>
                <ion-select-option value="WFH">Work From Home</ion-select-option>
                <ion-select-option value="Remote">Remote</ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Shift Start Time</ion-label>
              <ion-input type="time" [(ngModel)]="newTimesheet.shift_start_time"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Shift End Time</ion-label>
              <ion-input type="time" [(ngModel)]="newTimesheet.shift_end_time"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Hours Worked</ion-label>
              <ion-input type="number" [(ngModel)]="newTimesheet.actual_hours_worked"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Tasks Completed *</ion-label>
              <ion-textarea 
                [(ngModel)]="newTimesheet.tasks_completed"
                rows="4"
                placeholder="Describe what you accomplished today..."></ion-textarea>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Challenges Faced (Optional)</ion-label>
              <ion-textarea 
                [(ngModel)]="newTimesheet.challenges_faced"
                rows="3"
                placeholder="Any issues or blockers..."></ion-textarea>
            </ion-item>
          </ion-list>

          <div class="button-container">
            <ion-button expand="block" (click)="submitTimesheet()">
              Submit Timesheet
            </ion-button>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Client Timesheet Upload Modal -->
  <ion-modal [isOpen]="showUploadModal" (didDismiss)="closeUploadModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Upload Client Timesheet</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeUploadModal()">Close</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content>
        <div class="modal-content">
          <ion-card>
            <ion-card-content>
              <p style="margin-bottom: 16px;">
                <ion-icon name="information-circle-outline" color="primary"></ion-icon>
                Upload the client-approved timesheet document for the selected month and project.
              </p>
            </ion-card-content>
          </ion-card>

          <ion-list>
            <ion-item *ngIf="projectAssignments.length > 0">
              <ion-label position="stacked">Project *</ion-label>
              <ion-select [(ngModel)]="clientTimesheetUpload.project_id" placeholder="Select Project">
                <ion-select-option *ngFor="let project of projectAssignments" [value]="project.project_id">
                  {{project.project_name}} - {{project.client_name}}
                </ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Month *</ion-label>
              <ion-select [(ngModel)]="clientTimesheetUpload.month">
                <ion-select-option [value]="1">January</ion-select-option>
                <ion-select-option [value]="2">February</ion-select-option>
                <ion-select-option [value]="3">March</ion-select-option>
                <ion-select-option [value]="4">April</ion-select-option>
                <ion-select-option [value]="5">May</ion-select-option>
                <ion-select-option [value]="6">June</ion-select-option>
                <ion-select-option [value]="7">July</ion-select-option>
                <ion-select-option [value]="8">August</ion-select-option>
                <ion-select-option [value]="9">September</ion-select-option>
                <ion-select-option [value]="10">October</ion-select-option>
                <ion-select-option [value]="11">November</ion-select-option>
                <ion-select-option [value]="12">December</ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Year *</ion-label>
              <ion-select [(ngModel)]="clientTimesheetUpload.year">
                <ion-select-option [value]="2024">2024</ion-select-option>
                <ion-select-option [value]="2025">2025</ion-select-option>
                <ion-select-option [value]="2026">2026</ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Client Timesheet File *</ion-label>
              <input 
                type="file" 
                (change)="onFileSelected($event)"
                accept=".pdf,.xlsx,.xls,.jpg,.jpeg,.png"
                style="margin-top: 8px;"
              />
              <ion-note *ngIf="selectedFile" color="success" style="margin-top: 8px;">
                <ion-icon name="checkmark-circle-outline"></ion-icon>
                {{selectedFile.name}} ({{(selectedFile.size / 1024).toFixed(2)}} KB)
              </ion-note>
            </ion-item>
          </ion-list>

          <div class="button-container">
            <ion-button expand="block" (click)="uploadClientTimesheet()" [disabled]="!selectedFile">
              <ion-icon name="cloud-upload-outline" slot="start"></ion-icon>
              Upload Client Timesheet
            </ion-button>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
