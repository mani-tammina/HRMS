<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/admin/dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title>Payroll Management</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="loadData()">
        <ion-icon slot="icon-only" name="refresh-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  
  <ion-toolbar>
    <ion-segment [(ngModel)]="segment" (ionChange)="onSegmentChange($event)">
      <ion-segment-button value="defaults">
        <ion-label>Settings</ion-label>
      </ion-segment-button>
      <ion-segment-button value="runs">
        <ion-label>Runs</ion-label>
      </ion-segment-button>
      <ion-segment-button value="slips">
        <ion-label>All Slips</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- PAYROLL DEFAULTS SECTION -->
  <div *ngIf="segment === 'defaults'">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Payroll Defaults</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item>
            <ion-label position="stacked">PF Percentage (%)</ion-label>
            <ion-input 
              type="number" 
              [(ngModel)]="defaults.pf_percent" 
              [readonly]="!isAdmin">
            </ion-input>
          </ion-item>
          
          <ion-item>
            <ion-label position="stacked">ESI Percentage (%)</ion-label>
            <ion-input 
              type="number" 
              [(ngModel)]="defaults.esi_percent" 
              [readonly]="!isAdmin">
            </ion-input>
          </ion-item>
          
          <ion-item>
            <ion-label position="stacked">Professional Tax (Rs)</ion-label>
            <ion-input 
              type="number" 
              [(ngModel)]="defaults.professional_tax" 
              [readonly]="!isAdmin">
            </ion-input>
          </ion-item>
          
          <ion-item>
            <ion-label position="stacked">Variable Pay Percentage (%)</ion-label>
            <ion-input 
              type="number" 
              [(ngModel)]="defaults.variable_pay_percent" 
              [readonly]="!isAdmin">
            </ion-input>
          </ion-item>
        </ion-list>

        <ion-button 
          *ngIf="isAdmin"
          expand="block" 
          (click)="saveDefaults()" 
          class="ion-margin-top">
          <ion-icon name="save-outline" slot="start"></ion-icon>
          Save Defaults
        </ion-button>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- PAYROLL RUNS SECTION -->
  <div *ngIf="segment === 'runs'">
    <!-- Generate Payroll Card -->
    <ion-card *ngIf="isAdmin">
      <ion-card-header>
        <ion-card-title>Generate New Payroll</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label>Month</ion-label>
          <ion-select [(ngModel)]="selectedMonth" interface="popover">
            <ion-select-option *ngFor="let month of months" [value]="month.value">
              {{ month.name }}
            </ion-select-option>
          </ion-select>
        </ion-item>
        
        <ion-item>
          <ion-label>Year</ion-label>
          <ion-select [(ngModel)]="selectedYear" interface="popover">
            <ion-select-option *ngFor="let year of years" [value]="year">
              {{ year }}
            </ion-select-option>
          </ion-select>
        </ion-item>

        <ion-button 
          expand="block" 
          (click)="generatePayroll()" 
          class="ion-margin-top">
          <ion-icon name="play-circle-outline" slot="start"></ion-icon>
          Generate Payroll
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Loading -->
    <div *ngIf="isLoading" class="loading-container">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
      <p>Loading payroll runs...</p>
    </div>

    <!-- Payroll Runs List -->
    <ion-list *ngIf="!isLoading && payrollRuns.length > 0">
      <ion-card *ngFor="let run of payrollRuns">
        <ion-card-header>
          <div class="run-header">
            <div>
              <ion-card-title>{{ getMonthName(run.payroll_month) }} {{ run.payroll_year }}</ion-card-title>
              <p>Run ID: #{{ run.id }}</p>
            </div>
            <ion-badge [color]="getRunStatusColor(run.status)">{{ run.status }}</ion-badge>
          </div>
        </ion-card-header>
        
        <ion-card-content>
          <div class="run-stats">
            <div class="stat-item">
              <span class="label">Employees:</span>
              <span class="value">{{ run.total_employees }}</span>
            </div>
            <div class="stat-item">
              <span class="label">Total Gross:</span>
              <span class="value">Rs {{ run.total_gross | number }}</span>
            </div>
            <div class="stat-item">
              <span class="label">Total Net:</span>
              <span class="value">Rs {{ run.total_net | number }}</span>
            </div>
          </div>
          
          <p class="date-info">Generated: {{ run.generated_at | date }}</p>
        </ion-card-content>
      </ion-card>
    </ion-list>

    <!-- Empty State -->
    <ion-card *ngIf="!isLoading && payrollRuns.length === 0">
      <ion-card-content class="empty-state">
        <ion-icon name="document-text-outline" size="large"></ion-icon>
        <h3>No Payroll Runs</h3>
        <p>No payroll runs found</p>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- ALL SLIPS SECTION -->
  <div *ngIf="segment === 'slips'">
    <!-- Loading -->
    <div *ngIf="isLoading" class="loading-container">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
      <p>Loading salary slips...</p>
    </div>

    <!-- Slips List -->
    <ion-list *ngIf="!isLoading && allSlips.length > 0">
      <ion-card *ngFor="let slip of allSlips">
        <ion-card-header>
          <div class="slip-header">
            <div>
              <ion-card-title>{{ slip.employee_name }}</ion-card-title>
              <p>{{ slip.employee_code }} - {{ getMonthName(slip.month) }} {{ slip.year }}</p>
            </div>
            <ion-badge [color]="getRunStatusColor(slip.status)">{{ slip.status }}</ion-badge>
          </div>
        </ion-card-header>
        
        <ion-card-content>
          <div class="salary-details">
            <div class="salary-row">
              <span class="label">Gross:</span>
              <span class="value">Rs {{ slip.gross_salary | number }}</span>
            </div>
            <div class="salary-row">
              <span class="label">Deductions:</span>
              <span class="value deduction">-Rs {{ slip.total_deductions | number }}</span>
            </div>
            <div class="salary-row net">
              <span class="label"><strong>Net:</strong></span>
              <span class="value"><strong>Rs {{ slip.net_salary | number }}</strong></span>
            </div>
          </div>
        </ion-card-content>
      </ion-card>
    </ion-list>

    <!-- Empty State -->
    <ion-card *ngIf="!isLoading && allSlips.length === 0">
      <ion-card-content class="empty-state">
        <ion-icon name="document-text-outline" size="large"></ion-icon>
        <h3>No Salary Slips</h3>
        <p>No salary slips found</p>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
